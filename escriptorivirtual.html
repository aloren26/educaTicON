<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escriptori Digital Docent</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fonts -->
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@700,900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;700&family=Patrick+Hand&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* APLICACIÓ GLOBAL DE SATOSHI BOLD */
        body {
            font-family: 'Satoshi', sans-serif;
            font-weight: 700;
            background-color: #333;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            transition: background-image 0.5s ease-in-out;
            overflow: hidden;
        }

        input, textarea, button, select, h1, h2, h3, span, div, p, li {
            font-family: inherit;
        }

        /* Fonts alternatives per widgets específics */
        .font-hand { font-family: 'Patrick Hand', cursive; font-weight: 400; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        .font-serif { font-family: 'Merriweather', serif; }

        /* Glassmorphism */
        .glass-base {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .glass-dark {
            background: rgba(30, 41, 59, 0.90);
            backdrop-filter: blur(16px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Widgets Basics */
        .widget {
            position: absolute;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 200px; 
            min-height: 150px;
            resize: both;
            transition: background-color 0.3s ease, box-shadow 0.3s ease, color 0.3s ease; 
        }
        .widget::-webkit-resizer {
            background-color: transparent;
            background-image: linear-gradient(135deg, transparent 50%, rgba(0,0,0,0.2) 50%);
            background-size: 12px 12px;
            background-repeat: no-repeat;
            background-position: bottom right;
        }
        .widget-header { cursor: grab; user-select: none; }
        .widget-header:active { cursor: grabbing; }
        .hidden-widget { display: none !important; }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }
        ::-webkit-scrollbar-corner { background: transparent; }

        /* Colors Palette */
        .color-dot {
            width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
            border: 2px solid rgba(255,255,255,0.8); transition: transform 0.1s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .color-dot:hover { transform: scale(1.2); z-index: 10; }

        /* Animations */
        @keyframes shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(15deg); }
            50% { transform: rotate(-15deg); }
            75% { transform: rotate(5deg); }
            100% { transform: rotate(0deg); }
        }
        .animate-shake { animation: shake 0.5s ease-in-out; }

        /* Dock Menu */
        .dock-category { position: relative; }
        .dock-category:hover .dock-submenu { display: flex; animation: fadeInUp 0.2s ease-out; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px) translateX(-50%); }
            to { opacity: 1; transform: translateY(0) translateX(-50%); }
        }
        .dock-submenu {
            bottom: 100%; left: 50%; transform: translateX(-50%);
            margin-bottom: 15px; padding-bottom: 10px;
        }
        .dock-submenu::after {
            content: ''; position: absolute; bottom: -20px; left: 0;
            width: 100%; height: 30px; background: transparent; z-index: -1;
        }

        /* Clock Face */
        .clock-face {
            background: rgba(255, 255, 255, 0.95); border: 6px solid #334155;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.1), 0 10px 25px rgba(0,0,0,0.2);
        }
        .clock-hand {
            position: absolute; bottom: 50%; left: 50%;
            transform-origin: bottom center; border-radius: 999px; z-index: 10;
        }
        
        /* Modal Info Styles */
        .advantage-card {
            background: rgba(255,255,255,0.6);
            border-radius: 12px;
            padding: 10px;
            border-left: 4px solid #4f46e5;
        }

        /* Icon Picker Styles */
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            max-height: 300px;
            overflow-y: auto;
        }
        .icon-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 6px; border-radius: 8px; background: rgba(255,255,255,0.5); cursor: pointer; transition: all 0.2s;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .icon-btn:hover { background: rgba(255,255,255,0.9); transform: scale(1.05); border-color: #6366f1; }
        .icon-btn i { font-size: 1.2rem; margin-bottom: 2px; color: #334155; }
        .icon-btn span { font-size: 0.55rem; text-transform: uppercase; font-weight: 900; color: #64748b; text-align: center; line-height: 1; }
        
        .icon-category-title {
            grid-column: 1 / -1;
            font-size: 0.65rem;
            text-transform: uppercase;
            color: #6366f1;
            margin-top: 8px;
            margin-bottom: 2px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 2px;
        }
        
        /* Language Switcher */
        .lang-btn {
            font-size: 0.7rem; font-weight: 900; opacity: 0.7; transition: opacity 0.2s;
        }
        .lang-btn:hover, .lang-btn.active { opacity: 1; text-decoration: underline; color: #4f46e5; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col text-slate-800 relative">

    <!-- TOP RIGHT CONTROLS -->
    <div class="fixed top-4 right-4 z-50 flex gap-2 items-center">
        <!-- LANG SWITCHER -->
        <div class="glass-base bg-white/75 p-3 rounded-full flex gap-2 mr-2">
            <button onclick="setLanguage('ca')" class="lang-btn" id="lang-ca">CAT</button>
            <span class="text-slate-300 text-xs">|</span>
            <button onclick="setLanguage('es')" class="lang-btn" id="lang-es">CAST</button>
            <span class="text-slate-300 text-xs">|</span>
            <button onclick="setLanguage('en')" class="lang-btn" id="lang-en">ENG</button>
        </div>

        <button id="btn-bg-change" onclick="cycleBackground()" class="glass-base bg-white/75 p-3 rounded-full hover:bg-white transition relative" title="Canviar Fons">
            <i class="fas fa-image" id="icon-bg-change"></i>
            <i class="fas fa-spinner fa-spin absolute inset-0 m-auto hidden text-indigo-600" id="spinner-bg-change" style="line-height: 48px;"></i>
        </button>
        <button onclick="toggleFullScreen()" class="glass-base bg-white/75 p-3 rounded-full hover:bg-white transition" title="Pantalla Completa"><i class="fas fa-expand"></i></button>
        <button onclick="toggleConfig()" class="glass-base bg-white/75 p-3 rounded-full hover:bg-white transition" title="Configuració"><i class="fas fa-cog"></i></button>
    </div>

    <!-- MAIN APP CONTAINER -->
    <main id="app-container" class="w-full h-full relative pt-10">
        
        <!-- === WIDGETS === -->

        <!-- 1. CLOCK -->
        <div id="widget-clock" class="widget glass-base hidden-widget group rounded-3xl" style="top: 150px; left: 50px; width: 300px; height: 180px;">
            <div class="widget-header absolute inset-x-0 top-0 h-10 flex justify-end items-center px-2 opacity-0 group-hover:opacity-100 transition z-20 gap-2">
                <button onclick="toggleColorMenu('clock')" class="text-slate-400 hover:text-indigo-600 bg-white/50 p-1 rounded-full w-8 h-8"><i class="fas fa-palette"></i></button>
                <button onclick="closeWidget('clock')" class="text-slate-400 hover:text-red-500 bg-white/50 p-1 rounded-full w-8 h-8"><i class="fas fa-times"></i></button>
            </div>
            <div id="colors-clock" class="hidden absolute top-10 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex flex-col items-center justify-center h-full w-full pointer-events-none"> 
                <div id="clock-time" class="text-6xl font-black tracking-tighter select-none">00:00</div>
                <div id="clock-date" class="text-lg opacity-80 mt-2 uppercase tracking-widest font-black select-none text-center">Data</div>
            </div>
        </div>

        <!-- 2. ANALOG CLOCK -->
        <div id="widget-analog" class="widget glass-base hidden-widget group rounded-3xl" style="top: 150px; left: 360px; width: 280px; height: 320px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70" data-i18n="analog_title"><i class="far fa-clock mr-2"></i>Analògic</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('analog')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('analog')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-analog" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex-grow flex items-center justify-center p-4">
                <div class="clock-face relative w-48 h-48 rounded-full">
                     <div class="absolute inset-0 flex items-center justify-center font-black text-slate-500 text-sm">
                        <span class="absolute" style="transform: rotate(30deg) translateY(-80px) rotate(-30deg);">1</span>
                        <span class="absolute" style="transform: rotate(60deg) translateY(-80px) rotate(-60deg);">2</span>
                        <span class="absolute" style="transform: rotate(90deg) translateY(-80px) rotate(-90deg);">3</span>
                        <span class="absolute" style="transform: rotate(120deg) translateY(-80px) rotate(-120deg);">4</span>
                        <span class="absolute" style="transform: rotate(150deg) translateY(-80px) rotate(-150deg);">5</span>
                        <span class="absolute" style="transform: rotate(180deg) translateY(-80px) rotate(-180deg);">6</span>
                        <span class="absolute" style="transform: rotate(210deg) translateY(-80px) rotate(-210deg);">7</span>
                        <span class="absolute" style="transform: rotate(240deg) translateY(-80px) rotate(-240deg);">8</span>
                        <span class="absolute" style="transform: rotate(270deg) translateY(-80px) rotate(-270deg);">9</span>
                        <span class="absolute" style="transform: rotate(300deg) translateY(-80px) rotate(-300deg);">10</span>
                        <span class="absolute" style="transform: rotate(330deg) translateY(-80px) rotate(-330deg);">11</span>
                        <span class="absolute" style="transform: rotate(0deg) translateY(-80px) rotate(0deg);">12</span>
                    </div>
                    <div id="hand-hour" class="clock-hand w-2 h-12 bg-slate-800 rounded-full" style="margin-left: -4px;"></div>
                    <div id="hand-minute" class="clock-hand w-1.5 h-16 bg-slate-600 rounded-full" style="margin-left: -3px;"></div>
                    <div id="hand-second" class="clock-hand w-0.5 h-20 bg-red-500 rounded-full" style="margin-left: -1px;"></div>
                    <div class="absolute inset-0 m-auto w-4 h-4 bg-slate-800 rounded-full z-20 border-2 border-white"></div>
                </div>
            </div>
        </div>

        <!-- 3. TRAFFIC LIGHT -->
        <div id="widget-traffic" class="widget glass-base hidden-widget group rounded-3xl" style="top: 150px; left: 400px; width: 140px; height: 320px;">
            <div class="widget-header w-full p-2 flex justify-between items-center bg-white/20">
                <i class="fas fa-traffic-light opacity-70 ml-2"></i>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('traffic')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('traffic')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-traffic" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex-grow flex items-center justify-center p-4">
                <div class="bg-slate-800 p-4 rounded-full flex flex-col gap-4 shadow-inner">
                    <div id="light-red" onclick="setTrafficLight('red')" class="w-12 h-12 rounded-full bg-red-500 opacity-30 cursor-pointer hover:opacity-100 transition shadow-[0_0_20px_rgba(239,68,68,0.5)]"></div>
                    <div id="light-yellow" onclick="setTrafficLight('yellow')" class="w-12 h-12 rounded-full bg-yellow-400 opacity-30 cursor-pointer hover:opacity-100 transition shadow-[0_0_20px_rgba(250,204,21,0.5)]"></div>
                    <div id="light-green" onclick="setTrafficLight('green')" class="w-12 h-12 rounded-full bg-green-500 opacity-30 cursor-pointer hover:opacity-100 transition shadow-[0_0_20px_rgba(34,197,94,0.5)]"></div>
                </div>
            </div>
        </div>

        <!-- 4. NOTES -->
        <div id="widget-notes" class="widget glass-base hidden-widget group rounded-3xl" style="top: 400px; left: 50px; width: 300px; height: 300px;">
            <div class="widget-header px-4 py-2 flex justify-between items-center cursor-move bg-white/20 rounded-t-3xl">
                <span class="text-xs font-black uppercase opacity-70" data-i18n="notes_title"><i class="fas fa-sticky-note mr-2"></i>Notes</span>
                <div class="flex items-center gap-2">
                    <button onclick="toggleColorMenu('notes')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('notes')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-notes" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <textarea id="notes-area" class="w-full h-full bg-transparent p-4 rounded-b-3xl resize-none focus:outline-none font-bold text-lg placeholder-black/30" placeholder="Escriu notes..."></textarea>
        </div>

        <!-- 5. TIMER -->
        <div id="widget-timer" class="widget glass-base hidden-widget group rounded-3xl" style="top: 400px; left: 400px; width: 300px; height: 260px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70 tracking-wider" data-i18n="timer_title"><i class="fas fa-hourglass-half mr-2"></i>Temporitzador</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('timer')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('timer')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-timer" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex-grow flex flex-col items-center justify-center p-4">
                <div id="timer-display" class="text-6xl font-black mb-4 tracking-wider font-mono">05:00</div>
                <div class="flex gap-4 mb-4">
                    <button onclick="toggleTimer()" id="timer-btn-toggle" class="bg-indigo-600 text-white w-14 h-14 rounded-full flex items-center justify-center hover:bg-indigo-700 shadow-lg transition text-xl"><i class="fas fa-play" id="timer-icon-toggle"></i></button>
                    <button onclick="resetTimer()" class="bg-slate-200 text-slate-600 w-14 h-14 rounded-full flex items-center justify-center hover:bg-slate-300 shadow transition text-xl"><i class="fas fa-redo"></i></button>
                </div>
                <div class="flex items-center justify-center gap-8 opacity-80 mb-2">
                    <button onclick="adjustTimer(-1)" class="w-10 h-10 rounded-full bg-white/30 hover:bg-white/60 flex items-center justify-center transition text-lg font-bold"><i class="fas fa-chevron-down"></i></button>
                    <button onclick="adjustTimer(1)" class="w-10 h-10 rounded-full bg-white/30 hover:bg-white/60 flex items-center justify-center transition text-lg font-bold"><i class="fas fa-chevron-up"></i></button>
                </div>
            </div>
        </div>

        <!-- 6. STUDENT PICKER -->
        <div id="widget-picker" class="widget glass-base hidden-widget group rounded-3xl" style="top: 150px; left: 700px; width: 300px; height: 250px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70" data-i18n="picker_title"><i class="fas fa-dice mr-2"></i>Selector</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('picker')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('picker')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-picker" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex flex-col p-4 h-full relative">
                <div id="picker-result" class="flex-grow flex items-center justify-center text-3xl font-black text-indigo-600 text-center mb-2 leading-tight bg-white/40 rounded-xl m-2" data-i18n="who_will_be">Qui serà?</div>
                <div class="flex gap-2 mt-auto z-10">
                    <button onclick="pickRandomStudent()" class="flex-1 bg-indigo-600 text-white py-2 rounded-xl hover:bg-indigo-700 shadow-lg font-bold uppercase tracking-wide" data-i18n="pick">Triar</button>
                    <button onclick="toggleAttendanceView()" class="bg-blue-200 text-blue-700 px-3 rounded-xl hover:bg-blue-300" title="Assistència"><i class="fas fa-user-check"></i></button>
                    <button onclick="togglePickerSettings()" class="bg-slate-200 text-slate-600 px-3 rounded-xl hover:bg-slate-300" title="Editar Llista"><i class="fas fa-list"></i></button>
                </div>
                <div id="picker-settings" class="hidden absolute inset-0 bg-white/95 z-20 p-4 flex flex-col rounded-3xl text-slate-800">
                    <label class="text-xs text-slate-500 mb-1 font-bold" data-i18n="list_label">Noms (un per línia):</label>
                    <textarea id="student-list" class="flex-grow bg-slate-50 border rounded p-2 text-sm focus:outline-none font-bold placeholder-slate-300"></textarea>
                    <button onclick="togglePickerSettings()" class="mt-2 bg-slate-200 text-xs py-2 rounded font-bold hover:bg-slate-300" data-i18n="close">Tancar</button>
                </div>
                <div id="picker-checklist" class="hidden absolute inset-0 bg-white/95 z-20 p-4 flex flex-col rounded-3xl text-slate-800">
                    <div class="flex justify-between items-center mb-2 border-b pb-2">
                        <span class="text-xs font-bold text-slate-500" data-i18n="who_is_here">Qui hi és avui?</span>
                        <button onclick="selectAllAttendance(true)" class="text-[10px] text-indigo-600 font-bold uppercase" data-i18n="all">Tots</button>
                    </div>
                    <div id="checklist-container" class="flex-grow overflow-y-auto content-start grid grid-cols-2 gap-2"></div>
                    <button onclick="toggleAttendanceView()" class="mt-2 bg-indigo-600 text-white text-xs py-2 rounded font-bold hover:bg-indigo-700" data-i18n="done">Fet</button>
                </div>
            </div>
        </div>

        <!-- 7. GROUP GENERATOR -->
        <div id="widget-groups" class="widget glass-base hidden-widget group rounded-3xl" style="top: 150px; left: 100px; width: 400px; height: 400px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70" data-i18n="groups_title"><i class="fas fa-users mr-2"></i>Equips</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('groups')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('groups')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-groups" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex flex-col p-4 h-full overflow-hidden">
                <div class="flex gap-2 items-center mb-4 bg-white/40 p-2 rounded-lg">
                    <label class="text-xs font-bold opacity-70 uppercase" data-i18n="groups_label">Grups:</label>
                    <input type="number" id="group-count" value="4" min="2" max="10" class="w-12 p-1 text-center rounded border border-slate-300 font-bold text-slate-800">
                    <button onclick="generateGroups()" class="flex-1 bg-teal-500 text-white py-1 px-3 rounded hover:bg-teal-600 transition font-bold text-sm uppercase" data-i18n="generate">Generar</button>
                </div>
                <div id="groups-result" class="flex-grow overflow-y-auto grid grid-cols-2 gap-2 content-start">
                    <div class="col-span-2 text-center opacity-60 text-sm mt-10 font-bold" data-i18n="groups_help">Indica quants grups i clica "Generar".</div>
                </div>
            </div>
        </div>

        <!-- 8. TIMETABLE -->
        <div id="widget-timetable" class="widget glass-base hidden-widget group flex flex-col rounded-3xl" style="top: 150px; left: 50%; width: 450px; height: 500px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl cursor-move">
                <div class="flex items-center gap-2">
                    <i class="far fa-calendar-alt opacity-70"></i>
                    <h3 id="timetable-title" contenteditable="true" class="text-xs font-black uppercase opacity-70 border-b border-transparent hover:border-white/50" data-i18n="timetable_title">Horari</h3>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="toggleIconPicker()" class="opacity-70 hover:opacity-100" title="Icones"><i class="fas fa-tag"></i></button>
                    <button onclick="toggleColorMenu('timetable')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('timetable')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            
            <!-- EXPANDED ICON PICKER -->
            <div id="timetable-icons" class="hidden absolute top-10 left-2 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 border border-slate-200">
                <div class="icon-grid" id="icon-picker-content">
                    <!-- JS populated for translation -->
                </div>
                <div class="mt-2 text-[10px] text-center text-slate-400 font-bold border-t pt-1" data-i18n="icon_help">Clica una icona per inserir-la</div>
            </div>

            <div id="colors-timetable" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex-grow overflow-auto p-4">
                <table class="w-full text-left border-collapse editable-table">
                    <thead>
                        <tr class="text-sm opacity-70 border-b border-black/10">
                            <th class="p-2 w-24 font-black uppercase text-xs" data-i18n="time_col">Hora</th>
                            <th class="p-2 font-black uppercase text-xs" data-i18n="activity_col">Activitat</th>
                        </tr>
                    </thead>
                    <tbody id="timetable-body" class="font-bold text-lg"></tbody>
                </table>
            </div>
        </div>

        <!-- 9. NOISE METER -->
        <div id="widget-noise" class="widget glass-base hidden-widget group rounded-3xl" style="top: 200px; left: 200px; width: 200px; height: 350px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70" data-i18n="noise_title"><i class="fas fa-microphone-lines mr-2"></i>Soroll</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('noise')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('noise')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-noise" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex flex-col items-center justify-center p-4 h-full gap-4">
                <div class="relative w-12 h-48 bg-slate-200/50 rounded-full overflow-hidden border border-white/50 shadow-inner">
                    <div id="noise-level-bar" class="absolute bottom-0 w-full bg-green-400 transition-all duration-100 ease-out" style="height: 0%;"></div>
                </div>
                <button id="btn-mic-toggle" onclick="toggleMicrophone()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl shadow font-bold text-sm hover:bg-indigo-700 transition w-full uppercase tracking-wider">
                    <i class="fas fa-microphone mr-2"></i><span data-i18n="activate">Activar</span>
                </button>
            </div>
        </div>

        <!-- 10. TODO LIST -->
        <div id="widget-todo" class="widget glass-base hidden-widget group rounded-3xl" style="top: 250px; left: 600px; width: 300px; height: 400px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70" data-i18n="todo_title"><i class="fas fa-list-check mr-2"></i>Tasques</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('todo')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('todo')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-todo" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex flex-col p-4 h-full">
                <div class="flex gap-2 mb-4">
                    <input type="text" id="todo-input" placeholder="Nova tasca..." class="flex-1 bg-white/50 border-none rounded-lg px-3 py-2 text-sm font-bold focus:ring-2 focus:ring-indigo-400 placeholder-black/30 text-slate-800" onkeypress="if(event.key === 'Enter') addTodo()">
                    <button onclick="addTodo()" class="bg-indigo-600 text-white w-10 h-10 rounded-lg shadow hover:bg-indigo-700 font-bold text-lg flex items-center justify-center transition">+</button>
                </div>
                <div id="todo-list" class="flex-grow overflow-y-auto space-y-2 pr-1"></div>
            </div>
        </div>

        <!-- 11. QR CODE GENERATOR -->
        <div id="widget-qr" class="widget glass-base hidden-widget group rounded-3xl" style="top: 200px; left: 100px; width: 280px; height: 380px;">
             <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70" data-i18n="qr_title"><i class="fas fa-qrcode mr-2"></i>Codi QR</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('qr')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('qr')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-qr" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex flex-col items-center p-4 gap-4 h-full">
                <div id="qrcode" class="bg-white p-2 rounded-xl shadow-inner w-[200px] h-[200px] flex items-center justify-center">
                    <span class="text-slate-300 text-xs font-bold text-center" data-i18n="qr_help">Introdueix URL i genera</span>
                </div>
                <input type="text" id="qr-input" placeholder="https://..." class="w-full bg-white/50 border-none rounded-lg px-3 py-2 text-sm font-bold focus:ring-2 focus:ring-indigo-400 text-slate-800">
                <button onclick="generateQR()" class="w-full bg-slate-800 text-white py-2 rounded-lg font-bold hover:bg-black transition uppercase text-xs tracking-wider" data-i18n="generate_code">Generar Codi</button>
            </div>
        </div>

        <!-- 12. DAUS 3D -->
        <div id="widget-dice" class="widget glass-base hidden-widget group rounded-3xl" style="top: 300px; left: 500px; width: 300px; height: 250px;">
             <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70" data-i18n="dice_title"><i class="fas fa-cubes mr-2"></i>Daus</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('dice')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('dice')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-dice" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex flex-col items-center justify-center p-4 h-full gap-4">
                <div id="dice-container" class="flex justify-center gap-4 text-6xl opacity-80 h-20 items-center">
                    <i class="fas fa-dice-one"></i>
                </div>
                <div class="flex gap-2">
                    <button onclick="setDiceCount(1)" class="w-8 h-8 rounded bg-white/40 hover:bg-white font-bold text-sm text-slate-800">1</button>
                    <button onclick="setDiceCount(2)" class="w-8 h-8 rounded bg-white/40 hover:bg-white font-bold text-sm text-slate-800">2</button>
                    <button onclick="setDiceCount(3)" class="w-8 h-8 rounded bg-white/40 hover:bg-white font-bold text-sm text-slate-800">3</button>
                </div>
                <button onclick="rollDice()" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700 transition uppercase text-xs tracking-wider" data-i18n="roll">Llançar</button>
            </div>
        </div>

        <!-- 13. SÍMBOLS DE TREBALL -->
        <div id="widget-symbols" class="widget glass-base hidden-widget group rounded-3xl" style="top: 250px; left: 300px; width: 320px; height: 320px;">
             <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70" data-i18n="symbols_title"><i class="fas fa-eye mr-2"></i>Mode de Treball</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('symbols')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('symbols')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-symbols" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex flex-col items-center justify-center p-6 h-full gap-6">
                <div id="symbol-display" class="flex flex-col items-center gap-2 transition-all duration-300">
                    <i class="fas fa-comment-slash text-8xl opacity-80"></i>
                    <span class="text-2xl font-black uppercase tracking-widest mt-4" id="symbol-text">Silenci</span>
                </div>
                <div class="grid grid-cols-4 gap-2 w-full mt-auto">
                    <button onclick="setSymbol('silence')" class="p-2 rounded-lg bg-red-100 hover:bg-red-200 text-red-600 flex justify-center" title="Silenci"><i class="fas fa-comment-slash"></i></button>
                    <button onclick="setSymbol('whisper')" class="p-2 rounded-lg bg-yellow-100 hover:bg-yellow-200 text-yellow-600 flex justify-center" title="Parelles"><i class="fas fa-user-friends"></i></button>
                    <button onclick="setSymbol('group')" class="p-2 rounded-lg bg-green-100 hover:bg-green-200 text-green-600 flex justify-center" title="Grup"><i class="fas fa-users"></i></button>
                    <button onclick="setSymbol('ask')" class="p-2 rounded-lg bg-blue-100 hover:bg-blue-200 text-blue-600 flex justify-center" title="Pregunta"><i class="fas fa-hand-paper"></i></button>
                </div>
            </div>
        </div>

        <!-- 14. QUICK LINKS -->
        <div id="widget-links" class="widget glass-base hidden-widget group rounded-3xl" style="top: 150px; left: 800px; width: 300px; height: 350px;">
             <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70" data-i18n="links_title"><i class="fas fa-link mr-2"></i>Enllaços</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('links')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('links')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-links" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex flex-col p-4 h-full">
                <div id="links-container" class="grid grid-cols-3 gap-3 flex-grow content-start"></div>
                <button onclick="addNewLink()" class="mt-4 w-full bg-slate-200 text-slate-600 py-2 rounded-lg font-bold hover:bg-slate-300 transition text-sm" data-i18n="add_web"><i class="fas fa-plus mr-2"></i>Afegir Web</button>
            </div>
        </div>

    </main>

    <!-- CREDITS -->
    <div class="fixed bottom-2 right-4 z-0 text-right pointer-events-none select-none text-white/50 font-bold">
        <div class="text-[10px]" data-i18n="credits_name">Creat per Alfonso LM</div>
    </div>

    <!-- DOCK INFERIOR CATEGORITZAT v5.2 -->
    <div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-40">
        <div class="glass-dark rounded-full px-4 py-2 flex gap-4 shadow-2xl items-center scale-90 md:scale-95 transition-transform hover:scale-100">
            
            <!-- CATEGORIA: TEMPS -->
            <div class="relative group dock-category">
                <button class="flex flex-col items-center text-slate-300 group-hover:text-white transition gap-1">
                    <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg group-hover:-translate-y-1 transition duration-300 border border-white/10">
                        <i class="fas fa-clock text-xl"></i>
                    </div>
                    <span class="text-[9px] font-black tracking-widest uppercase" data-i18n="menu_time">Temps</span>
                </button>
                <div class="dock-submenu absolute hidden bg-white/95 backdrop-blur-md rounded-2xl p-2 shadow-xl flex-col gap-1 min-w-[150px]">
                    <button onclick="toggleWidget('clock')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-blue-100 transition text-slate-800 text-left font-bold text-xs"><i class="far fa-clock w-5 text-center text-blue-600"></i><span data-i18n="menu_digital">Digital</span></button>
                    <button onclick="toggleWidget('analog')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-cyan-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-clock w-5 text-center text-cyan-600"></i><span data-i18n="menu_analog">Analògic</span></button>
                    <button onclick="toggleWidget('timer')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-orange-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-hourglass-start w-5 text-center text-orange-600"></i><span data-i18n="menu_timer">Temporitzador</span></button>
                </div>
            </div>

            <!-- CATEGORIA: AULA -->
            <div class="relative group dock-category">
                <button class="flex flex-col items-center text-slate-300 group-hover:text-white transition gap-1">
                    <div class="w-10 h-10 bg-purple-600 rounded-xl flex items-center justify-center shadow-lg group-hover:-translate-y-1 transition duration-300 border border-white/10">
                        <i class="fas fa-chalkboard-teacher text-xl"></i>
                    </div>
                    <span class="text-[9px] font-black tracking-widest uppercase" data-i18n="menu_class">Aula</span>
                </button>
                <div class="dock-submenu absolute hidden bg-white/95 backdrop-blur-md rounded-2xl p-2 shadow-xl flex-col gap-1 min-w-[150px]">
                    <button onclick="toggleWidget('picker')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-purple-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-dice w-5 text-center text-purple-600"></i><span data-i18n="menu_picker">Selector</span></button>
                    <button onclick="toggleWidget('groups')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-teal-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-users w-5 text-center text-teal-600"></i><span data-i18n="menu_groups">Grups</span></button>
                    <button onclick="toggleWidget('dice')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-indigo-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-cubes w-5 text-center text-indigo-600"></i><span data-i18n="menu_dice">Daus</span></button>
                    <button onclick="toggleWidget('symbols')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-yellow-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-eye w-5 text-center text-yellow-600"></i><span data-i18n="menu_symbols">Símbols</span></button>
                    <button onclick="toggleWidget('noise')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-pink-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-microphone-lines w-5 text-center text-pink-600"></i><span data-i18n="menu_noise">Sonòmetre</span></button>
                    <button onclick="toggleWidget('traffic')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-rose-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-traffic-light w-5 text-center text-rose-600"></i><span data-i18n="menu_traffic">Semàfor</span></button>
                </div>
            </div>

            <!-- CATEGORIA: EINES -->
            <div class="relative group dock-category">
                <button class="flex flex-col items-center text-slate-300 group-hover:text-white transition gap-1">
                    <div class="w-10 h-10 bg-emerald-600 rounded-xl flex items-center justify-center shadow-lg group-hover:-translate-y-1 transition duration-300 border border-white/10">
                        <i class="fas fa-tools text-xl"></i>
                    </div>
                    <span class="text-[9px] font-black tracking-widest uppercase" data-i18n="menu_tools">Eines</span>
                </button>
                <div class="dock-submenu absolute hidden bg-white/95 backdrop-blur-md rounded-2xl p-2 shadow-xl flex-col gap-1 min-w-[150px]">
                    <button onclick="toggleWidget('timetable')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-indigo-100 transition text-slate-800 text-left font-bold text-xs"><i class="far fa-calendar-alt w-5 text-center text-indigo-600"></i><span data-i18n="menu_timetable">Horari</span></button>
                    <button onclick="toggleWidget('notes')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-yellow-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-sticky-note w-5 text-center text-yellow-600"></i><span data-i18n="menu_notes">Notes</span></button>
                    <button onclick="toggleWidget('todo')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-emerald-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-list-check w-5 text-center text-emerald-600"></i><span data-i18n="menu_todo">Tasques</span></button>
                    <button onclick="toggleWidget('qr')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-gray-200 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-qrcode w-5 text-center text-gray-600"></i><span data-i18n="menu_qr">Codi QR</span></button>
                    <button onclick="toggleWidget('links')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-sky-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-link w-5 text-center text-sky-600"></i><span data-i18n="menu_links">Enllaços</span></button>
                </div>
            </div>

            <!-- BOTÓ INFO -->
            <div class="relative group dock-category">
                <button onclick="toggleInfoModal()" class="flex flex-col items-center text-slate-400 group-hover:text-white transition gap-1">
                    <div class="w-10 h-10 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center shadow-inner group-hover:-translate-y-1 transition duration-300 border border-white/10">
                        <i class="fas fa-question text-xl"></i>
                    </div>
                </button>
            </div>

        </div>
    </div>

    <!-- INFO MODAL (COMPACTE) -->
    <div id="info-modal" class="fixed inset-0 bg-black/60 z-[70] hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-3xl p-6 max-w-4xl w-full shadow-2xl relative overflow-y-auto max-h-[95vh]">
            <button onclick="toggleInfoModal()" class="absolute top-4 right-4 text-slate-400 hover:text-red-500 transition"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-2xl font-black mb-4 text-indigo-700" data-i18n="info_title">Per què aquest Escriptori?</h2>
            
            <div class="grid md:grid-cols-3 gap-3">
                <div class="advantage-card">
                    <h3 class="text-sm font-black text-slate-800 mb-1"><i class="fas fa-piggy-bank text-indigo-600 mr-2"></i><span data-i18n="info_free_t">100% Gratuït</span></h3>
                    <p class="text-xs text-slate-600 leading-tight" data-i18n="info_free_d">Sense subscripcions ni versions "Pro". Totes les eines són gratis per sempre.</p>
                </div>
                <div class="advantage-card">
                    <h3 class="text-sm font-black text-slate-800 mb-1"><i class="fas fa-user-shield text-indigo-600 mr-2"></i><span data-i18n="info_privacy_t">Privacitat Total</span></h3>
                    <p class="text-xs text-slate-600 leading-tight" data-i18n="info_privacy_d">Les dades mai surten del teu ordinador. Compliment automàtic de protecció de dades.</p>
                </div>
                <div class="advantage-card">
                    <h3 class="text-sm font-black text-slate-800 mb-1"><i class="fas fa-bolt text-indigo-600 mr-2"></i><span data-i18n="info_fast_t">Sense Registre</span></h3>
                    <p class="text-xs text-slate-600 leading-tight" data-i18n="info_fast_d">Sense comptes ni contrasenyes. Obre l'arxiu i comença la classe a l'instant.</p>
                </div>
                <div class="advantage-card">
                    <h3 class="text-sm font-black text-slate-800 mb-1"><i class="fas fa-palette text-indigo-600 mr-2"></i><span data-i18n="info_design_t">Disseny Adaptat</span></h3>
                    <p class="text-xs text-slate-600 leading-tight" data-i18n="info_design_d">Tipografia accessible i colors pensats per a l'aula. Sense distraccions.</p>
                </div>
                <div class="advantage-card">
                    <h3 class="text-sm font-black text-slate-800 mb-1"><i class="fas fa-wifi text-indigo-600 mr-2"></i><span data-i18n="info_offline_t">Funciona Offline</span></h3>
                    <p class="text-xs text-slate-600 leading-tight" data-i18n="info_offline_d">Un cop obert, funciona sense internet. Ideal si falla la xarxa del centre.</p>
                </div>
                <div class="advantage-card">
                    <h3 class="text-sm font-black text-slate-800 mb-1"><i class="fas fa-ban text-indigo-600 mr-2"></i><span data-i18n="info_ads_t">Zero Publicitat</span></h3>
                    <p class="text-xs text-slate-600 leading-tight" data-i18n="info_ads_d">Sense anuncis ni rastrejadors. Un entorn educatiu segur i net.</p>
                </div>
            </div>

            <div class="mt-6 text-center border-t pt-4">
                <p class="text-xs text-slate-500 font-bold" data-i18n="info_dev">Creat i desenvolupat per Alfonso Lorenzo Martínez</p>
                <p class="text-[10px] text-slate-400 font-mono">aloren26@xtec.cat</p>
                <button onclick="toggleInfoModal()" class="mt-3 px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold text-xs hover:bg-indigo-700 transition shadow-lg uppercase" data-i18n="info_btn">Entesos!</button>
            </div>
        </div>
    </div>

    <!-- CONFIGURACIÓ -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
            <h2 class="text-2xl font-black mb-4 uppercase" data-i18n="config_title">Configuració</h2>
            <div class="mb-4">
                <label class="block text-sm font-bold text-slate-700 mb-1" data-i18n="config_name">Nom del Docent</label>
                <input type="text" id="setting-name" class="w-full border border-slate-300 rounded p-2" placeholder="...">
            </div>
             <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
                <button onclick="resetWidgetPositions()" class="w-full bg-blue-100 text-blue-700 hover:bg-blue-200 py-2 rounded-lg font-bold text-sm transition uppercase" data-i18n="config_reset_pos">Recuperar Widgets</button>
                <p class="text-xs text-blue-600 mt-2 text-center font-bold" data-i18n="config_reset_desc">Torna tots els widgets al centre si s'han perdut.</p>
            </div>
            <div class="flex justify-between items-center pt-4 border-t border-slate-100">
                <button onclick="factoryReset()" class="text-red-500 text-xs font-black uppercase tracking-wider" data-i18n="config_reset_all">Reset Total</button>
                <button onclick="toggleConfig()" class="px-6 py-2 bg-slate-800 text-white rounded-lg font-black uppercase hover:bg-black transition" data-i18n="config_done">Fet</button>
            </div>
        </div>
    </div>

    <script>
        // TRADUCCIONS
        const translations = {
            ca: {
                menu_time: "Temps", menu_digital: "Digital", menu_analog: "Analògic", menu_timer: "Temporitzador",
                menu_class: "Aula", menu_picker: "Selector", menu_groups: "Grups", menu_dice: "Daus", menu_symbols: "Símbols", menu_noise: "Sonòmetre", menu_traffic: "Semàfor",
                menu_tools: "Eines", menu_timetable: "Horari", menu_notes: "Notes", menu_todo: "Tasques", menu_qr: "Codi QR", menu_links: "Enllaços",
                
                analog_title: "Analògic", notes_title: "Notes", timer_title: "Temporitzador", picker_title: "Selector", groups_title: "Equips", dice_title: "Daus", symbols_title: "Mode de Treball", noise_title: "Soroll", todo_title: "Tasques", qr_title: "Codi QR", links_title: "Enllaços", timetable_title: "Horari",
                
                who_will_be: "Qui serà?", pick: "Triar", list_label: "Noms (un per línia):", close: "Tancar", who_is_here: "Qui hi és avui?", all: "Tots", done: "Fet",
                groups_label: "Grups:", generate: "Generar", groups_help: "Indica quants grups i clica \"Generar\".",
                activate: "Activar", stop: "Aturar", add_web: "Afegir Web", qr_help: "Introdueix URL i genera", generate_code: "Generar Codi", roll: "Llançar",
                
                time_col: "Hora", activity_col: "Activitat", icon_help: "Clica una icona per inserir-la",
                
                info_title: "Per què aquest Escriptori?",
                info_free_t: "100% Gratuït", info_free_d: "Sense subscripcions ni versions \"Pro\". Totes les eines són gratis per sempre.",
                info_privacy_t: "Privacitat Total", info_privacy_d: "Les dades mai surten del teu ordinador. Compliment automàtic de protecció de dades.",
                info_fast_t: "Sense Registre", info_fast_d: "Sense comptes ni contrasenyes. Obre l'arxiu i comença la classe a l'instant.",
                info_design_t: "Disseny Adaptat", info_design_d: "Tipografia accessible i colors pensats per a l'aula. Sense distraccions.",
                info_offline_t: "Funciona Offline", info_offline_d: "Un cop obert, funciona sense internet. Ideal si falla la xarxa del centre.",
                info_ads_t: "Zero Publicitat", info_ads_d: "Sense anuncis ni rastrejadors. Un entorn educatiu segur i net.",
                info_dev: "Creat i desenvolupat per Alfonso Lorenzo Martínez", info_btn: "Entesos!",
                
                config_title: "Configuració", config_name: "Nom del Docent", config_reset_pos: "Recuperar Widgets", config_reset_desc: "Torna tots els widgets al centre si s'han perdut.", config_reset_all: "Reset Total", config_done: "Fet",
                credits_name: "Creat per Alfonso LM",
                
                sym_silence: "Silenci", sym_whisper: "Parelles", sym_group: "Grup", sym_ask: "Pregunta",
                
                // Icons
                ic_acad: "Acadèmic", ic_math: "Mates", ic_lang: "Llengua", ic_write: "Escriure", ic_sci: "Ciència", ic_soc: "Socials", ic_eng: "Anglès", ic_robot: "Robòtica", ic_read: "Lectura", ic_proj: "Projecte",
                ic_arts: "Arts i Cos", ic_art: "Plàstica", ic_mus: "Música", ic_pe: "EF", ic_drama: "Teatre", ic_body: "Cos",
                ic_div: "Diversitat", ic_sup: "Suport", ic_sign: "Signes", ic_hear: "Audició", ic_game: "Jocs", ic_think: "Pensar", ic_access: "Accés", ic_mob: "Mobilitat", ic_emo: "Emoció", ic_speak: "Parla",
                ic_rout: "Rutines", ic_morn: "Bon dia", ic_circ: "Rotllana", ic_eat: "Dinar", ic_play: "Pati", ic_wc: "Lavabo", ic_bus: "Bus", ic_home: "Casa"
            },
            es: {
                menu_time: "Tiempo", menu_digital: "Digital", menu_analog: "Analógico", menu_timer: "Temporizador",
                menu_class: "Aula", menu_picker: "Selector", menu_groups: "Grupos", menu_dice: "Dados", menu_symbols: "Símbolos", menu_noise: "Sonómetro", menu_traffic: "Semáforo",
                menu_tools: "Herram.", menu_timetable: "Horario", menu_notes: "Notas", menu_todo: "Tareas", menu_qr: "Código QR", menu_links: "Enlaces",
                
                analog_title: "Analógico", notes_title: "Notas", timer_title: "Temporizador", picker_title: "Selector", groups_title: "Equipos", dice_title: "Dados", symbols_title: "Modo de Trabajo", noise_title: "Ruido", todo_title: "Tareas", qr_title: "Código QR", links_title: "Enlaces", timetable_title: "Horario",
                
                who_will_be: "¿Quién será?", pick: "Elegir", list_label: "Nombres (uno por línea):", close: "Cerrar", who_is_here: "¿Quién está hoy?", all: "Todos", done: "Hecho",
                groups_label: "Grupos:", generate: "Generar", groups_help: "Indica cuántos grupos y clica \"Generar\".",
                activate: "Activar", stop: "Parar", add_web: "Añadir Web", qr_help: "Introduce URL y genera", generate_code: "Generar Código", roll: "Lanzar",
                
                time_col: "Hora", activity_col: "Actividad", icon_help: "Clica un icono para insertarlo",
                
                info_title: "¿Por qué este Escritorio?",
                info_free_t: "100% Gratuito", info_free_d: "Sin suscripciones ni versiones \"Pro\". Todas las herramientas son gratis para siempre.",
                info_privacy_t: "Privacidad Total", info_privacy_d: "Los datos nunca salen de tu ordenador. Cumplimiento automático de protección de datos.",
                info_fast_t: "Sin Registro", info_fast_d: "Sin cuentas ni contraseñas. Abre el archivo y empieza la clase al instante.",
                info_design_t: "Diseño Adaptado", info_design_d: "Tipografía accesible y colores pensados para el aula. Sin distracciones.",
                info_offline_t: "Funciona Offline", info_offline_d: "Una vez abierto, funciona sin internet. Ideal si falla la red del centro.",
                info_ads_t: "Cero Publicidad", info_ads_d: "Sin anuncios ni rastreadores. Un entorno educativo seguro y limpio.",
                info_dev: "Creado y desarrollado por Alfonso Lorenzo Martínez", info_btn: "¡Entendido!",
                
                config_title: "Configuración", config_name: "Nombre del Docente", config_reset_pos: "Recuperar Widgets", config_reset_desc: "Devuelve todos los widgets al centro si se han perdido.", config_reset_all: "Reset Total", config_done: "Hecho",
                credits_name: "Creado por Alfonso LM",
                
                sym_silence: "Silencio", sym_whisper: "Parejas", sym_group: "Grupo", sym_ask: "Pregunta",

                // Icons
                ic_acad: "Académico", ic_math: "Mates", ic_lang: "Lengua", ic_write: "Escribir", ic_sci: "Ciencia", ic_soc: "Sociales", ic_eng: "Inglés", ic_robot: "Robótica", ic_read: "Lectura", ic_proj: "Proyecto",
                ic_arts: "Artes y Cuerpo", ic_art: "Plástica", ic_mus: "Música", ic_pe: "EF", ic_drama: "Teatro", ic_body: "Cuerpo",
                ic_div: "Diversidad", ic_sup: "Apoyo", ic_sign: "Signos", ic_hear: "Audición", ic_game: "Juegos", ic_think: "Pensar", ic_access: "Acceso", ic_mob: "Movilidad", ic_emo: "Emoción", ic_speak: "Habla",
                ic_rout: "Rutinas", ic_morn: "Buenos días", ic_circ: "Asamblea", ic_eat: "Comer", ic_play: "Patio", ic_wc: "Baño", ic_bus: "Bus", ic_home: "Casa"
            },
            en: {
                menu_time: "Time", menu_digital: "Digital", menu_analog: "Analog", menu_timer: "Timer",
                menu_class: "Class", menu_picker: "Picker", menu_groups: "Groups", menu_dice: "Dice", menu_symbols: "Symbols", menu_noise: "Noise Meter", menu_traffic: "Traffic Light",
                menu_tools: "Tools", menu_timetable: "Timetable", menu_notes: "Notes", menu_todo: "Tasks", menu_qr: "QR Code", menu_links: "Links",
                
                analog_title: "Analog", notes_title: "Notes", timer_title: "Timer", picker_title: "Selector", groups_title: "Teams", dice_title: "Dice", symbols_title: "Work Mode", noise_title: "Noise", todo_title: "Tasks", qr_title: "QR Code", links_title: "Links", timetable_title: "Timetable",
                
                who_will_be: "Who's next?", pick: "Pick", list_label: "Names (one per line):", close: "Close", who_is_here: "Who is here?", all: "All", done: "Done",
                groups_label: "Groups:", generate: "Generate", groups_help: "Set number of groups and click \"Generate\".",
                activate: "Start", stop: "Stop", add_web: "Add Web", qr_help: "Enter URL and generate", generate_code: "Generate Code", roll: "Roll",
                
                time_col: "Time", activity_col: "Activity", icon_help: "Click icon to insert",
                
                info_title: "Why this Dashboard?",
                info_free_t: "100% Free", info_free_d: "No subscriptions, no \"Pro\" versions. All tools are free forever.",
                info_privacy_t: "Total Privacy", info_privacy_d: "Data never leaves your computer. Automatic compliance with data protection.",
                info_fast_t: "No Signup", info_fast_d: "No accounts or passwords. Just open the file and start teaching instantly.",
                info_design_t: "Adapted Design", info_design_d: "Accessible typography and classroom-friendly colors. No distractions.",
                info_offline_t: "Works Offline", info_offline_d: "Once opened, works without internet. Ideal if school network fails.",
                info_ads_t: "Zero Ads", info_ads_d: "No ads or trackers. A safe and clean educational environment.",
                info_dev: "Created and developed by Alfonso Lorenzo Martínez", info_btn: "Got it!",
                
                config_title: "Settings", config_name: "Teacher's Name", config_reset_pos: "Recover Widgets", config_reset_desc: "Returns all widgets to center if lost.", config_reset_all: "Full Reset", config_done: "Done",
                credits_name: "Created by Alfonso LM",
                
                sym_silence: "Silence", sym_whisper: "Pairs", sym_group: "Group", sym_ask: "Ask",

                // Icons
                ic_acad: "Academic", ic_math: "Math", ic_lang: "Language", ic_write: "Writing", ic_sci: "Science", ic_soc: "Social", ic_eng: "English", ic_robot: "Robotics", ic_read: "Reading", ic_proj: "Project",
                ic_arts: "Arts & Body", ic_art: "Art", ic_mus: "Music", ic_pe: "PE", ic_drama: "Drama", ic_body: "Body",
                ic_div: "Diversity", ic_sup: "Support", ic_sign: "Sign", ic_hear: "Hearing", ic_game: "Games", ic_think: "Thinking", ic_access: "Access", ic_mob: "Mobility", ic_emo: "Emotion", ic_speak: "Speech",
                ic_rout: "Routines", ic_morn: "Morning", ic_circ: "Circle", ic_eat: "Lunch", ic_play: "Playground", ic_wc: "Toilet", ic_bus: "Bus", ic_home: "Home"
            }
        };

        // --- GLOBAL VARIABLES & STATE ---
        const widgetColors = {
            blanc: 'bg-white/90 text-slate-800',
            negre: 'bg-slate-900/90 text-white',
            gris: 'bg-gray-500/90 text-white',
            groc: 'bg-yellow-400/90 text-slate-900',
            taronja: 'bg-orange-500/90 text-white',
            vermell: 'bg-red-600/90 text-white',
            rosa: 'bg-pink-300/90 text-slate-900',
            fucsia: 'bg-fuchsia-600/90 text-white',
            blaufosc: 'bg-blue-900/90 text-white',
            blaucel: 'bg-sky-400/90 text-white',
            verdfosc: 'bg-emerald-800/90 text-white',
            verdclar: 'bg-lime-400/90 text-slate-900',
            marro: 'bg-amber-800/90 text-white'
        };

        const defaultState = {
            lang: 'ca', // Default language
            teacherName: "",
            lastBgUpdate: null,
            currentBgUrl: "https://images.unsplash.com/photo-1472214103451-9374bd1c798e?q=80&w=2070&auto=format&fit=crop",
            widgets: {
                clock: { visible: true, x: 50, y: 150, w: 300, h: 200, color: 'blanc' },
                analog: { visible: false, x: 360, y: 150, w: 280, h: 320, color: 'blanc' }, 
                timetable: { visible: false, content: "", title: "Horari", x: 400, y: 150, w: 450, h: 500, color: 'blanc' },
                picker: { visible: false, names: "Alumne 1\nAlumne 2\nAlumne 3", excluded: [], x: 850, y: 150, w: 300, h: 250, color: 'blanc' },
                notes: { visible: false, text: "", x: 50, y: 400, w: 300, h: 300, color: 'groc' },
                traffic: { visible: false, active: null, x: 400, y: 600, w: 140, h: 320, color: 'blanc' }, 
                timer: { visible: false, duration: 5, timeLeft: 300, isRunning: false, x: 500, y: 400, w: 300, h: 250, color: 'blanc' },
                groups: { visible: false, count: 4, x: 100, y: 150, w: 400, h: 400, color: 'blanc' },
                noise: { visible: false, x: 200, y: 200, w: 200, h: 350, color: 'blanc' },
                todo: { visible: false, tasks: [], x: 600, y: 250, w: 300, h: 400, color: 'blanc' },
                qr: { visible: false, lastUrl: "", x: 100, y: 200, w: 280, h: 380, color: 'blanc' },
                dice: { visible: false, count: 1, x: 500, y: 300, w: 300, h: 250, color: 'blanc' },
                symbols: { visible: false, current: 'silence', x: 300, y: 250, w: 320, h: 320, color: 'blanc' },
                links: { visible: false, items: [
                    {name: 'Google', url: 'https://google.com', icon: 'fa-google'},
                    {name: 'YouTube', url: 'https://youtube.com', icon: 'fa-youtube'},
                    {name: 'Canva', url: 'https://canva.com', icon: 'fa-pen-nib'}
                ], x: 800, y: 150, w: 300, h: 350, color: 'blanc' }
            }
        };

        let appState = {};
        let timerInterval, audioContext, microphoneStream, noiseInterval;
        let qrObj = null;
        let lastFocusedTimetableCell = null;

        // BANC D'IMATGES AMPLIAT (73 Imatges)
        const bgCollection = [
            "https://images.unsplash.com/photo-1472214103451-9374bd1c798e?q=80&w=2070", "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2070", 
            "https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=2070", "https://images.unsplash.com/photo-1447752875215-b2761acb3c5d?q=80&w=2070", 
            "https://images.unsplash.com/photo-1500382017468-9049fed747ef?q=80&w=2070", "https://images.unsplash.com/photo-1469474968028-56623f02e42e?q=80&w=2070", 
            "https://images.unsplash.com/photo-1505144808419-1957a94ca61e?q=80&w=2070", "https://images.unsplash.com/photo-1532274402911-5a369e4c4bb5?q=80&w=2070", 
            "https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?q=80&w=2070", "https://images.unsplash.com/photo-1426604966848-d7adac402bff?q=80&w=2070", 
            "https://images.unsplash.com/photo-1493246507139-91e8fad9978e?q=80&w=2070", "https://images.unsplash.com/photo-1511497584788-876760111969?q=80&w=2070", 
            "https://images.unsplash.com/photo-1454496522488-7a8e488e8606?q=80&w=2070", "https://images.unsplash.com/photo-1433086966358-54859d0ed716?q=80&w=2070", 
            "https://images.unsplash.com/photo-1502082553048-f009c37129b9?q=80&w=2070", "https://images.unsplash.com/photo-1465146344425-f00d5f5c8f07?q=80&w=2070", 
            "https://images.unsplash.com/photo-1470252649378-9c29740c9fa8?q=80&w=2070", "https://images.unsplash.com/photo-1439853949127-fa647821eba0?q=80&w=2070", 
            "https://images.unsplash.com/photo-1482938289607-e9573fc25ebb?q=80&w=2070", "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=2070", 
            "https://images.unsplash.com/photo-1476610182048-b716b8518aae?q=80&w=2070", "https://images.unsplash.com/photo-1499002238440-d264edd596ec?q=80&w=2070", 
            "https://images.unsplash.com/photo-1433838552652-f9a46b332c40?q=80&w=2070", "https://images.unsplash.com/photo-1458668383970-8ddd3927deed?q=80&w=2070", 
            "https://images.unsplash.com/photo-1518173946687-a4c8892bbd9f?q=80&w=2070", "https://images.unsplash.com/photo-1486312338219-ce68d2c6f44d?q=80&w=2070", 
            "https://images.unsplash.com/photo-1497366216548-37526070297c?q=80&w=2070", "https://images.unsplash.com/photo-1506784983877-45594efa4cbe?q=80&w=2070", 
            "https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2070", "https://images.unsplash.com/photo-1534224039826-c7a0eda0e6b3?q=80&w=2070", 
            "https://images.unsplash.com/photo-1508615039623-a25605d2b022?q=80&w=2070", "https://images.unsplash.com/photo-1483729558449-99ef09a8c325?q=80&w=2070", 
            "https://images.unsplash.com/photo-1475924156734-496f6cac6ec1?q=80&w=2070", "https://images.unsplash.com/photo-1500964757637-c85e8a162699?q=80&w=2070", 
            "https://images.unsplash.com/photo-1496715976403-7e36dc43f17b?q=80&w=2070", "https://images.unsplash.com/photo-1493514789931-5f7514744eb6?q=80&w=2070", 
            "https://images.unsplash.com/photo-1504805572947-34fad45aed93?q=80&w=2070", "https://images.unsplash.com/photo-1524169358666-79f22534bc6e?q=80&w=2070", 
            "https://images.unsplash.com/photo-1526721940322-10fb6e3ae94a?q=80&w=2070", "https://images.unsplash.com/photo-1501630834273-4b5604d2ee31?q=80&w=2070", 
            "https://images.unsplash.com/photo-1528722828814-77b9b83aafb2?q=80&w=2070", "https://images.unsplash.com/photo-1531315630201-bb15abeb1653?q=80&w=2070", 
            "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=2070", "https://images.unsplash.com/photo-1503264116251-35a269479413?q=80&w=2070", 
            "https://images.unsplash.com/photo-1516550893923-42d28e5677af?q=80&w=2070", "https://images.unsplash.com/photo-1518655048521-f130df041f66?q=80&w=2070", 
            "https://images.unsplash.com/photo-1513542789411-b6a5d4f31634?q=80&w=2070", "https://images.unsplash.com/photo-1481627834876-b7833e8f5570?q=80&w=2070", 
            "https://images.unsplash.com/photo-1491895200222-0fc4a4c35e18?q=80&w=2070", "https://images.unsplash.com/photo-1434030216411-0b793f4b4173?q=80&w=2070", 
            "https://images.unsplash.com/photo-1497215842964-222b430dc0a8?q=80&w=2070", "https://images.unsplash.com/photo-1465433056549-e92ed3115663?q=80&w=2070", 
            "https://images.unsplash.com/photo-1475070901697-1e54ac5e9850?q=80&w=2070", "https://images.unsplash.com/photo-1485470764509-0e040261394a?q=80&w=2070", 
            "https://images.unsplash.com/photo-1502481851512-e9e2529bfbf9?q=80&w=2070", "https://images.unsplash.com/photo-1431794062232-2a99a5431c6c?q=80&w=2070", 
            "https://images.unsplash.com/photo-1505664194779-8beaceb93744?q=80&w=2070", "https://images.unsplash.com/photo-1507608616759-54f48f0af0ee?q=80&w=2070", 
            "https://images.unsplash.com/photo-1511300636408-a63a89df3482?q=80&w=2070", "https://images.unsplash.com/photo-1494548162494-384bba4ab999?q=80&w=2070", 
            "https://images.unsplash.com/photo-1533577116850-9cc66cad8a9b?q=80&w=2070", "https://images.unsplash.com/photo-1495195129352-aeb325a55b65?q=80&w=2070", 
            "https://images.unsplash.com/photo-1460925895917-afdab827c52f?q=80&w=2070", "https://images.unsplash.com/photo-1504253163759-c23fccaebb55?q=80&w=2070", 
            "https://images.unsplash.com/photo-1515595967223-f9fa59af5a3b?q=80&w=2070", "https://images.unsplash.com/photo-1499750310159-5b5f0d693169?q=80&w=2070", 
            "https://images.unsplash.com/photo-1520038410233-7141dd7e6f97?q=80&w=2070", "https://images.unsplash.com/photo-1519751138087-5bf79df62d5b?q=80&w=2070", 
            "https://images.unsplash.com/photo-1504198266287-1659872e6590?q=80&w=2070", "https://images.unsplash.com/photo-1490730141103-6cac27aaab94?q=80&w=2070", 
            "https://images.unsplash.com/photo-1496309732348-3627f3f040ee?q=80&w=2070", "https://images.unsplash.com/photo-1462331940025-496dfbfc7564?q=80&w=2070", 
            "https://images.unsplash.com/photo-1440688807730-73e4e2169fb8?q=80&w=2070" 
        ];

        // --- INIT ---
        function loadState() {
            const saved = localStorage.getItem('escriptoriTacStatev22'); // Bump Version
            if (saved) {
                const parsed = JSON.parse(saved);
                appState = { ...defaultState, ...parsed, widgets: { ...defaultState.widgets, ...parsed.widgets } };
                ['qr', 'dice', 'symbols', 'links'].forEach(k => {
                    if(!appState.widgets[k]) appState.widgets[k] = defaultState.widgets[k];
                });
            } else {
                appState = JSON.parse(JSON.stringify(defaultState));
                appState.widgets.timetable.content = generateDailyTimetable();
                const cx = (window.innerWidth / 2) - (300 / 2);
                const cy = (window.innerHeight / 2) - (180 / 2);
                appState.widgets.clock.x = cx; appState.widgets.clock.y = cy;
                appState.widgets.clock.w = 300; appState.widgets.clock.h = 180;
                appState.widgets.clock.visible = true;
            }

            setLanguage(appState.lang || 'ca');
            setInterval(updateClock, 1000); updateClock();
            setInterval(updateAnalogClock, 1000); updateAnalogClock();
            checkDailyBackground();
            initWidgets();
        }

        function saveState() { localStorage.setItem('escriptoriTacStatev22', JSON.stringify(appState)); }

        // --- TRANSLATION SYSTEM ---
        function setLanguage(lang) {
            appState.lang = lang;
            const t = translations[lang];
            
            // Update UI Text
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(t[key]) {
                    if(el.tagName === 'INPUT' && el.type === 'placeholder') el.placeholder = t[key];
                    else el.textContent = t[key];
                }
            });

            // Update Active Lang Button
            ['ca','es','en'].forEach(l => {
                const btn = document.getElementById('lang-'+l);
                if(l === lang) btn.classList.add('active', 'text-indigo-600', 'underline');
                else btn.classList.remove('active', 'text-indigo-600', 'underline');
            });

            // Update Specific Dynamic Content
            updateSymbolDisplay();
            updateTimetableIconsRender();
            
            saveState();
        }

        // --- ICON PICKER RENDER (Dynamic Lang) ---
        function updateTimetableIconsRender() {
            const t = translations[appState.lang];
            const container = document.getElementById('icon-picker-content');
            container.innerHTML = `
                <!-- ACADEMIC -->
                <div class="icon-category-title">${t.ic_acad}</div>
                <div onclick="insertIcon('fa-book')" class="icon-btn"><i class="fas fa-book"></i><span>${t.ic_lang}</span></div>
                <div onclick="insertIcon('fa-calculator')" class="icon-btn"><i class="fas fa-calculator"></i><span>${t.ic_math}</span></div>
                <div onclick="insertIcon('fa-flask')" class="icon-btn"><i class="fas fa-flask"></i><span>${t.ic_sci}</span></div>
                <div onclick="insertIcon('fa-globe-americas')" class="icon-btn"><i class="fas fa-globe-americas"></i><span>${t.ic_soc}</span></div>
                <div onclick="insertIcon('fa-language')" class="icon-btn"><i class="fas fa-language"></i><span>${t.ic_eng}</span></div>
                <div onclick="insertIcon('fa-laptop-code')" class="icon-btn"><i class="fas fa-laptop-code"></i><span>${t.ic_robot}</span></div>
                <div onclick="insertIcon('fa-pencil-alt')" class="icon-btn"><i class="fas fa-pencil-alt"></i><span>${t.ic_write}</span></div>
                <div onclick="insertIcon('fa-book-reader')" class="icon-btn"><i class="fas fa-book-reader"></i><span>${t.ic_read}</span></div>
                <div onclick="insertIcon('fa-lightbulb')" class="icon-btn"><i class="fas fa-lightbulb"></i><span>${t.ic_proj}</span></div>
                
                <!-- ARTS & BODY -->
                <div class="icon-category-title">${t.ic_arts}</div>
                <div onclick="insertIcon('fa-palette')" class="icon-btn"><i class="fas fa-palette"></i><span>${t.ic_art}</span></div>
                <div onclick="insertIcon('fa-music')" class="icon-btn"><i class="fas fa-music"></i><span>${t.ic_mus}</span></div>
                <div onclick="insertIcon('fa-running')" class="icon-btn"><i class="fas fa-running"></i><span>${t.ic_pe}</span></div>
                <div onclick="insertIcon('fa-theater-masks')" class="icon-btn"><i class="fas fa-theater-masks"></i><span>${t.ic_drama}</span></div>
                <div onclick="insertIcon('fa-child')" class="icon-btn"><i class="fas fa-child"></i><span>${t.ic_body}</span></div>
                
                <!-- DIVERSITY / NEE -->
                <div class="icon-category-title">${t.ic_div}</div>
                <div onclick="insertIcon('fa-hands-helping')" class="icon-btn"><i class="fas fa-hands-helping text-teal-600"></i><span>${t.ic_sup}</span></div>
                <div onclick="insertIcon('fa-sign-language')" class="icon-btn"><i class="fas fa-sign-language text-purple-600"></i><span>${t.ic_sign}</span></div>
                <div onclick="insertIcon('fa-ear-listen')" class="icon-btn"><i class="fas fa-ear-listen text-orange-500"></i><span>${t.ic_hear}</span></div>
                <div onclick="insertIcon('fa-puzzle-piece')" class="icon-btn"><i class="fas fa-puzzle-piece text-blue-500"></i><span>${t.ic_game}</span></div>
                <div onclick="insertIcon('fa-brain')" class="icon-btn"><i class="fas fa-brain text-pink-500"></i><span>${t.ic_think}</span></div>
                <div onclick="insertIcon('fa-universal-access')" class="icon-btn"><i class="fas fa-universal-access"></i><span>${t.ic_access}</span></div>
                <div onclick="insertIcon('fa-wheelchair')" class="icon-btn"><i class="fas fa-wheelchair"></i><span>${t.ic_mob}</span></div>
                <div onclick="insertIcon('fa-face-smile')" class="icon-btn"><i class="fas fa-face-smile text-yellow-500"></i><span>${t.ic_emo}</span></div>
                <div onclick="insertIcon('fa-comment-dots')" class="icon-btn"><i class="fas fa-comment-dots"></i><span>${t.ic_speak}</span></div>

                <!-- ROUTINES -->
                <div class="icon-category-title">${t.ic_rout}</div>
                <div onclick="insertIcon('fa-sun')" class="icon-btn"><i class="fas fa-sun text-yellow-500"></i><span>${t.ic_morn}</span></div>
                <div onclick="insertIcon('fa-users')" class="icon-btn"><i class="fas fa-users"></i><span>${t.ic_circ}</span></div>
                <div onclick="insertIcon('fa-utensils')" class="icon-btn"><i class="fas fa-utensils"></i><span>${t.ic_eat}</span></div>
                <div onclick="insertIcon('fa-tree')" class="icon-btn"><i class="fas fa-tree text-green-600"></i><span>${t.ic_play}</span></div>
                <div onclick="insertIcon('fa-restroom')" class="icon-btn"><i class="fas fa-restroom"></i><span>${t.ic_wc}</span></div>
                <div onclick="insertIcon('fa-bus')" class="icon-btn"><i class="fas fa-bus text-yellow-600"></i><span>${t.ic_bus}</span></div>
                <div onclick="insertIcon('fa-home')" class="icon-btn"><i class="fas fa-home text-blue-500"></i><span>${t.ic_home}</span></div>
            `;
        }

        // --- INFO MODAL LOGIC ---
        function toggleInfoModal() {
            const modal = document.getElementById('info-modal');
            const content = modal.querySelector('div'); 
            modal.classList.toggle('hidden');
            if(!modal.classList.contains('hidden')) { content.scrollTop = 0; }
        }

        // --- TIMETABLE ICON LOGIC ---
        function toggleIconPicker() { document.getElementById('timetable-icons').classList.toggle('hidden'); }
        function insertIcon(iconClass) {
            if (lastFocusedTimetableCell) {
                const iconHtml = `<i class="fas ${iconClass} mr-2 select-none" contenteditable="false"></i>&nbsp;`;
                lastFocusedTimetableCell.focus();
                document.execCommand('insertHTML', false, iconHtml);
                lastFocusedTimetableCell.dispatchEvent(new Event('input', { bubbles: true }));
                document.getElementById('timetable-icons').classList.add('hidden');
            } else {
                alert(appState.lang === 'ca' ? "Primer clica a una casella!" : (appState.lang==='es'?"¡Primero clica una casilla!":"First click a cell!"));
            }
        }

        // --- WIDGET LOGIC ---
        function initWidgets() {
            document.getElementById('setting-name').value = appState.teacherName;
            document.getElementById('setting-name').addEventListener('input', (e) => { appState.teacherName = e.target.value; saveState(); });

            Object.keys(appState.widgets).forEach(id => {
                const wState = appState.widgets[id];
                const el = document.getElementById(`widget-${id}`);
                if (el) {
                    el.style.left = wState.x + 'px'; el.style.top = wState.y + 'px';
                    el.style.width = wState.w + 'px'; el.style.height = wState.h + 'px';
                    wState.visible ? el.classList.remove('hidden-widget') : el.classList.add('hidden-widget');
                    applyWidgetColor(id);
                    makeInteractable(el, id);
                }
            });
            
            document.getElementById('notes-area').value = appState.widgets.notes.text;
            document.getElementById('student-list').value = appState.widgets.picker.names;
            document.getElementById('timetable-title').textContent = appState.widgets.timetable.title || "Horari";
            document.getElementById('timetable-body').innerHTML = appState.widgets.timetable.content || generateDailyTimetable();
            
            // Add listeners to timetable cells for focus tracking
            const cells = document.querySelectorAll('#timetable-body td[contenteditable="true"]');
            cells.forEach(cell => { cell.addEventListener('focus', (e) => { lastFocusedTimetableCell = e.target; }); });
            document.getElementById('timetable-body').addEventListener('focusin', (e) => { if (e.target.tagName === 'TD') lastFocusedTimetableCell = e.target; });

            updateTrafficLightDOM(appState.widgets.traffic.active);
            updateTimerDisplay(appState.widgets.timer.timeLeft);
            renderTodoList();
            
            if(appState.widgets.qr.lastUrl) {
                document.getElementById('qr-input').value = appState.widgets.qr.lastUrl;
                generateQR();
            }
            // Symbols & Dice called by loadState -> setLanguage
            renderLinks();
            renderDice(appState.widgets.dice.count, true);
        }

        // 1. QR
        function generateQR() {
            const url = document.getElementById('qr-input').value;
            const container = document.getElementById('qrcode');
            container.innerHTML = "";
            if(!url) { 
                const t = translations[appState.lang];
                container.innerHTML = `<span class="text-slate-300 text-xs font-bold text-center">${t.qr_help}</span>`; 
                return; 
            }
            new QRCode(container, { text: url, width: 180, height: 180 });
            appState.widgets.qr.lastUrl = url;
            saveState();
        }

        // 2. DAUS
        function setDiceCount(n) { appState.widgets.dice.count = n; saveState(); renderDice(n, true); }
        function renderDice(n, static = false) {
            const container = document.getElementById('dice-container');
            container.innerHTML = "";
            for(let i=0; i<n; i++) {
                const val = static ? 1 : Math.floor(Math.random() * 6) + 1;
                const die = document.createElement('i');
                const words = ['one', 'two', 'three', 'four', 'five', 'six'];
                die.className = `fas fa-dice-${words[val-1]} transition`;
                container.appendChild(die);
            }
        }
        function rollDice() {
            const container = document.getElementById('dice-container');
            container.classList.add('animate-shake');
            setTimeout(() => {
                container.classList.remove('animate-shake');
                renderDice(appState.widgets.dice.count, false);
            }, 500);
        }

        // 3. SYMBOLS
        function setSymbol(key) { appState.widgets.symbols.current = key; saveState(); updateSymbolDisplay(); }
        function updateSymbolDisplay() {
            const current = appState.widgets.symbols.current;
            const t = translations[appState.lang];
            const keyMap = { silence: 'sym_silence', whisper: 'sym_whisper', group: 'sym_group', ask: 'sym_ask' };
            const iconMap = { silence: 'fa-comment-slash', whisper: 'fa-user-friends', group: 'fa-users', ask: 'fa-hand-paper' };
            
            const text = t[keyMap[current]];
            const icon = iconMap[current];
            
            const display = document.getElementById('symbol-display');
            display.innerHTML = `<i class="fas ${icon} text-8xl opacity-80"></i><span class="text-2xl font-black uppercase tracking-widest mt-4">${text}</span>`;
        }

        // 4. LINKS
        function renderLinks() {
            const container = document.getElementById('links-container');
            container.innerHTML = "";
            appState.widgets.links.items.forEach((item, index) => {
                const btn = document.createElement('a');
                btn.href = item.url;
                btn.target = "_blank";
                btn.className = "flex flex-col items-center justify-center p-3 bg-white/50 rounded-xl hover:bg-white transition shadow-sm group aspect-square relative";
                btn.innerHTML = `
                    <i class="fab ${item.icon} text-3xl text-slate-600 group-hover:text-indigo-600 mb-2"></i>
                    <span class="text-[10px] font-bold uppercase truncate w-full text-center text-slate-800">${item.name}</span>
                    <button onclick="removeLink(event, ${index})" class="absolute top-1 right-1 text-red-300 hover:text-red-500 text-xs opacity-0 group-hover:opacity-100"><i class="fas fa-times"></i></button>
                `;
                container.appendChild(btn);
            });
        }
        function addNewLink() {
            const t = appState.lang === 'ca' ? "Nom:" : (appState.lang === 'es' ? "Nombre:" : "Name:");
            const name = prompt(t);
            if(!name) return;
            const url = prompt("URL (https://...):");
            if(!url) return;
            appState.widgets.links.items.push({ name, url, icon: 'fa-link' });
            saveState(); renderLinks();
        }
        function removeLink(e, index) {
            e.preventDefault(); e.stopPropagation();
            if(confirm(appState.lang==='ca'?"Esborrar?":(appState.lang==='es'?"¿Borrar?":"Delete?"))) {
                appState.widgets.links.items.splice(index, 1);
                saveState(); renderLinks();
            }
        }

        // --- SISTEMA INTERACTIVITAT ---
        function makeInteractable(element, widgetId) {
            const header = element.querySelector('.widget-header');
            let isDragging = false, startX, startY, initialLeft, initialTop;
            if (header) {
                header.addEventListener('mousedown', (e) => {
                    if(e.target.closest('button') || e.target.closest('input') || e.target.closest('textarea')) return;
                    isDragging = true; startX = e.clientX; startY = e.clientY;
                    initialLeft = element.offsetLeft; initialTop = element.offsetTop;
                    bringToFront(element);
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            }
            function onMouseMove(e) {
                if (!isDragging) return;
                const dx = e.clientX - startX; const dy = e.clientY - startY;
                let newLeft = initialLeft + dx; let newTop = initialTop + dy;
                const maxLeft = window.innerWidth - element.offsetWidth;
                const maxTop = window.innerHeight - element.offsetHeight;
                if(newLeft < 0) newLeft = 0; if(newLeft > maxLeft) newLeft = maxLeft;
                if(newTop < 0) newTop = 0; if(newTop > maxTop) newTop = maxTop;
                element.style.left = `${newLeft}px`; element.style.top = `${newTop}px`;
            }
            function onMouseUp() {
                isDragging = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                appState.widgets[widgetId].x = element.offsetLeft;
                appState.widgets[widgetId].y = element.offsetTop;
                saveState();
            }
            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    if (!element.classList.contains('hidden-widget')) {
                        const rect = element.getBoundingClientRect();
                        if (rect.right > window.innerWidth) element.style.left = (window.innerWidth - rect.width) + 'px';
                        if (rect.bottom > window.innerHeight) element.style.top = (window.innerHeight - rect.height) + 'px';
                        appState.widgets[widgetId].w = element.offsetWidth;
                        appState.widgets[widgetId].h = element.offsetHeight;
                        saveState();
                    }
                }
            });
            resizeObserver.observe(element);
            element.addEventListener('mousedown', () => bringToFront(element));
        }

        function bringToFront(el) {
            document.querySelectorAll('.widget').forEach(w => w.style.zIndex = 10);
            el.style.zIndex = 20;
            const menu = el.querySelector('[id^="colors-"]');
            if(menu) menu.style.zIndex = 30;
        }

        function toggleWidget(id) {
            const el = document.getElementById(`widget-${id}`);
            if (el.classList.contains('hidden-widget')) {
                const cx = (window.innerWidth / 2) - (appState.widgets[id].w / 2);
                const cy = (window.innerHeight / 2) - (appState.widgets[id].h / 2);
                appState.widgets[id].x = cx; appState.widgets[id].y = cy;
                el.style.left = cx + 'px'; el.style.top = cy + 'px';
                el.classList.remove('hidden-widget'); appState.widgets[id].visible = true;
                bringToFront(el);
            } else {
                el.classList.add('hidden-widget'); appState.widgets[id].visible = false;
            }
            saveState();
        }
        function closeWidget(id) {
            document.getElementById(`widget-${id}`).classList.add('hidden-widget');
            appState.widgets[id].visible = false; document.getElementById(`colors-${id}`).classList.add('hidden');
            saveState();
        }
        function applyWidgetColor(id) {
            const el = document.getElementById(`widget-${id}`);
            const colorName = appState.widgets[id].color || 'white';
            const bgClass = widgetColors[colorName];
            Object.values(widgetColors).forEach(c => el.classList.remove(...c.split(' ')));
            el.classList.add(...bgClass.split(' '));
        }
        function toggleColorMenu(id) {
            const menu = document.getElementById(`colors-${id}`);
            if (menu.children.length === 0) {
                Object.keys(widgetColors).forEach(color => {
                    const dot = document.createElement('div');
                    dot.className = `color-dot ${widgetColors[color].replace('/90','').replace(' text-white','').replace(' text-slate-800','').replace(' text-slate-900','')} shadow-sm`;
                    dot.onclick = (e) => { e.stopPropagation(); appState.widgets[id].color = color; applyWidgetColor(id); saveState(); menu.classList.add('hidden'); };
                    menu.appendChild(dot);
                });
            }
            menu.classList.toggle('hidden');
        }

        // BACKGROUND LOGIC (IMPROVED RECURSIVE)
        function checkDailyBackground() {
            const now = new Date(); const today8am = new Date(); today8am.setHours(8, 0, 0, 0);
            const lastUpdate = appState.lastBgUpdate ? new Date(appState.lastBgUpdate) : new Date(0);
            if (now >= today8am && lastUpdate < today8am) {
                const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
                // Cycle based on day of year to determine start index
                cycleBackground(dayOfYear % bgCollection.length);
            } else if (!document.body.style.backgroundImage) {
                // If no background set (first load or lost state), load current or default
                cycleBackground(bgCollection.indexOf(appState.currentBgUrl));
            }
        }

        // Modified Cycle to handle specific index and recursion
        function cycleBackground(targetIdx = -1) {
            const btn = document.getElementById('btn-bg-change');
            const icon = document.getElementById('icon-bg-change');
            const spinner = document.getElementById('spinner-bg-change');
            
            // UI Loading state
            if(btn) {
                icon.classList.add('opacity-0');
                spinner.classList.remove('hidden');
                btn.disabled = true;
            }

            let currentIdx = bgCollection.indexOf(appState.currentBgUrl);
            let nextIdx;
            
            if (targetIdx !== -1) {
                nextIdx = targetIdx;
            } else {
                if(currentIdx === -1) currentIdx = 0;
                nextIdx = (currentIdx + 1) % bgCollection.length;
            }

            // Ensure index is valid
            if (nextIdx < 0 || nextIdx >= bgCollection.length) nextIdx = 0;

            const nextUrl = bgCollection[nextIdx];
            
            loadAndSetBackground(nextUrl, true, (success) => {
                if(success) {
                    if(btn) {
                        icon.classList.remove('opacity-0');
                        spinner.classList.add('hidden');
                        btn.disabled = false;
                    }
                } else {
                    console.log("Imatge fallida, provant següent...");
                    // Try next image immediately if failed
                    const retryIdx = (nextIdx + 1) % bgCollection.length;
                    // Prevent infinite recursion if all fail (unlikely)
                    if (retryIdx !== currentIdx) {
                        cycleBackground(retryIdx); 
                    } else {
                        // All failed, reset UI
                        if(btn) {
                            icon.classList.remove('opacity-0');
                            spinner.classList.add('hidden');
                            btn.disabled = false;
                        }
                    }
                }
            });
        }

        function loadAndSetBackground(url, updateState, callback) {
            const img = new Image(); img.crossOrigin = "Anonymous"; img.src = url;
            img.onload = () => {
                document.body.style.backgroundImage = `url('${url}')`;
                if(updateState) { appState.currentBgUrl = url; appState.lastBgUpdate = new Date().toISOString(); saveState(); }
                if(callback) callback(true);
            };
            img.onerror = () => { if(callback) callback(false); };
        }

        // UTILS
        function toggleConfig() { document.getElementById('settings-modal').classList.toggle('hidden'); }
        function resetWidgetPositions() {
            const msg = appState.lang === 'ca' ? "Recuperar widgets?" : (appState.lang === 'es' ? "¿Recuperar widgets?" : "Reset widgets?");
            if(confirm(msg)) {
                Object.keys(appState.widgets).forEach(key => {
                    if (defaultState.widgets[key]) {
                        appState.widgets[key].x = defaultState.widgets[key].x;
                        appState.widgets[key].y = defaultState.widgets[key].y;
                        const el = document.getElementById(`widget-${key}`);
                        if(el) { el.style.left = defaultState.widgets[key].x + 'px'; el.style.top = defaultState.widgets[key].y + 'px'; }
                    }
                });
                saveState(); toggleConfig();
            }
        }
        function factoryReset() {
            const msg = appState.lang === 'ca' ? "S'esborrarà tot." : (appState.lang === 'es' ? "Se borrará todo." : "Everything will be deleted.");
            if(confirm(msg)) { localStorage.removeItem('escriptoriTacStatev22'); location.reload(); }
        }
        function toggleFullScreen() {
            const elem = document.documentElement;
            if (!document.fullscreenElement && !document.mozFullScreenElement) {
                if (elem.requestFullscreen) elem.requestFullscreen().catch(err => console.log(err));
            } else if (document.exitFullscreen) document.exitFullscreen();
        }

        // COMMON FUNCTIONS
        function updateClock() {
            const now = new Date();
            const langCode = appState.lang === 'en' ? 'en-US' : (appState.lang === 'es' ? 'es-ES' : 'ca-ES');
            document.getElementById('clock-time').textContent = now.toLocaleTimeString(langCode, { hour: '2-digit', minute: '2-digit' });
            document.getElementById('clock-date').textContent = now.toLocaleDateString(langCode, { weekday: 'long', day: 'numeric', month: 'long' });
            if(now.getSeconds() === 0) checkDailyBackground();
        }
        function updateAnalogClock() {
            const now = new Date(); const sec = now.getSeconds(); const min = now.getMinutes(); const hour = now.getHours();
            const secDeg = ((sec/60)*360); const minDeg = ((min/60)*360)+((sec/60)*6); const hourDeg = ((hour/12)*360)+((min/60)*30);
            document.getElementById('hand-second').style.transform = `rotate(${secDeg}deg)`;
            document.getElementById('hand-minute').style.transform = `rotate(${minDeg}deg)`;
            document.getElementById('hand-hour').style.transform = `rotate(${hourDeg}deg)`;
        }
        function setTrafficLight(c) {
            appState.widgets.traffic.active = appState.widgets.traffic.active === c ? null : c;
            updateTrafficLightDOM(appState.widgets.traffic.active); saveState();
        }
        function updateTrafficLightDOM(active) {
            ['green','yellow','red'].forEach(c => {
                const el = document.getElementById(`light-${c}`);
                el.className = `w-12 h-12 rounded-full cursor-pointer transition shadow-md ${c==='green'?'bg-green-500':c==='yellow'?'bg-yellow-400':'bg-red-500'} ${active===c ? 'opacity-100 scale-110 ring-4 ring-white/50' : 'opacity-30'}`;
            });
        }
        function toggleTimer() {
            const ts = appState.widgets.timer;
            if (ts.isRunning) { clearInterval(timerInterval); ts.isRunning = false; }
            else {
                if (ts.timeLeft <= 0) return;
                ts.isRunning = true;
                timerInterval = setInterval(() => {
                    ts.timeLeft--; updateTimerDisplay(ts.timeLeft);
                    if (ts.timeLeft <= 0) {
                        clearInterval(timerInterval); ts.isRunning = false; updateTimerControls();
                        playAlarmSound();
                    }
                }, 1000);
            }
            updateTimerControls(); saveState();
        }
        function resetTimer() { clearInterval(timerInterval); appState.widgets.timer.isRunning = false; appState.widgets.timer.timeLeft = appState.widgets.timer.duration * 60; updateTimerDisplay(appState.widgets.timer.timeLeft); updateTimerControls(); saveState(); }
        
        function adjustTimer(delta) {
            let newDuration = appState.widgets.timer.duration + delta;
            if (newDuration < 1) newDuration = 1;
            if (newDuration > 99) newDuration = 99;
            appState.widgets.timer.duration = newDuration;
            resetTimer(); 
        }

        function updateTimerControls() {
            const btn = document.getElementById('timer-btn-toggle');
            btn.innerHTML = appState.widgets.timer.isRunning ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
            btn.className = `w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition text-white ${appState.widgets.timer.isRunning ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-indigo-600 hover:bg-indigo-700'}`;
        }
        function updateTimerDisplay(s) { document.getElementById('timer-display').textContent = `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
        function playAlarmSound() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator(); const g = ctx.createGain();
            osc.connect(g); g.connect(ctx.destination);
            osc.frequency.setValueAtTime(880, ctx.currentTime);
            g.gain.setValueAtTime(0.5, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1);
            osc.start(); osc.stop(ctx.currentTime + 1);
        }
        
        // --- PICKER & ATTENDANCE ---
        function togglePickerSettings() { 
            document.getElementById('picker-checklist').classList.add('hidden');
            document.getElementById('picker-settings').classList.toggle('hidden'); 
        }
        function toggleAttendanceView() {
            document.getElementById('picker-settings').classList.add('hidden');
            const cl = document.getElementById('picker-checklist');
            if(cl.classList.contains('hidden')) { renderChecklist(); cl.classList.remove('hidden'); } else cl.classList.add('hidden');
        }
        function renderChecklist() {
            const c = document.getElementById('checklist-container'); c.innerHTML = '';
            const names = appState.widgets.picker.names.split('\n').filter(n => n.trim());
            const ex = appState.widgets.picker.excluded || [];
            names.forEach((n, i) => {
                const isEx = ex.includes(i);
                const btn = document.createElement('button');
                btn.className = `p-2 rounded-lg text-xs font-bold transition ${isEx ? 'bg-slate-200 text-slate-400' : 'bg-emerald-100 text-emerald-800 border border-emerald-300'}`;
                btn.innerHTML = isEx ? `<i class="fas fa-times mr-1"></i>${n}` : `<i class="fas fa-check mr-1"></i>${n}`;
                btn.onclick = () => {
                    if (isEx) appState.widgets.picker.excluded = ex.filter(idx => idx !== i);
                    else appState.widgets.picker.excluded.push(i);
                    saveState(); renderChecklist();
                };
                c.appendChild(btn);
            });
        }
        function selectAllAttendance(active) { if(active) appState.widgets.picker.excluded = []; saveState(); renderChecklist(); }
        document.getElementById('student-list').addEventListener('input', (e) => { appState.widgets.picker.names = e.target.value; appState.widgets.picker.excluded = []; saveState(); });
        function pickRandomStudent() {
            const all = appState.widgets.picker.names.split('\n').filter(n => n.trim());
            const ex = appState.widgets.picker.excluded || [];
            const avail = all.filter((_, i) => !ex.includes(i));
            const disp = document.getElementById('picker-result');
            const t = translations[appState.lang];
            
            if(!avail.length) { 
                disp.innerText = appState.lang==='ca' ? "Ningú disponible!" : (appState.lang==='es'?"¡Nadie disponible!":"Nobody available!"); 
                return; 
            }
            let i = 0; const int = setInterval(() => {
                disp.innerText = avail[Math.floor(Math.random()*avail.length)];
                i++; if(i > 10) { clearInterval(int); disp.innerText = "🎉 " + avail[Math.floor(Math.random()*avail.length)]; }
            }, 80);
        }

        function generateGroups() {
            const names = appState.widgets.picker.names.split('\n').filter(n => n.trim() !== '');
            const num = parseInt(document.getElementById('group-count').value);
            if (names.length === 0) return;
            for (let i = names.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [names[i], names[j]] = [names[j], names[i]]; }
            const grps = Array.from({ length: num }, () => []);
            names.forEach((n, i) => grps[i % num].push(n));
            const c = document.getElementById('groups-result'); c.innerHTML = '';
            const t_grp = appState.lang==='ca'?"Grup": (appState.lang==='es'?"Grupo":"Group");
            grps.forEach((g, i) => {
                const d = document.createElement('div'); d.className = "bg-white/50 rounded-lg p-2 shadow-sm border border-white/60 text-slate-800";
                d.innerHTML = `<div class="text-xs font-black uppercase text-teal-700 border-b border-teal-200 mb-1 pb-1">${t_grp} ${i+1}</div><ul class="text-sm font-bold">${g.map(n=>`<li>${n}</li>`).join('')}</ul>`;
                c.appendChild(d);
            });
        }

        async function toggleMicrophone() {
            const btn = document.getElementById('btn-mic-toggle');
            if (microphoneStream) {
                microphoneStream.getTracks().forEach(t => t.stop()); microphoneStream = null; clearInterval(noiseInterval);
                document.getElementById('noise-level-bar').style.height = '0%';
                const t = translations[appState.lang];
                btn.innerHTML = `<i class="fas fa-microphone mr-2"></i>${t.activate}`; 
                btn.classList.replace('bg-red-500','bg-indigo-600');
            } else {
                try {
                    microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioContext = new (window.AudioContext||window.webkitAudioContext)();
                    const src = audioContext.createMediaStreamSource(microphoneStream);
                    const an = audioContext.createAnalyser(); an.fftSize = 256; src.connect(an);
                    const buf = an.frequencyBinCount; const data = new Uint8Array(buf);
                    const t = translations[appState.lang];
                    btn.innerHTML = `<i class="fas fa-stop mr-2"></i>${t.stop}`; 
                    btn.classList.replace('bg-indigo-600','bg-red-500');
                    noiseInterval = setInterval(() => {
                        an.getByteFrequencyData(data);
                        let sum = 0; for(let i=0; i<buf; i++) sum += data[i];
                        const pct = Math.min((sum/buf/150)*100, 100);
                        const bar = document.getElementById('noise-level-bar'); bar.style.height = `${pct}%`;
                        bar.className = `absolute bottom-0 w-full transition-all duration-100 ease-out ${pct>60?'bg-red-500':pct>30?'bg-yellow-400':'bg-green-400'}`;
                    }, 100);
                } catch (e) { alert("Error micròfon."); }
            }
        }

        // TODO LIST
        function addTodo() { const i = document.getElementById('todo-input'); if(i.value.trim()){ appState.widgets.todo.tasks.push({text:i.value, done:false}); i.value=''; renderTodoList(); saveState(); } }
        function toggleTodo(i) { appState.widgets.todo.tasks[i].done = !appState.widgets.todo.tasks[i].done; renderTodoList(); saveState(); }
        function removeTodo(i) { appState.widgets.todo.tasks.splice(i,1); renderTodoList(); saveState(); }
        function renderTodoList() {
            const l = document.getElementById('todo-list'); l.innerHTML = '';
            appState.widgets.todo.tasks.forEach((t, i) => {
                const d = document.createElement('div'); d.className = "flex items-center gap-2 bg-white/40 p-2 rounded-lg group hover:bg-white/60 transition";
                d.innerHTML = `<input type="checkbox" ${t.done?'checked':''} class="w-5 h-5 accent-emerald-500 rounded cursor-pointer" onclick="toggleTodo(${i})">
                <span class="flex-1 font-bold text-slate-700 text-sm ${t.done?'line-through opacity-50':''}">${t.text}</span>
                <button onclick="removeTodo(${i})" class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 px-2"><i class="fas fa-trash"></i></button>`;
                l.appendChild(d);
            });
        }
        function generateDailyTimetable() {
            const slots = ["9:00 - 10:00", "10:00 - 11:00", "11:00 - 11:30 (Pati)", "11:30 - 12:30", "12:30 - 15:00 (Menjador)", "15:00 - 16:30"];
            return slots.map(s => {
                const bg = (s.includes('Pati')||s.includes('Menjador')) ? 'bg-slate-400/40' : 'bg-white/20';
                return `<tr class="border-b border-slate-300/50"><td class="font-bold text-slate-600 text-xs p-2 bg-white/40" contenteditable="true">${s}</td><td class="${bg} p-2 hover:bg-white/60 transition" contenteditable="true"></td></tr>`;
            }).join('');
        }
        document.getElementById('timetable-body').addEventListener('input', function() { appState.widgets.timetable.content = this.innerHTML; saveState(); });

        window.onload = loadState;
    </script>
</body>
</html>