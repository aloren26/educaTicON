<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escriptori Digital Docent 1.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@700,900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;700&family=Patrick+Hand&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* GLOBAL STYLES */
        body { font-family: 'Satoshi', sans-serif; font-weight: 700; background-color: #333; background-size: cover; background-position: center; background-attachment: fixed; transition: background-image 0.5s ease-in-out, background-color 0.5s ease; overflow: hidden; background-repeat: no-repeat; }
        input, textarea, button, select, h1, h2, h3, span, div, p, li, td, th { font-family: inherit; }
        .font-hand { font-family: 'Patrick Hand', cursive; font-weight: 400; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        .font-serif { font-family: 'Merriweather', serif; }
        
        /* GLASSMORPHISM */
        .glass-base { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); }
        .glass-dark { background: rgba(30, 41, 59, 0.90); backdrop-filter: blur(16px); color: white; border: 1px solid rgba(255, 255, 255, 0.1); }

        /* WIDGETS */
        .widget { position: absolute; display: flex; flex-direction: column; overflow: hidden; min-width: 200px; min-height: 150px; resize: both; transition: background-color 0.3s ease, box-shadow 0.3s ease, color 0.3s ease; }
        .widget::-webkit-resizer { background-color: transparent; background-image: linear-gradient(135deg, transparent 50%, rgba(0,0,0,0.2) 50%); background-size: 12px 12px; background-repeat: no-repeat; background-position: bottom right; }
        .widget-header { cursor: grab; user-select: none; }
        .widget-header:active { cursor: grabbing; }
        .hidden-widget { display: none !important; }

        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.4); }
        ::-webkit-scrollbar-corner { background: transparent; }

        /* COLORS */
        .color-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(255,255,255,0.8); transition: transform 0.1s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .color-dot:hover { transform: scale(1.2); z-index: 10; }

        /* ANIMATIONS */
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(15deg); } 50% { transform: rotate(-15deg); } 75% { transform: rotate(5deg); } 100% { transform: rotate(0deg); } }
        .animate-shake { animation: shake 0.5s ease-in-out; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .animate-pop { animation: pop 0.2s ease-out; }

        /* DOCK MENU */
        .dock-container { transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .dock-hidden { transform: translateY(200%); pointer-events: none; }
        .dock-category { position: relative; }
        .dock-category:hover .dock-submenu { display: flex; animation: fadeInUp 0.2s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px) translateX(-50%); } to { opacity: 1; transform: translateY(0) translateX(-50%); } }
        .dock-submenu { bottom: 100%; left: 50%; transform: translateX(-50%); margin-bottom: 15px; padding-bottom: 10px; }
        .dock-submenu::after { content: ''; position: absolute; bottom: -20px; left: 0; width: 100%; height: 30px; background: transparent; z-index: -1; }

        /* CLOCK FACE */
        .clock-face { background: rgba(255, 255, 255, 0.95); border: 6px solid #334155; box-shadow: inset 0 0 15px rgba(0,0,0,0.1), 0 10px 25px rgba(0,0,0,0.2); }
        .clock-hand { position: absolute; bottom: 50%; left: 50%; transform-origin: bottom center; border-radius: 999px; z-index: 10; }
        
        /* MODAL STYLES */
        .advantage-card { background: rgba(255,255,255,0.6); border-radius: 12px; padding: 10px; border-left: 4px solid #4f46e5; }
        .update-badge { background: #dcfce7; color: #166534; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 900; text-transform: uppercase; margin-left: 5px; }

        /* ICON PICKER */
        .icon-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; max-height: 300px; overflow-y: auto; }
        .icon-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 6px; border-radius: 8px; background: rgba(255,255,255,0.5); cursor: pointer; transition: all 0.2s; border: 1px solid rgba(0,0,0,0.05); }
        .icon-btn:hover { background: rgba(255,255,255,0.9); transform: scale(1.05); border-color: #6366f1; }
        .icon-btn i { font-size: 1.2rem; margin-bottom: 2px; color: #334155; }
        .icon-btn span { font-size: 0.55rem; text-transform: uppercase; font-weight: 900; color: #64748b; text-align: center; line-height: 1; }
        .icon-category-title { grid-column: 1 / -1; font-size: 0.65rem; text-transform: uppercase; color: #6366f1; margin-top: 8px; margin-bottom: 2px; border-bottom: 1px solid #e2e8f0; padding-bottom: 2px; }
        
        /* Language Switcher */
        .lang-btn { font-size: 0.7rem; font-weight: 900; opacity: 0.7; transition: opacity 0.2s; }
        .lang-btn:hover, .lang-btn.active { opacity: 1; text-decoration: underline; color: #4f46e5; }

        /* Background Thumbnails */
        .bg-thumb { height: 80px; width: 100%; object-fit: cover; border-radius: 8px; cursor: pointer; transition: transform 0.2s; border: 2px solid transparent; }
        .bg-thumb:hover { transform: scale(1.05); }
        .bg-thumb.active { border-color: #4f46e5; transform: scale(0.95); }
        .solid-color-btn { height: 50px; width: 100%; border-radius: 8px; cursor: pointer; border: 2px solid rgba(0,0,0,0.1); }

        /* TABLES */
        .editable-table td, .editable-table th { border: 1px solid rgba(0,0,0,0.1); padding: 8px; }
        .editable-table td:focus { background-color: rgba(255, 255, 255, 0.9); outline: 2px solid #6366f1; border-radius: 4px; }
        [contenteditable="true"]:focus { outline: none; border-bottom: 2px solid #6366f1; }
        .week-table th { background-color: rgba(255,255,255,0.3); text-align: center; font-size: 0.7rem; text-transform: uppercase; color: #475569; }
        .week-table td { text-align: center; font-size: 0.8rem; height: 40px; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col text-slate-800 relative">

    <div class="fixed top-4 right-4 z-50 flex gap-2 items-center" style="transform: scale(0.7); transform-origin: top right;">
        <div class="glass-base bg-white/75 p-3 rounded-full flex gap-2 mr-2">
            <button onclick="setLanguage('ca')" class="lang-btn" id="lang-ca">CAT</button>
            <span class="text-slate-300 text-xs">|</span>
            <button onclick="setLanguage('es')" class="lang-btn" id="lang-es">CAST</button>
            <span class="text-slate-300 text-xs">|</span>
            <button onclick="setLanguage('en')" class="lang-btn" id="lang-en">ENG</button>
        </div>
        <button id="btn-bg-modal" onclick="toggleBgModal()" class="glass-base bg-white/75 p-3 rounded-full hover:bg-white transition relative" title="Fons de Pantalla"><i class="fas fa-image"></i></button>
        <button onclick="toggleFullScreen()" class="glass-base bg-white/75 p-3 rounded-full hover:bg-white transition" title="Pantalla Completa"><i class="fas fa-expand"></i></button>
        <button onclick="toggleConfig()" class="glass-base bg-white/75 p-3 rounded-full hover:bg-white transition" title="Configuració"><i class="fas fa-cog"></i></button>
    </div>

    <main id="app-container" class="w-full h-full relative pt-10">
        <div id="widget-clock" class="widget glass-base hidden-widget group rounded-3xl" style="top: 150px; left: 50px; width: 300px; height: 180px;">
            <div class="widget-header absolute inset-x-0 top-0 h-10 flex justify-end items-center px-2 opacity-0 group-hover:opacity-100 transition z-20 gap-2">
                <button onclick="toggleColorMenu('clock')" class="text-slate-400 hover:text-indigo-600 bg-white/50 p-1 rounded-full w-8 h-8"><i class="fas fa-palette"></i></button>
                <button onclick="closeWidget('clock')" class="text-slate-400 hover:text-red-500 bg-white/50 p-1 rounded-full w-8 h-8"><i class="fas fa-times"></i></button>
            </div>
            <div id="colors-clock" class="hidden absolute top-10 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex flex-col items-center justify-center h-full w-full pointer-events-none"> 
                <div id="clock-time" class="text-6xl font-black tracking-tighter select-none">00:00</div>
                <div id="clock-date" class="text-lg opacity-80 mt-2 uppercase tracking-widest font-black select-none text-center">Data</div>
            </div>
        </div>

        <div id="widget-analog" class="widget glass-base hidden-widget group rounded-3xl" style="top: 150px; left: 360px; width: 280px; height: 320px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70" data-i18n="analog_title"><i class="far fa-clock mr-2"></i>Analògic</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('analog')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('analog')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-analog" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex-grow flex items-center justify-center p-4">
                <div class="clock-face relative w-48 h-48 rounded-full">
                    <div class="absolute inset-0 flex items-center justify-center font-black text-slate-500 text-sm">
                        <span class="absolute" style="transform: rotate(0deg) translateY(-80px);">12</span><span class="absolute" style="transform: rotate(90deg) translateY(-80px) rotate(-90deg);">3</span><span class="absolute" style="transform: rotate(180deg) translateY(-80px) rotate(-180deg);">6</span><span class="absolute" style="transform: rotate(270deg) translateY(-80px) rotate(-270deg);">9</span>
                    </div>
                    <div id="hand-hour" class="clock-hand w-2 h-12 bg-slate-800 rounded-full" style="margin-left: -4px;"></div>
                    <div id="hand-minute" class="clock-hand w-1.5 h-16 bg-slate-600 rounded-full" style="margin-left: -3px;"></div>
                    <div id="hand-second" class="clock-hand w-0.5 h-20 bg-red-500 rounded-full" style="margin-left: -1px;"></div>
                    <div class="absolute inset-0 m-auto w-4 h-4 bg-slate-800 rounded-full z-20 border-2 border-white"></div>
                </div>
            </div>
        </div>

        <div id="widget-traffic" class="widget glass-base hidden-widget group rounded-3xl" style="top: 150px; left: 400px; width: 140px; height: 320px;">
            <div class="widget-header w-full p-2 flex justify-between items-center bg-white/20">
                <i class="fas fa-traffic-light opacity-70 ml-2"></i>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('traffic')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('traffic')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-traffic" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex-grow flex items-center justify-center p-4">
                <div class="bg-slate-800 p-4 rounded-full flex flex-col gap-4 shadow-inner">
                    <div id="light-red" onclick="setTrafficLight('red')" class="w-12 h-12 rounded-full bg-red-500 opacity-30 cursor-pointer hover:opacity-100 transition shadow-[0_0_20px_rgba(239,68,68,0.5)]"></div>
                    <div id="light-yellow" onclick="setTrafficLight('yellow')" class="w-12 h-12 rounded-full bg-yellow-400 opacity-30 cursor-pointer hover:opacity-100 transition shadow-[0_0_20px_rgba(250,204,21,0.5)]"></div>
                    <div id="light-green" onclick="setTrafficLight('green')" class="w-12 h-12 rounded-full bg-green-500 opacity-30 cursor-pointer hover:opacity-100 transition shadow-[0_0_20px_rgba(34,197,94,0.5)]"></div>
                </div>
            </div>
        </div>

        <div id="widget-notes" class="widget glass-base hidden-widget group rounded-3xl" style="top: 400px; left: 50px; width: 300px; height: 300px;">
            <div class="widget-header px-4 py-2 flex justify-between items-center cursor-move bg-white/20 rounded-t-3xl">
                <span class="text-xs font-black uppercase opacity-70" data-i18n="notes_title"><i class="fas fa-sticky-note mr-2"></i>Notes</span>
                <div class="flex items-center gap-2">
                    <button onclick="toggleColorMenu('notes')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('notes')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-notes" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <textarea id="notes-area" class="w-full h-full bg-transparent p-4 rounded-b-3xl resize-none focus:outline-none font-bold text-lg placeholder-black/30" placeholder="Escriu notes..."></textarea>
        </div>

        <div id="widget-timer" class="widget glass-base hidden-widget group rounded-3xl" style="top: 400px; left: 400px; width: 300px; height: 260px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70 tracking-wider" data-i18n="timer_title"><i class="fas fa-hourglass-half mr-2"></i>Temporitzador</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('timer')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('timer')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-timer" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex-grow flex flex-col items-center justify-center p-4">
                <div id="timer-display" class="text-6xl font-black mb-4 tracking-wider font-mono">05:00</div>
                <div class="flex gap-4 mb-4">
                    <button onclick="toggleTimer()" id="timer-btn-toggle" class="bg-indigo-600 text-white w-14 h-14 rounded-full flex items-center justify-center hover:bg-indigo-700 shadow-lg transition text-xl"><i class="fas fa-play" id="timer-icon-toggle"></i></button>
                    <button onclick="resetTimer()" class="bg-slate-200 text-slate-600 w-14 h-14 rounded-full flex items-center justify-center hover:bg-slate-300 shadow transition text-xl"><i class="fas fa-redo"></i></button>
                </div>
                <div class="flex items-center justify-center gap-8 opacity-80 mb-2">
                    <button onclick="adjustTimer(-1)" class="w-10 h-10 rounded-full bg-white/30 hover:bg-white/60 flex items-center justify-center transition text-lg font-bold"><i class="fas fa-chevron-down"></i></button>
                    <button onclick="adjustTimer(1)" class="w-10 h-10 rounded-full bg-white/30 hover:bg-white/60 flex items-center justify-center transition text-lg font-bold"><i class="fas fa-chevron-up"></i></button>
                </div>
            </div>
        </div>

        <div id="widget-picker" class="widget glass-base hidden-widget group rounded-3xl" style="top: 150px; left: 700px; width: 300px; height: 250px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70" data-i18n="picker_title"><i class="fas fa-hand-pointer mr-2"></i>Selector</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('picker')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('picker')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-picker" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex flex-col p-4 h-full relative">
                <div id="picker-result" class="flex-grow flex items-center justify-center text-3xl font-black text-indigo-600 text-center mb-2 leading-tight bg-white/40 rounded-xl m-2" data-i18n="who_will_be">Qui serà?</div>
                <div class="flex gap-2 mt-auto z-10">
                    <button onclick="pickRandomStudent()" class="flex-1 bg-indigo-600 text-white py-2 rounded-xl hover:bg-indigo-700 shadow-lg font-bold uppercase tracking-wide" data-i18n="pick">Triar</button>
                    <button onclick="toggleAttendanceView()" class="bg-blue-200 text-blue-700 px-3 rounded-xl hover:bg-blue-300" title="Assistència"><i class="fas fa-user-check"></i></button>
                    <button onclick="togglePickerSettings()" class="bg-slate-200 text-slate-600 px-3 rounded-xl hover:bg-slate-300" title="Editar Llista"><i class="fas fa-list"></i></button>
                </div>
                <div id="picker-settings" class="hidden absolute inset-0 bg-white/95 z-20 p-4 flex flex-col rounded-3xl text-slate-800">
                    <label class="text-xs text-slate-500 mb-1 font-bold" data-i18n="list_label">Noms (un per línia):</label>
                    <textarea id="student-list" class="flex-grow bg-slate-50 border rounded p-2 text-sm focus:outline-none font-bold placeholder-slate-300"></textarea>
                    <button onclick="togglePickerSettings()" class="mt-2 bg-slate-200 text-xs py-2 rounded font-bold hover:bg-slate-300" data-i18n="close">Tancar</button>
                </div>
                <div id="picker-checklist" class="hidden absolute inset-0 bg-white/95 z-20 p-4 flex flex-col rounded-3xl text-slate-800">
                    <div class="flex justify-between items-center mb-2 border-b pb-2">
                        <span class="text-xs font-bold text-slate-500" data-i18n="who_is_here">Qui hi és avui?</span>
                        <button onclick="selectAllAttendance(true)" class="text-[10px] text-indigo-600 font-bold uppercase" data-i18n="all">Tots</button>
                    </div>
                    <div id="checklist-container" class="flex-grow overflow-y-auto content-start grid grid-cols-2 gap-2"></div>
                    <button onclick="toggleAttendanceView()" class="mt-2 bg-indigo-600 text-white text-xs py-2 rounded font-bold hover:bg-indigo-700" data-i18n="done">Fet</button>
                </div>
            </div>
        </div>

        <div id="widget-groups" class="widget glass-base hidden-widget group rounded-3xl" style="top: 150px; left: 100px; width: 400px; height: 400px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70" data-i18n="groups_title"><i class="fas fa-users mr-2"></i>Equips</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('groups')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('groups')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-groups" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex flex-col p-4 h-full overflow-hidden">
                <div class="flex gap-2 items-center mb-4 bg-white/40 p-2 rounded-lg">
                    <label class="text-xs font-bold opacity-70 uppercase" data-i18n="groups_label">Grups:</label>
                    <input type="number" id="group-count" value="4" min="2" max="10" class="w-12 p-1 text-center rounded border border-slate-300 font-bold text-slate-800">
                    <button onclick="generateGroups()" class="flex-1 bg-teal-500 text-white py-1 px-3 rounded hover:bg-teal-600 transition font-bold text-sm uppercase" data-i18n="generate">Generar</button>
                </div>
                <div id="groups-result" class="flex-grow overflow-y-auto grid grid-cols-2 gap-2 content-start">
                    <div class="col-span-2 text-center opacity-60 text-sm mt-10 font-bold" data-i18n="groups_help">Indica quants grups i clica "Generar".</div>
                </div>
            </div>
        </div>

        <div id="widget-timetable" class="widget glass-base hidden-widget group flex flex-col rounded-3xl" style="top: 150px; left: 50%; width: 450px; height: 500px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl cursor-move">
                <div class="flex items-center gap-2">
                    <i class="far fa-calendar-alt opacity-70"></i>
                    <h3 id="timetable-title" contenteditable="true" class="text-xs font-black uppercase opacity-70 border-b border-transparent hover:border-white/50" data-i18n="timetable_title">Horari d'Aula</h3>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="toggleIconPicker('timetable')" class="opacity-70 hover:opacity-100" title="Icones"><i class="fas fa-tag"></i></button>
                    <button onclick="toggleColorMenu('timetable')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('timetable')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            
            <div id="timetable-icons" class="hidden absolute top-10 left-2 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 border border-slate-200">
                <div class="icon-grid" id="icon-picker-content"></div>
                <div class="mt-2 text-[10px] text-center text-slate-400 font-bold border-t pt-1" data-i18n="icon_help">Clica una icona per inserir-la</div>
            </div>

            <div id="colors-timetable" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex-grow overflow-y-auto p-4 flex flex-col relative custom-scroll">
                <table class="w-full text-left border-collapse editable-table mb-8">
                    <thead><tr class="text-sm opacity-70 border-b border-black/10"><th class="p-2 w-24 font-black uppercase text-xs" data-i18n="time_col">Hora</th><th class="p-2 font-black uppercase text-xs" data-i18n="activity_col">Activitat</th></tr></thead>
                    <tbody id="timetable-body" class="font-bold text-lg"></tbody>
                </table>
                <div class="absolute bottom-2 right-2 flex gap-2 opacity-50 hover:opacity-100 transition z-10 bg-white/20 p-1 rounded-full">
                     <button onclick="removeTimetableRow()" class="bg-red-200 text-red-700 w-6 h-6 rounded flex items-center justify-center hover:bg-red-300 font-bold">-</button>
                     <button onclick="addTimetableRow()" class="bg-emerald-200 text-emerald-700 w-6 h-6 rounded flex items-center justify-center hover:bg-emerald-300 font-bold">+</button>
                </div>
            </div>
        </div>

        <div id="widget-week" class="widget glass-base hidden-widget group flex flex-col rounded-3xl" style="top: 100px; left: 100px; width: 800px; height: 500px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl cursor-move">
                <div class="flex items-center gap-2">
                    <i class="fas fa-calendar-week opacity-70"></i>
                    <h3 id="week-title" contenteditable="true" class="text-xs font-black uppercase opacity-70 border-b border-transparent hover:border-white/50" data-i18n="week_title">Horari Setmanal</h3>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="toggleIconPicker('week')" class="opacity-70 hover:opacity-100" title="Icones"><i class="fas fa-tag"></i></button>
                    <button onclick="toggleColorMenu('week')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('week')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            
            <div id="week-icons" class="hidden absolute top-10 left-2 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 border border-slate-200">
                 <div class="icon-grid" id="week-icons-content"></div>
                <div class="mt-2 text-[10px] text-center text-slate-400 font-bold border-t pt-1" data-i18n="icon_help">Clica una icona per inserir-la</div>
            </div>
            
            <div id="colors-week" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            
            <div class="flex-grow overflow-auto p-2 flex flex-col relative custom-scroll">
                <table class="w-full text-left border-collapse editable-table week-table mb-8">
                    <thead><tr class="text-sm border-b border-black/10"><th class="w-16">H</th><th data-i18n="day_mon">DL</th><th data-i18n="day_tue">DT</th><th data-i18n="day_wed">DC</th><th data-i18n="day_thu">DJ</th><th data-i18n="day_fri">DV</th></tr></thead>
                    <tbody id="week-body" class="font-bold text-sm"></tbody>
                </table>
                <div class="absolute bottom-2 right-2 flex gap-2 opacity-50 hover:opacity-100 transition z-10 bg-white/20 p-1 rounded-full">
                     <button onclick="removeWeekRow()" class="bg-red-200 text-red-700 w-6 h-6 rounded flex items-center justify-center hover:bg-red-300 font-bold">-</button>
                     <button onclick="addWeekRow()" class="bg-emerald-200 text-emerald-700 w-6 h-6 rounded flex items-center justify-center hover:bg-emerald-300 font-bold">+</button>
                </div>
            </div>
        </div>

        <div id="widget-noise" class="widget glass-base hidden-widget group rounded-3xl" style="top: 200px; left: 200px; width: 200px; height: 350px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70" data-i18n="noise_title"><i class="fas fa-microphone-lines mr-2"></i>Soroll</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('noise')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('noise')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-noise" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex flex-col items-center justify-center p-4 h-full gap-4">
                <div class="relative w-12 h-48 bg-slate-200/50 rounded-full overflow-hidden border border-white/50 shadow-inner">
                    <div id="noise-level-bar" class="absolute bottom-0 w-full bg-green-400 transition-all duration-100 ease-out" style="height: 0%;"></div>
                </div>
                <button id="btn-mic-toggle" onclick="toggleMicrophone()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl shadow font-bold text-sm hover:bg-indigo-700 transition w-full uppercase tracking-wider"><i class="fas fa-microphone mr-2"></i><span data-i18n="activate">Activar</span></button>
            </div>
        </div>

        <div id="widget-todo" class="widget glass-base hidden-widget group rounded-3xl" style="top: 250px; left: 600px; width: 300px; height: 400px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70" data-i18n="todo_title"><i class="fas fa-list-check mr-2"></i>Tasques</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('todo')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('todo')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-todo" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex flex-col p-4 h-full">
                <div class="flex gap-2 mb-4">
                    <input type="text" id="todo-input" placeholder="Nova tasca..." class="flex-1 bg-white/50 border-none rounded-lg px-3 py-2 text-sm font-bold focus:ring-2 focus:ring-indigo-400 placeholder-black/30 text-slate-800" onkeypress="if(event.key === 'Enter') addTodo()">
                    <button onclick="addTodo()" class="bg-indigo-600 text-white w-10 h-10 rounded-lg shadow hover:bg-indigo-700 font-bold text-lg flex items-center justify-center transition">+</button>
                </div>
                <div id="todo-list" class="flex-grow overflow-y-auto space-y-2 pr-1"></div>
            </div>
        </div>

        <div id="widget-qr" class="widget glass-base hidden-widget group rounded-3xl" style="top: 200px; left: 100px; width: 280px; height: 380px;">
             <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70" data-i18n="qr_title"><i class="fas fa-qrcode mr-2"></i>Codi QR</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('qr')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('qr')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-qr" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex flex-col items-center p-4 gap-4 h-full">
                <div id="qrcode" class="bg-white p-2 rounded-xl shadow-inner w-[200px] h-[200px] flex items-center justify-center">
                    <span class="text-slate-300 text-xs font-bold text-center" data-i18n="qr_help">Introdueix URL i genera</span>
                </div>
                <input type="text" id="qr-input" placeholder="https://..." class="w-full bg-white/50 border-none rounded-lg px-3 py-2 text-sm font-bold focus:ring-2 focus:ring-indigo-400 text-slate-800">
                <button onclick="generateQR()" class="w-full bg-slate-800 text-white py-2 rounded-lg font-bold hover:bg-black transition uppercase text-xs tracking-wider" data-i18n="generate_code">Generar Codi</button>
            </div>
        </div>

        <div id="widget-dice" class="widget glass-base hidden-widget group rounded-3xl" style="top: 300px; left: 500px; width: 300px; height: 250px;">
             <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70" data-i18n="dice_title"><i class="fas fa-cubes mr-2"></i>Daus</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('dice')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('dice')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-dice" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex flex-col items-center justify-center p-4 h-full gap-4">
                <div id="dice-container" class="flex justify-center gap-4 text-6xl opacity-80 h-20 items-center"><i class="fas fa-dice-one"></i></div>
                <div class="flex gap-2">
                    <button onclick="setDiceCount(1)" class="w-8 h-8 rounded bg-white/40 hover:bg-white font-bold text-sm text-slate-800">1</button>
                    <button onclick="setDiceCount(2)" class="w-8 h-8 rounded bg-white/40 hover:bg-white font-bold text-sm text-slate-800">2</button>
                    <button onclick="setDiceCount(3)" class="w-8 h-8 rounded bg-white/40 hover:bg-white font-bold text-sm text-slate-800">3</button>
                </div>
                <button onclick="rollDice()" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700 transition uppercase text-xs tracking-wider" data-i18n="roll">Llançar</button>
            </div>
        </div>

        <div id="widget-symbols" class="widget glass-base hidden-widget group rounded-3xl" style="top: 250px; left: 300px; width: 320px; height: 320px;">
             <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70" data-i18n="symbols_title"><i class="fas fa-eye mr-2"></i>Mode de Treball</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('symbols')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('symbols')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-symbols" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex flex-col items-center justify-center p-6 h-full gap-6">
                <div id="symbol-display" class="flex flex-col items-center gap-2 transition-all duration-300">
                    <i class="fas fa-comment-slash text-8xl opacity-80"></i>
                    <span class="text-2xl font-black uppercase tracking-widest mt-4" id="symbol-text">Silenci</span>
                </div>
                <div class="grid grid-cols-4 gap-2 w-full mt-auto">
                    <button onclick="setSymbol('silence')" class="p-2 rounded-lg bg-red-100 hover:bg-red-200 text-red-600 flex justify-center" title="Silenci"><i class="fas fa-comment-slash"></i></button>
                    <button onclick="setSymbol('whisper')" class="p-2 rounded-lg bg-yellow-100 hover:bg-yellow-200 text-yellow-600 flex justify-center" title="Parelles"><i class="fas fa-user-friends"></i></button>
                    <button onclick="setSymbol('group')" class="p-2 rounded-lg bg-green-100 hover:bg-green-200 text-green-600 flex justify-center" title="Grup"><i class="fas fa-users"></i></button>
                    <button onclick="setSymbol('ask')" class="p-2 rounded-lg bg-blue-100 hover:bg-blue-200 text-blue-600 flex justify-center" title="Pregunta"><i class="fas fa-hand-paper"></i></button>
                </div>
            </div>
        </div>

        <div id="widget-links" class="widget glass-base hidden-widget group rounded-3xl" style="top: 150px; left: 800px; width: 300px; height: 350px;">
             <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70" data-i18n="links_title"><i class="fas fa-link mr-2"></i>Enllaços</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('links')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('links')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-links" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            <div class="flex flex-col p-4 h-full">
                <div id="links-container" class="grid grid-cols-3 gap-3 flex-grow content-start"></div>
                <button onclick="addNewLink()" class="mt-4 w-full bg-slate-200 text-slate-600 py-2 rounded-lg font-bold hover:bg-slate-300 transition text-sm" data-i18n="add_web"><i class="fas fa-plus mr-2"></i>Afegir Web</button>
            </div>
        </div>

        <div id="widget-scoreboard" class="widget glass-base hidden-widget group rounded-3xl" style="top: 150px; left: 400px; width: 450px; height: 280px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase opacity-70" data-i18n="score_title"><i class="fas fa-trophy mr-2"></i>Marcador</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('scoreboard')" class="opacity-70 hover:opacity-100"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('scoreboard')" class="opacity-70 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-scoreboard" class="hidden absolute top-8 right-2 bg-white/95 p-3 rounded-2xl shadow-xl z-30 grid grid-cols-5 gap-2 border border-slate-200 w-[180px]"></div>
            
            <div class="flex-grow p-4 grid grid-cols-2 gap-4 h-full">
                <div class="flex flex-col rounded-2xl relative transition-colors duration-300 shadow-inner group-team" id="team-a-container">
                    <button onclick="toggleTeamConfig('A')" class="absolute top-2 right-2 text-white/50 hover:text-white transition z-10"><i class="fas fa-cog"></i></button>
                    <div id="config-a" class="hidden absolute top-8 right-2 bg-white/95 p-2 rounded-xl shadow-xl z-20 w-[120px] grid grid-cols-3 gap-1">
                        <button onclick="setTeamColor('A', 'bg-blue-500')" class="w-6 h-6 rounded-full bg-blue-500"></button>
                        <button onclick="setTeamColor('A', 'bg-red-500')" class="w-6 h-6 rounded-full bg-red-500"></button>
                        <button onclick="setTeamColor('A', 'bg-green-500')" class="w-6 h-6 rounded-full bg-green-500"></button>
                        <button onclick="setTeamColor('A', 'bg-yellow-500')" class="w-6 h-6 rounded-full bg-yellow-500"></button>
                        <button onclick="setTeamColor('A', 'bg-purple-500')" class="w-6 h-6 rounded-full bg-purple-500"></button>
                        <button onclick="setTeamColor('A', 'bg-slate-700')" class="w-6 h-6 rounded-full bg-slate-700"></button>
                    </div>
                    <div class="flex-grow flex flex-col items-center justify-center pt-4">
                        <input type="text" id="name-a" placeholder="Escriu aquí..." class="bg-transparent text-center text-white font-bold text-lg placeholder-white/50 focus:outline-none w-full px-2 mb-2">
                        <div id="score-a" class="text-7xl font-black text-white my-2">0</div>
                    </div>
                    <div class="flex h-14 mt-auto border-t border-white/20">
                        <button onclick="changeScore('A', -1)" class="flex-1 text-white hover:bg-white/20 rounded-bl-2xl font-black text-2xl">-</button>
                        <div class="w-px bg-white/20"></div>
                        <button onclick="changeScore('A', 1)" class="flex-1 text-white hover:bg-white/20 rounded-br-2xl font-black text-2xl">+</button>
                    </div>
                </div>

                <div class="flex flex-col rounded-2xl relative transition-colors duration-300 shadow-inner group-team" id="team-b-container">
                    <button onclick="toggleTeamConfig('B')" class="absolute top-2 right-2 text-white/50 hover:text-white transition z-10"><i class="fas fa-cog"></i></button>
                    <div id="config-b" class="hidden absolute top-8 right-2 bg-white/95 p-2 rounded-xl shadow-xl z-20 w-[120px] grid grid-cols-3 gap-1">
                        <button onclick="setTeamColor('B', 'bg-blue-500')" class="w-6 h-6 rounded-full bg-blue-500"></button>
                        <button onclick="setTeamColor('B', 'bg-red-500')" class="w-6 h-6 rounded-full bg-red-500"></button>
                        <button onclick="setTeamColor('B', 'bg-green-500')" class="w-6 h-6 rounded-full bg-green-500"></button>
                        <button onclick="setTeamColor('B', 'bg-yellow-500')" class="w-6 h-6 rounded-full bg-yellow-500"></button>
                        <button onclick="setTeamColor('B', 'bg-purple-500')" class="w-6 h-6 rounded-full bg-purple-500"></button>
                        <button onclick="setTeamColor('B', 'bg-slate-700')" class="w-6 h-6 rounded-full bg-slate-700"></button>
                    </div>
                    <div class="flex-grow flex flex-col items-center justify-center pt-4">
                        <input type="text" id="name-b" placeholder="Escriu aquí..." class="bg-transparent text-center text-white font-bold text-lg placeholder-white/50 focus:outline-none w-full px-2 mb-2">
                        <div id="score-b" class="text-7xl font-black text-white my-2">0</div>
                    </div>
                    <div class="flex h-14 mt-auto border-t border-white/20">
                        <button onclick="changeScore('B', -1)" class="flex-1 text-white hover:bg-white/20 rounded-bl-2xl font-black text-2xl">-</button>
                        <div class="w-px bg-white/20"></div>
                        <button onclick="changeScore('B', 1)" class="flex-1 text-white hover:bg-white/20 rounded-br-2xl font-black text-2xl">+</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div class="fixed bottom-2 right-4 z-0 text-right pointer-events-none select-none text-white/50 font-bold">
        <div class="text-[10px]" data-i18n="credits_name">Creat per Alfonso LM</div>
    </div>

    <div class="fixed bottom-0 inset-x-0 z-40 flex justify-center pointer-events-none pb-6">
        
        <div class="fixed bottom-8 right-4 z-50 flex gap-2 items-center pointer-events-auto">
             <button id="dock-trigger" onclick="toggleDock()" class="hidden glass-dark rounded-full w-12 h-12 flex items-center justify-center shadow-2xl hover:scale-110 transition">
                <i class="fas fa-bars text-white text-xl"></i>
            </button>
        </div>

        <div id="dock-container" class="pointer-events-auto glass-dark rounded-full px-4 py-2 flex gap-4 shadow-2xl items-center relative dock-container">
            
            <button onclick="toggleDock()" class="text-white bg-black/40 hover:bg-black/80 backdrop-blur-sm rounded-full transition absolute -left-10 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center shadow-lg border border-white/10" title="Amagar menú">
                <i class="fas fa-chevron-down"></i>
            </button>

            <div class="relative group dock-category">
                <button class="flex flex-col items-center text-slate-300 group-hover:text-white transition gap-1">
                    <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg group-hover:-translate-y-1 transition duration-300 border border-white/10">
                        <i class="fas fa-clock text-xl"></i>
                    </div>
                    <span class="text-[9px] font-black tracking-widest uppercase" data-i18n="menu_time">Temps</span>
                </button>
                <div class="dock-submenu absolute hidden bg-white/95 backdrop-blur-md rounded-2xl p-2 shadow-xl flex-col gap-1 min-w-[150px]">
                    <button onclick="toggleWidget('clock')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-blue-100 transition text-slate-800 text-left font-bold text-xs"><i class="far fa-clock w-5 text-center text-blue-600"></i><span data-i18n="menu_digital">Digital</span></button>
                    <button onclick="toggleWidget('analog')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-cyan-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-clock w-5 text-center text-cyan-600"></i><span data-i18n="menu_analog">Analògic</span></button>
                    <button onclick="toggleWidget('timer')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-orange-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-hourglass-start w-5 text-center text-orange-600"></i><span data-i18n="menu_timer">Temporitzador</span></button>
                </div>
            </div>

            <div class="relative group dock-category">
                <button class="flex flex-col items-center text-slate-300 group-hover:text-white transition gap-1">
                    <div class="w-10 h-10 bg-purple-600 rounded-xl flex items-center justify-center shadow-lg group-hover:-translate-y-1 transition duration-300 border border-white/10">
                        <i class="fas fa-chalkboard-teacher text-xl"></i>
                    </div>
                    <span class="text-[9px] font-black tracking-widest uppercase" data-i18n="menu_class">Aula</span>
                </button>
                <div class="dock-submenu absolute hidden bg-white/95 backdrop-blur-md rounded-2xl p-2 shadow-xl flex-col gap-1 min-w-[150px]">
                    <button onclick="toggleWidget('scoreboard')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-purple-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-trophy w-5 text-center text-purple-600"></i><span data-i18n="menu_score">Marcador</span></button>
                    <button onclick="toggleWidget('picker')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-purple-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-hand-pointer w-5 text-center text-purple-600"></i><span data-i18n="menu_picker">Selector</span></button>
                    <button onclick="toggleWidget('groups')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-teal-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-users w-5 text-center text-teal-600"></i><span data-i18n="menu_groups">Grups</span></button>
                    <button onclick="toggleWidget('dice')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-indigo-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-cubes w-5 text-center text-indigo-600"></i><span data-i18n="menu_dice">Daus</span></button>
                    <button onclick="toggleWidget('symbols')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-yellow-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-eye w-5 text-center text-yellow-600"></i><span data-i18n="menu_symbols">Símbols</span></button>
                    <button onclick="toggleWidget('noise')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-pink-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-microphone-lines w-5 text-center text-pink-600"></i><span data-i18n="menu_noise">Sonòmetre</span></button>
                    <button onclick="toggleWidget('traffic')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-rose-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-traffic-light w-5 text-center text-rose-600"></i><span data-i18n="menu_traffic">Semàfor</span></button>
                </div>
            </div>

            <div class="relative group dock-category">
                <button class="flex flex-col items-center text-slate-300 group-hover:text-white transition gap-1">
                    <div class="w-10 h-10 bg-emerald-600 rounded-xl flex items-center justify-center shadow-lg group-hover:-translate-y-1 transition duration-300 border border-white/10">
                        <i class="fas fa-tools text-xl"></i>
                    </div>
                    <span class="text-[9px] font-black tracking-widest uppercase" data-i18n="menu_tools">Eines</span>
                </button>
                <div class="dock-submenu absolute hidden bg-white/95 backdrop-blur-md rounded-2xl p-2 shadow-xl flex-col gap-1 min-w-[150px]">
                    <button onclick="toggleWidget('timetable')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-indigo-100 transition text-slate-800 text-left font-bold text-xs"><i class="far fa-calendar-alt w-5 text-center text-indigo-600"></i><span data-i18n="menu_timetable">Horari Aula</span></button>
                    <button onclick="toggleWidget('week')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-blue-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-calendar-week w-5 text-center text-blue-600"></i><span data-i18n="menu_week">Horari Grup</span></button>
                    <button onclick="toggleWidget('notes')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-yellow-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-sticky-note w-5 text-center text-yellow-600"></i><span data-i18n="menu_notes">Notes</span></button>
                    <button onclick="toggleWidget('todo')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-emerald-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-list-check w-5 text-center text-emerald-600"></i><span data-i18n="menu_todo">Tasques</span></button>
                    <button onclick="toggleWidget('qr')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-gray-200 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-qrcode w-5 text-center text-gray-600"></i><span data-i18n="menu_qr">Codi QR</span></button>
                    <button onclick="toggleWidget('links')" class="flex items-center gap-3 p-2 rounded-xl hover:bg-sky-100 transition text-slate-800 text-left font-bold text-xs"><i class="fas fa-link w-5 text-center text-sky-600"></i><span data-i18n="menu_links">Enllaços</span></button>
                </div>
            </div>

            <div class="relative group dock-category ml-2 border-l border-white/10 pl-2">
                <button onclick="toggleInfoModal()" class="flex flex-col items-center text-slate-400 group-hover:text-white transition gap-1">
                    <div class="w-8 h-8 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center shadow-inner group-hover:-translate-y-1 transition duration-300 border border-white/10">
                        <i class="fas fa-question text-sm"></i>
                    </div>
                </button>
            </div>

        </div>
    </div>

    <div id="bg-modal" class="fixed inset-0 bg-black/60 z-[70] hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-3xl p-6 max-w-4xl w-full shadow-2xl relative flex flex-col h-[80vh]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-black text-indigo-700 uppercase" data-i18n="bg_title">Fons de Pantalla</h2>
                <button onclick="toggleBgModal()" class="text-slate-400 hover:text-red-500 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="flex gap-2 mb-4 border-b border-slate-100 pb-2">
                <button onclick="switchBgTab('gallery')" id="tab-gallery" class="px-4 py-2 font-bold text-sm rounded-lg bg-indigo-100 text-indigo-700">Galeria</button>
                <button onclick="switchBgTab('solid')" id="tab-solid" class="px-4 py-2 font-bold text-sm rounded-lg text-slate-500 hover:bg-slate-50">Colors</button>
                <button onclick="switchBgTab('url')" id="tab-url" class="px-4 py-2 font-bold text-sm rounded-lg text-slate-500 hover:bg-slate-50">URL</button>
                <button onclick="switchBgTab('upload')" id="tab-upload" class="px-4 py-2 font-bold text-sm rounded-lg text-slate-500 hover:bg-slate-50" data-i18n="bg_upload">Puja</button>
            </div>

            <div id="bg-content-gallery" class="flex-grow overflow-y-auto grid grid-cols-4 gap-4 content-start">
                </div>
            <div id="bg-content-solid" class="flex-grow overflow-y-auto grid grid-cols-6 gap-4 content-start hidden">
                </div>
            <div id="bg-content-url" class="flex-grow flex flex-col items-center justify-center gap-4 hidden">
                <input type="text" id="custom-bg-input" class="w-full max-w-md p-3 border border-slate-300 rounded-xl" placeholder="https://...">
                <button onclick="setCustomBg()" class="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold">Aplicar</button>
            </div>
            <div id="bg-content-upload" class="flex-grow flex flex-col items-center justify-center gap-4 hidden">
                <div class="text-center p-8 border-2 border-dashed border-slate-300 rounded-2xl bg-slate-50 hover:bg-slate-100 transition cursor-pointer" onclick="document.getElementById('bg-file-input').click()">
                    <i class="fas fa-cloud-upload-alt text-4xl text-slate-400 mb-2"></i>
                    <p class="text-sm font-bold text-slate-500" data-i18n="bg_drop_click">Clica per pujar imatge</p>
                    <p class="text-xs text-slate-400 mt-1">Max 3MB</p>
                </div>
                <input type="file" id="bg-file-input" accept="image/*" class="hidden" onchange="handleBgUpload(this)">
            </div>

             <div class="mt-4 flex justify-between items-center pt-2 border-t border-slate-100" id="bg-footer-controls">
                 <span class="text-xs text-slate-400" id="bg-page-info"></span>
                 <div class="flex gap-2" id="bg-pagination">
                     </div>
            </div>
        </div>
    </div>

    <div id="info-modal" class="fixed inset-0 bg-black/60 z-[70] hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-3xl p-6 max-w-4xl w-full shadow-2xl relative overflow-y-auto max-h-[95vh]">
            <button onclick="toggleInfoModal()" class="absolute top-4 right-4 text-slate-400 hover:text-red-500 transition"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-2xl font-black mb-4 text-indigo-700" data-i18n="info_title">Per què aquest Escriptori?</h2>
            
            <div class="mb-6 p-4 bg-indigo-50 border border-indigo-100 rounded-xl">
                <h3 class="text-sm font-black text-indigo-800 mb-2 uppercase" data-i18n="update_title">Actualitzacions versió 1.2</h3>
                <ul class="text-xs text-indigo-700 list-disc list-inside space-y-1" data-i18n="update_list">
                    <li>Secció Fons de Pantalla optimitzada.</li>
                    <li>Nou widget "Marcador" afegit.</li>
                    <li>Menús i botons polits.</li>
                </ul>
            </div>
            
            <div class="grid md:grid-cols-3 gap-3">
                 <div class="advantage-card">
                    <h3 class="text-sm font-black text-slate-800 mb-1"><i class="fas fa-piggy-bank text-indigo-600 mr-2"></i><span data-i18n="info_free_t">100% Gratuït</span></h3>
                    <p class="text-xs text-slate-600 leading-tight" data-i18n="info_free_d">Sense subscripcions ni versions "Pro". Totes les eines són gratis per sempre.</p>
                </div>
                <div class="advantage-card">
                    <h3 class="text-sm font-black text-slate-800 mb-1"><i class="fas fa-user-shield text-indigo-600 mr-2"></i><span data-i18n="info_privacy_t">Privacitat Total</span></h3>
                    <p class="text-xs text-slate-600 leading-tight" data-i18n="info_privacy_d">Les dades mai surten del teu ordinador. Compliment automàtic de protecció de dades.</p>
                </div>
                <div class="advantage-card">
                    <h3 class="text-sm font-black text-slate-800 mb-1"><i class="fas fa-bolt text-indigo-600 mr-2"></i><span data-i18n="info_fast_t">Sense Registre</span></h3>
                    <p class="text-xs text-slate-600 leading-tight" data-i18n="info_fast_d">Sense comptes ni contrasenyes. Obre l'arxiu i comença la classe a l'instant.</p>
                </div>
                <div class="advantage-card">
                    <h3 class="text-sm font-black text-slate-800 mb-1"><i class="fas fa-palette text-indigo-600 mr-2"></i><span data-i18n="info_design_t">Disseny Adaptat</span></h3>
                    <p class="text-xs text-slate-600 leading-tight" data-i18n="info_design_d">Tipografia accessible i colors pensats per a l'aula. Sense distraccions.</p>
                </div>
                <div class="advantage-card">
                    <h3 class="text-sm font-black text-slate-800 mb-1"><i class="fas fa-wifi text-indigo-600 mr-2"></i><span data-i18n="info_offline_t">Funciona Offline</span></h3>
                    <p class="text-xs text-slate-600 leading-tight" data-i18n="info_offline_d">Un cop obert, funciona sense internet. Ideal si falla la xarxa del centre.</p>
                </div>
                <div class="advantage-card">
                    <h3 class="text-sm font-black text-slate-800 mb-1"><i class="fas fa-ban text-indigo-600 mr-2"></i><span data-i18n="info_ads_t">Zero Publicitat</span></h3>
                    <p class="text-xs text-slate-600 leading-tight" data-i18n="info_ads_d">Sense anuncis ni rastrejadors. Un entorn educatiu segur i net.</p>
                </div>
            </div>

            <div class="mt-6 text-center border-t pt-4">
                <p class="text-xs text-slate-500 font-bold" data-i18n="info_dev">Creat i desenvolupat per Alfonso Lorenzo Martínez</p>
                <p class="text-[10px] text-slate-400 font-mono">aloren26@xtec.cat</p>
                <button onclick="toggleInfoModal()" class="mt-3 px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold text-xs hover:bg-indigo-700 transition shadow-lg uppercase" data-i18n="info_btn">Entesos!</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
            <h2 class="text-2xl font-black mb-4 uppercase" data-i18n="config_title">Configuració</h2>
            <div class="mb-4">
                <label class="block text-sm font-bold text-slate-700 mb-1" data-i18n="config_name">Nom del Docent</label>
                <input type="text" id="setting-name" class="w-full border border-slate-300 rounded p-2" placeholder="...">
            </div>
             <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
                <button onclick="resetWidgetPositions()" class="w-full bg-blue-100 text-blue-700 hover:bg-blue-200 py-2 rounded-lg font-bold text-sm transition uppercase" data-i18n="config_reset_pos">Recuperar Widgets</button>
                <p class="text-xs text-blue-600 mt-2 text-center font-bold" data-i18n="config_reset_desc">Torna tots els widgets al centre si s'han perdut.</p>
            </div>
            <div class="flex justify-between items-center pt-4 border-t border-slate-100">
                <button onclick="factoryReset()" class="text-red-500 text-xs font-black uppercase tracking-wider" data-i18n="config_reset_all">Reset Total</button>
                <button onclick="toggleConfig()" class="px-6 py-2 bg-slate-800 text-white rounded-lg font-black uppercase hover:bg-black transition" data-i18n="config_done">Fet</button>
            </div>
        </div>
    </div>

    <script>
        // TRADUCCIONS
        const translations = {
            ca: {
                menu_time: "Temps", menu_digital: "Digital", menu_analog: "Analògic", menu_timer: "Temporitzador",
                menu_class: "Aula", menu_picker: "Selector", menu_groups: "Grups", menu_dice: "Daus", menu_symbols: "Símbols", menu_noise: "Sonòmetre", menu_traffic: "Semàfor", menu_score: "Marcador",
                menu_tools: "Eines", menu_timetable: "Horari Aula", menu_week: "Horari Grup", menu_notes: "Notes", menu_todo: "Tasques", menu_qr: "Codi QR", menu_links: "Enllaços",
                bg_title: "Fons de Pantalla", bg_upload: "Puja", bg_drop_click: "Clica per pujar imatge",
                
                analog_title: "Analògic", notes_title: "Notes", timer_title: "Temporitzador", picker_title: "Selector", groups_title: "Equips", dice_title: "Daus", symbols_title: "Mode de Treball", noise_title: "Soroll", todo_title: "Tasques", qr_title: "Codi QR", links_title: "Enllaços", timetable_title: "Horari d'Aula", week_title: "Horari Setmanal", score_title: "Marcador",
                
                who_will_be: "Qui serà?", pick: "Triar", list_label: "Noms (un per línia):", close: "Tancar", who_is_here: "Qui hi és avui?", all: "Tots", done: "Fet",
                groups_label: "Grups:", generate: "Generar", groups_help: "Indica quants grups i clica \"Generar\".",
                activate: "Activar", stop: "Aturar", add_web: "Afegir Web", qr_help: "Introdueix URL i genera", generate_code: "Generar Codi", roll: "Llançar",
                
                time_col: "Hora", activity_col: "Activitat", icon_help: "Clica una icona per inserir-la",
                day_mon: "DL", day_tue: "DT", day_wed: "DC", day_thu: "DJ", day_fri: "DV",

                info_title: "Per què aquest Escriptori?",
                update_title: "Actualitzacions versió 1.2",
                update_list: `
                    <li>Secció Fons de Pantalla optimitzada.</li>
                    <li>Nou widget "Marcador" afegit.</li>
                    <li>Menús i botons polits.</li>
                `,
                info_free_t: "100% Gratuït", info_free_d: "Sense subscripcions ni versions \"Pro\". Totes les eines són gratis per sempre.",
                info_privacy_t: "Privacitat Total", info_privacy_d: "Les dades mai surten del teu ordinador. Compliment automàtic de protecció de dades.",
                info_fast_t: "Sense Registre", info_fast_d: "Sense comptes ni contrasenyes. Obre l'arxiu i comença la classe a l'instant.",
                info_design_t: "Disseny Adaptat", info_design_d: "Tipografia accessible i colors pensats per a l'aula. Sense distraccions.",
                info_offline_t: "Funciona Offline", info_offline_d: "Un cop obert, funciona sense internet. Ideal si falla la xarxa del centre.",
                info_ads_t: "Zero Publicitat", info_ads_d: "Sense anuncis ni rastrejadors. Un entorn educatiu segur i net.",
                info_dev: "Creat i desenvolupat per Alfonso Lorenzo Martínez", info_btn: "Entesos!",
                
                config_title: "Configuració", config_name: "Nom del Docent", config_reset_pos: "Recuperar Widgets", config_reset_desc: "Torna tots els widgets al centre si s'han perdut.", config_reset_all: "Reset Total", config_done: "Fet",
                credits_name: "Creat per Alfonso LM",
                
                sym_silence: "Silenci", sym_whisper: "Parelles", sym_group: "Grup", sym_ask: "Pregunta",
                
                // Icons
                ic_acad: "Acadèmic", ic_math: "Mates", ic_lang: "Llengua", ic_write: "Escriure", ic_sci: "Ciència", ic_soc: "Socials", ic_eng: "Anglès", ic_robot: "Robòtica", ic_read: "Lectura", ic_proj: "Projecte",
                ic_arts: "Arts i Cos", ic_art: "Plàstica", ic_mus: "Música", ic_pe: "EF", ic_drama: "Teatre", ic_body: "Cos",
                ic_div: "Diversitat", ic_sup: "Suport", ic_sign: "Signes", ic_hear: "Audició", ic_game: "Jocs", ic_think: "Pensar", ic_access: "Accés", ic_mob: "Mobilitat", ic_emo: "Emoció", ic_speak: "Parla",
                ic_rout: "Rutines", ic_morn: "Bon dia", ic_circ: "Rotllana", ic_eat: "Dinar", ic_play: "Pati", ic_wc: "Lavabo", ic_bus: "Bus", ic_home: "Casa"
            },
            es: {
                menu_time: "Tiempo", menu_digital: "Digital", menu_analog: "Analógico", menu_timer: "Temporizador",
                menu_class: "Aula", menu_picker: "Selector", menu_groups: "Grupos", menu_dice: "Dados", menu_symbols: "Símbolos", menu_noise: "Sonómetro", menu_traffic: "Semáforo", menu_score: "Marcador",
                menu_tools: "Herram.", menu_timetable: "Horario Aula", menu_week: "Horario Grupo", menu_notes: "Notas", menu_todo: "Tareas", menu_qr: "Código QR", menu_links: "Enlaces",
                bg_title: "Fondo de Pantalla", bg_upload: "Subir", bg_drop_click: "Clica para subir imagen",

                analog_title: "Analógico", notes_title: "Notas", timer_title: "Temporizador", picker_title: "Selector", groups_title: "Equipos", dice_title: "Dados", symbols_title: "Modo de Trabajo", noise_title: "Ruido", todo_title: "Tareas", qr_title: "Código QR", links_title: "Enlaces", timetable_title: "Horario de Aula", week_title: "Horario Semanal", score_title: "Marcador",
                
                who_will_be: "¿Quién será?", pick: "Elegir", list_label: "Nombres (uno por línea):", close: "Cerrar", who_is_here: "¿Quién está hoy?", all: "Todos", done: "Hecho",
                groups_label: "Grupos:", generate: "Generar", groups_help: "Indica cuántos grupos y clica \"Generar\".",
                activate: "Activar", stop: "Parar", add_web: "Añadir Web", qr_help: "Introduce URL y genera", generate_code: "Generar Código", roll: "Lanzar",
                
                time_col: "Hora", activity_col: "Actividad", icon_help: "Clica un icono para insertarlo",
                day_mon: "LU", day_tue: "MA", day_wed: "MI", day_thu: "JU", day_fri: "VI",
                
                info_title: "¿Por qué este Escritorio?",
                update_title: "Actualizaciones versión 1.2",
                update_list: `
                    <li>Sección Fondo de Pantalla optimizada.</li>
                    <li>Nuevo widget "Marcador" añadido.</li>
                    <li>Menús y botones pulidos.</li>
                `,
                info_free_t: "100% Gratuito", info_free_d: "Sin suscripciones ni versiones \"Pro\". Todas las herramientas son gratis para siempre.",
                info_privacy_t: "Privacidad Total", info_privacy_d: "Los datos nunca salen de tu ordenador. Cumplimiento automático de protección de datos.",
                info_fast_t: "Sin Registro", info_fast_d: "Sin cuentas ni contraseñas. Abre el archivo y empieza la clase al instante.",
                info_design_t: "Diseño Adaptado", info_design_d: "Tipografía accesible y colores pensados para el aula. Sin distracciones.",
                info_offline_t: "Funciona Offline", info_offline_d: "Una vez abierto, funciona sin internet. Ideal si falla la red del centro.",
                info_ads_t: "Cero Publicidad", info_ads_d: "Sin anuncios ni rastreadores. Un entorno educativo seguro y limpio.",
                info_dev: "Creado y desarrollado por Alfonso Lorenzo Martínez", info_btn: "¡Entendido!",
                
                config_title: "Configuración", config_name: "Nombre del Docente", config_reset_pos: "Recuperar Widgets", config_reset_desc: "Devuelve todos los widgets al centro si se han perdido.", config_reset_all: "Reset Total", config_done: "Hecho",
                credits_name: "Creado por Alfonso LM",
                
                sym_silence: "Silencio", sym_whisper: "Parejas", sym_group: "Grupo", sym_ask: "Pregunta",

                // Icons
                ic_acad: "Académico", ic_math: "Mates", ic_lang: "Lengua", ic_write: "Escribir", ic_sci: "Ciencia", ic_soc: "Socials", ic_eng: "Inglés", ic_robot: "Robótica", ic_read: "Lectura", ic_proj: "Proyecto",
                ic_arts: "Artes y Cuerpo", ic_art: "Plástica", ic_mus: "Música", ic_pe: "EF", ic_drama: "Teatro", ic_body: "Cuerpo",
                ic_div: "Diversidad", ic_sup: "Apoyo", ic_sign: "Signos", ic_hear: "Audición", ic_game: "Juegos", ic_think: "Pensar", ic_access: "Acceso", ic_mob: "Movilidad", ic_emo: "Emoción", ic_speak: "Habla",
                ic_rout: "Rutinas", ic_morn: "Buenos días", ic_circ: "Asamblea", ic_eat: "Comer", ic_play: "Patio", ic_wc: "Baño", ic_bus: "Bus", ic_home: "Casa"
            },
            en: {
                menu_time: "Time", menu_digital: "Digital", menu_analog: "Analog", menu_timer: "Timer",
                menu_class: "Class", menu_picker: "Picker", menu_groups: "Groups", menu_dice: "Dice", menu_symbols: "Symbols", menu_noise: "Noise Meter", menu_traffic: "Traffic Light", menu_score: "Scoreboard",
                menu_tools: "Tools", menu_timetable: "Timetable", menu_week: "Week Schedule", menu_notes: "Notes", menu_todo: "Tasks", menu_qr: "QR Code", menu_links: "Links",
                bg_title: "Wallpaper", bg_upload: "Upload", bg_drop_click: "Click to upload image",

                analog_title: "Analog", notes_title: "Notes", timer_title: "Timer", picker_title: "Selector", groups_title: "Teams", dice_title: "Dice", symbols_title: "Work Mode", noise_title: "Noise", todo_title: "Tasks", qr_title: "QR Code", links_title: "Links", timetable_title: "Timetable", week_title: "Weekly Schedule", score_title: "Scoreboard",
                
                who_will_be: "Who's next?", pick: "Pick", list_label: "Names (one per line):", close: "Close", who_is_here: "Who is here?", all: "All", done: "Done",
                groups_label: "Groups:", generate: "Generate", groups_help: "Set number of groups and click \"Generate\".",
                activate: "Start", stop: "Stop", add_web: "Add Web", qr_help: "Enter URL and generate", generate_code: "Generate Code", roll: "Roll",
                
                time_col: "Time", activity_col: "Activity", icon_help: "Click icon to insert",
                day_mon: "MO", day_tue: "TU", day_wed: "WE", day_thu: "TH", day_fri: "FR",
                
                info_title: "Why this Dashboard?",
                update_title: "Updates version 1.2",
                update_list: `
                    <li>Optimized Wallpaper section.</li>
                    <li>New "Scoreboard" widget added.</li>
                    <li>Polished menus and buttons.</li>
                `,
                info_free_t: "100% Free", info_free_d: "No subscriptions, no \"Pro\" versions. All tools are free forever.",
                info_privacy_t: "Total Privacy", info_privacy_d: "Data never leaves your computer. Automatic compliance with data protection.",
                info_fast_t: "No Signup", info_fast_d: "No accounts or passwords. Just open the file and start teaching instantly.",
                info_design_t: "Adapted Design", info_design_d: "Accessible typography and classroom-friendly colors. No distractions.",
                info_offline_t: "Works Offline", info_offline_d: "Once opened, works without internet. Ideal if school network fails.",
                info_ads_t: "Zero Ads", info_ads_d: "No ads or trackers. A safe and clean educational environment.",
                info_dev: "Created and developed by Alfonso Lorenzo Martínez", info_btn: "Got it!",
                
                config_title: "Settings", config_name: "Teacher's Name", config_reset_pos: "Recover Widgets", config_reset_desc: "Returns all widgets to center if lost.", config_reset_all: "Full Reset", config_done: "Done",
                credits_name: "Created by Alfonso LM",
                
                sym_silence: "Silence", sym_whisper: "Pairs", sym_group: "Group", sym_ask: "Ask",

                // Icons
                ic_acad: "Academic", ic_math: "Math", ic_lang: "Language", ic_write: "Writing", ic_sci: "Science", ic_soc: "Social", ic_eng: "English", ic_robot: "Robotics", ic_read: "Reading", ic_proj: "Project",
                ic_arts: "Arts & Body", ic_art: "Art", ic_mus: "Music", ic_pe: "PE", ic_drama: "Drama", ic_body: "Body",
                ic_div: "Diversity", ic_sup: "Support", ic_sign: "Sign", ic_hear: "Hearing", ic_game: "Games", ic_think: "Thinking", ic_access: "Access", ic_mob: "Mobility", ic_emo: "Emotion", ic_speak: "Speech",
                ic_rout: "Routines", ic_morn: "Morning", ic_circ: "Circle", ic_eat: "Lunch", ic_play: "Playground", ic_wc: "Toilet", ic_bus: "Bus", ic_home: "Home"
            }
        };

        // --- GLOBAL VARIABLES & STATE ---
        const widgetColors = {
            blanc: 'bg-white/90 text-slate-800',
            negre: 'bg-slate-900/90 text-white',
            gris: 'bg-gray-500/90 text-white',
            groc: 'bg-yellow-400/90 text-slate-900',
            taronja: 'bg-orange-500/90 text-white',
            vermell: 'bg-red-600/90 text-white',
            rosa: 'bg-pink-300/90 text-slate-900',
            fucsia: 'bg-fuchsia-600/90 text-white',
            blaufosc: 'bg-blue-900/90 text-white',
            blaucel: 'bg-sky-400/90 text-white',
            verdfosc: 'bg-emerald-800/90 text-white',
            verdclar: 'bg-lime-400/90 text-slate-900',
            marro: 'bg-amber-800/90 text-white'
        };

        const defaultState = {
            lang: 'ca', 
            teacherName: "",
            lastBgUpdate: null,
            currentBgUrl: "https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=2070",
            currentBgType: 'image',
            widgets: {
                clock: { visible: true, x: 50, y: 150, w: 300, h: 200, color: 'blanc' },
                analog: { visible: false, x: 360, y: 150, w: 280, h: 320, color: 'blanc' }, 
                timetable: { visible: false, content: "", title: "Horari Aula", x: 400, y: 150, w: 450, h: 500, color: 'blanc' },
                week: { visible: false, content: "", title: "Horari Setmanal", x: 100, y: 100, w: 800, h: 500, color: 'blanc' },
                picker: { visible: false, names: "Alumne 1\nAlumne 2\nAlumne 3", excluded: [], x: 850, y: 150, w: 300, h: 250, color: 'blanc' },
                notes: { visible: false, text: "", x: 50, y: 400, w: 300, h: 300, color: 'groc' },
                traffic: { visible: false, active: null, x: 400, y: 600, w: 140, h: 320, color: 'blanc' }, 
                timer: { visible: false, duration: 5, timeLeft: 300, isRunning: false, x: 500, y: 400, w: 300, h: 250, color: 'blanc' },
                groups: { visible: false, count: 4, x: 100, y: 150, w: 400, h: 400, color: 'blanc' },
                noise: { visible: false, x: 200, y: 200, w: 200, h: 350, color: 'blanc' },
                todo: { visible: false, tasks: [], x: 600, y: 250, w: 300, h: 400, color: 'blanc' },
                qr: { visible: false, lastUrl: "", x: 100, y: 200, w: 280, h: 380, color: 'blanc' },
                dice: { visible: false, count: 1, x: 500, y: 300, w: 300, h: 250, color: 'blanc' },
                symbols: { visible: false, current: 'silence', x: 300, y: 250, w: 320, h: 320, color: 'blanc' },
                scoreboard: { 
                    visible: false, x: 400, y: 150, w: 450, h: 280, color: 'blanc',
                    scoreA: 0, scoreB: 0, nameA: "", nameB: "", 
                    colorA: "bg-blue-500", colorB: "bg-red-500"
                },
                links: { visible: false, items: [
                    {name: 'Google', url: 'https://google.com', icon: 'fa-google'},
                    {name: 'YouTube', url: 'https://youtube.com', icon: 'fa-youtube'},
                    {name: 'Canva', url: 'https://canva.com', icon: 'fa-pen-nib'}
                ], x: 800, y: 150, w: 300, h: 350, color: 'blanc' }
            }
        };

        let appState = {};
        let timerInterval, audioContext, microphoneStream, noiseInterval;
        let qrObj = null;
        let lastFocusedTimetableCell = null;
        let galleryPage = 0;
        const IMAGES_PER_PAGE = 8;

        // BANC D'IMATGES (NETEJA - 40 IMATGES SENSE ERRORS)
        const imageIds = [
            "1472214103451-9374bd1c798e", "1441974231531-c6227db76b6e", "1506744038136-46273834b3fb", "1470071459604-3b5ec3a7fe05",
            "1447752875215-b2761acb3c5d", "1426604966848-d7adac402bff", "1493246507139-91e8fad9978e", "1511497584788-876760111969",
            "1454496522488-7a8e488e8606", "1433086966358-54859d0ed716", "1465146344425-f00d5f5c8f07", "1470252649378-9c29740c9fa8",
            "1482938289607-e9573fc25ebb", "1476610182048-b716b8518aae", "1499002238440-d264edd596ec", "1433838552652-f9a46b332c40",
            "1458668383970-8ddd3927deed", "1518173946687-a4c8892bbd9f", "1497366216548-37526070297c", "1506784983877-45594efa4cbe",
            "1451187580459-43490279c0fa", "1534224039826-c7a0eda0e6b3", "1508615039623-a25605d2b022", "1483729558449-99ef09a8c325",
            "1475924156734-496f6cac6ec1", "1500964757637-c85e8a162699", "1496715976403-7e36dc43f17b", "1504805572947-34fad45aed93",
            "1524169358666-79f22534bc6e", "1526721940322-10fb6e3ae94a", "1501630834273-4b5604d2ee31", "1528722828814-77b9b83aafb2",
            "1531315630201-bb15abeb1653", "1464822759023-fed622ff2c3b", "1503264116251-35a269479413", "1516550893923-42d28e5677af",
            "1518655048521-f130df041f66", "1513542789411-b6a5d4f31634", "1481627834876-b7833e8f5570", "1491895200222-0fc4a4c35e18"
        ];
        const bgCollection = imageIds.map(id => `https://images.unsplash.com/photo-${id}?auto=format&fit=crop&q=80&w=1920`);

        const solidColors = [
            '#f8fafc', '#f1f5f9', '#e2e8f0', '#cbd5e1', '#94a3b8', '#64748b', '#475569', '#334155', '#1e293b', '#0f172a',
            '#fff1f2', '#ffe4e6', '#fecdd3', '#fda4af', '#fb7185', '#f43f5e', '#e11d48', '#be123c', '#9f1239', '#881337',
            '#fff7ed', '#ffedd5', '#fed7aa', '#fdba74', '#fb923c', '#f97316', '#ea580c', '#c2410c', '#9a3412', '#7c2d12',
            '#fefce8', '#fef9c3', '#fef08a', '#fde047', '#facc15', '#eab308', '#ca8a04', '#a16207', '#854d0e', '#713f12',
            '#f0fdf4', '#dcfce7', '#bbf7d0', '#86efac', '#4ade80', '#22c55e', '#16a34a', '#15803d', '#166534', '#14532d',
            '#eff6ff', '#dbeafe', '#bfdbfe', '#93c5fd', '#60a5fa', '#3b82f6', '#2563eb', '#1d4ed8', '#1e40af', '#1e3a8a',
            '#faf5ff', '#f3e8ff', '#e9d5ff', '#d8b4fe', '#c084fc', '#a855f7', '#9333ea', '#7e22ce', '#6b21a8', '#581c87'
        ];

        // --- INIT ---
        function loadState() {
            // Version v1.2 - FINAL RELEASE
            const saved = localStorage.getItem('escriptoriTacState_v1-2_FINAL'); 
            if (saved) {
                const parsed = JSON.parse(saved);
                appState = { ...defaultState, ...parsed, widgets: { ...defaultState.widgets, ...parsed.widgets } };
                ['qr', 'dice', 'symbols', 'links', 'week', 'scoreboard'].forEach(k => {
                    if(!appState.widgets[k]) appState.widgets[k] = defaultState.widgets[k];
                });
            } else {
                appState = JSON.parse(JSON.stringify(defaultState));
                appState.widgets.timetable.content = generateDailyTimetable();
                appState.widgets.week.content = generateWeeklyTimetable(); 
                const cx = (window.innerWidth / 2) - (300 / 2);
                const cy = (window.innerHeight / 2) - (180 / 2);
                appState.widgets.clock.x = cx; appState.widgets.clock.y = cy;
                appState.widgets.clock.w = 300; appState.widgets.clock.h = 180;
                appState.widgets.clock.visible = true;
            }

            setLanguage(appState.lang || 'ca');
            setInterval(updateClock, 1000); updateClock();
            setInterval(updateAnalogClock, 1000); updateAnalogClock();
            
            if (appState.currentBgType === 'solid') {
                document.body.style.backgroundImage = 'none';
                document.body.style.backgroundColor = appState.currentBgUrl;
            } else {
                if(appState.currentBgUrl && appState.currentBgUrl.startsWith('data:')) {
                     document.body.style.backgroundImage = `url('${appState.currentBgUrl}')`;
                     document.body.style.backgroundSize = "contain"; 
                     document.body.style.backgroundRepeat = "no-repeat";
                     document.body.style.backgroundPosition = "center";
                     document.body.style.backgroundColor = "#f0fdf4"; 
                } else {
                     document.body.style.backgroundSize = "cover"; 
                     checkDailyBackground();
                }
            }

            initWidgets();
        }

        function saveState() { localStorage.setItem('escriptoriTacState_v1-2_FINAL', JSON.stringify(appState)); }

        // --- DOCK LOGIC ---
        function toggleDock() {
            const dock = document.getElementById('dock-container');
            const trigger = document.getElementById('dock-trigger');
            
            if (dock.classList.contains('dock-hidden')) {
                // Showing Dock -> Hide Trigger
                dock.classList.remove('dock-hidden');
                trigger.classList.add('hidden');
            } else {
                // Hiding Dock -> Show Trigger
                dock.classList.add('dock-hidden');
                trigger.classList.remove('hidden');
            }
        }

        // --- BACKGROUND MODAL LOGIC ---
        function toggleBgModal() {
            const modal = document.getElementById('bg-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                switchBgTab('gallery');
            }
        }

        function switchBgTab(tab) {
            ['gallery', 'solid', 'url', 'upload'].forEach(t => {
                const btn = document.getElementById('tab-' + t);
                const content = document.getElementById('bg-content-' + t);
                if (t === tab) {
                    btn.className = "px-4 py-2 font-bold text-sm rounded-lg bg-indigo-100 text-indigo-700";
                    content.classList.remove('hidden');
                } else {
                    btn.className = "px-4 py-2 font-bold text-sm rounded-lg text-slate-500 hover:bg-slate-50";
                    content.classList.add('hidden');
                }
            });

            // Toggle Footer Controls (Only visible for gallery)
            const footer = document.getElementById('bg-footer-controls');
            if(tab === 'gallery') footer.classList.remove('hidden');
            else footer.classList.add('hidden');

            if (tab === 'gallery') renderBackgroundGallery(0);
            if (tab === 'solid') renderSolidColors();
        }

        function renderBackgroundGallery(page) {
            galleryPage = page;
            const container = document.getElementById('bg-content-gallery');
            container.innerHTML = '';
            
            const start = page * IMAGES_PER_PAGE;
            if (start >= bgCollection.length) { galleryPage = 0; renderBackgroundGallery(0); return; }
            
            const end = Math.min(start + IMAGES_PER_PAGE, bgCollection.length);
            const pageImages = bgCollection.slice(start, end);

            pageImages.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.className = `bg-thumb ${appState.currentBgUrl === url ? 'active' : ''}`;
                img.onclick = () => setBackground(url, 'image');
                img.onerror = function() { this.style.display='none'; };
                container.appendChild(img);
            });

            const pagination = document.getElementById('bg-pagination');
            pagination.innerHTML = '';
            const totalPages = Math.ceil(bgCollection.length / IMAGES_PER_PAGE);
            
            if (page > 0) {
                const prev = document.createElement('button');
                prev.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prev.className = "w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600";
                prev.onclick = () => renderBackgroundGallery(page - 1);
                pagination.appendChild(prev);
            }
            
            document.getElementById('bg-page-info').textContent = `${page + 1} / ${totalPages}`;

            if (page < totalPages - 1) {
                const next = document.createElement('button');
                next.innerHTML = '<i class="fas fa-chevron-right"></i>';
                next.className = "w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600";
                next.onclick = () => renderBackgroundGallery(page + 1);
                pagination.appendChild(next);
            }
        }

        function renderSolidColors() {
            const container = document.getElementById('bg-content-solid');
            container.innerHTML = '';
            solidColors.forEach(color => {
                const div = document.createElement('div');
                div.className = "solid-color-btn";
                div.style.backgroundColor = color;
                div.onclick = () => setBackground(color, 'solid');
                container.appendChild(div);
            });
        }

        function setCustomBg() {
            const url = document.getElementById('custom-bg-input').value;
            if (url) setBackground(url, 'image');
        }

        function handleBgUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if(file.size > 3000000) { 
                    alert("Imatge massa gran (>3MB). Podria no guardar-se correctament.");
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    setBackground(e.target.result, 'upload');
                }
                reader.readAsDataURL(file);
            }
        }

        function setBackground(val, type) {
            if (type === 'solid') {
                document.body.style.backgroundImage = 'none';
                document.body.style.backgroundColor = val;
                appState.currentBgType = 'solid';
            } else {
                document.body.style.backgroundColor = '#333';
                document.body.style.backgroundImage = `url('${val}')`;
                
                if (type === 'upload' || val.startsWith('data:')) {
                     document.body.style.backgroundSize = "contain";
                     document.body.style.backgroundRepeat = "no-repeat";
                     document.body.style.backgroundPosition = "center";
                     document.body.style.backgroundColor = "#f0fdf4"; 
                     appState.currentBgType = 'upload';
                } else {
                     document.body.style.backgroundSize = "cover";
                     appState.currentBgType = 'image';
                }
            }
            appState.currentBgUrl = val;
            saveState();
            
            if (type === 'image' && !document.getElementById('bg-content-gallery').classList.contains('hidden')) {
                renderBackgroundGallery(galleryPage);
            }
        }

        function setLanguage(lang) {
            appState.lang = lang;
            const t = translations[lang];
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(t[key]) {
                    if(el.tagName === 'INPUT' && el.type === 'placeholder') el.placeholder = t[key];
                    else el.innerHTML = t[key]; 
                }
            });

            ['ca','es','en'].forEach(l => {
                const btn = document.getElementById('lang-'+l);
                if(l === lang) btn.classList.add('active', 'text-indigo-600', 'underline');
                else btn.classList.remove('active', 'text-indigo-600', 'underline');
            });

            updateSymbolDisplay();
            updateTimetableIconsRender();
            const days = ['day_mon','day_tue','day_wed','day_thu','day_fri'];
            const ths = document.querySelectorAll('.week-table thead th');
            for(let i=0; i<5; i++) {
                if(ths[i+1]) ths[i+1].textContent = t[days[i]];
            }
            saveState();
        }

        function updateTimetableIconsRender() {
            const t = translations[appState.lang];
            const html = `
                <div class="icon-category-title">${t.ic_acad}</div>
                <div onclick="insertIcon('fa-book')" class="icon-btn"><i class="fas fa-book"></i><span>${t.ic_lang}</span></div><div onclick="insertIcon('fa-calculator')" class="icon-btn"><i class="fas fa-calculator"></i><span>${t.ic_math}</span></div><div onclick="insertIcon('fa-flask')" class="icon-btn"><i class="fas fa-flask"></i><span>${t.ic_sci}</span></div><div onclick="insertIcon('fa-globe-americas')" class="icon-btn"><i class="fas fa-globe-americas"></i><span>${t.ic_soc}</span></div><div onclick="insertIcon('fa-language')" class="icon-btn"><i class="fas fa-language"></i><span>${t.ic_eng}</span></div><div onclick="insertIcon('fa-laptop-code')" class="icon-btn"><i class="fas fa-laptop-code"></i><span>${t.ic_robot}</span></div><div onclick="insertIcon('fa-pencil-alt')" class="icon-btn"><i class="fas fa-pencil-alt"></i><span>${t.ic_write}</span></div><div onclick="insertIcon('fa-book-reader')" class="icon-btn"><i class="fas fa-book-reader"></i><span>${t.ic_read}</span></div><div onclick="insertIcon('fa-lightbulb')" class="icon-btn"><i class="fas fa-lightbulb"></i><span>${t.ic_proj}</span></div>
                <div class="icon-category-title">${t.ic_arts}</div>
                <div onclick="insertIcon('fa-palette')" class="icon-btn"><i class="fas fa-palette"></i><span>${t.ic_art}</span></div><div onclick="insertIcon('fa-music')" class="icon-btn"><i class="fas fa-music"></i><span>${t.ic_mus}</span></div><div onclick="insertIcon('fa-running')" class="icon-btn"><i class="fas fa-running"></i><span>${t.ic_pe}</span></div><div onclick="insertIcon('fa-theater-masks')" class="icon-btn"><i class="fas fa-theater-masks"></i><span>${t.ic_drama}</span></div><div onclick="insertIcon('fa-child')" class="icon-btn"><i class="fas fa-child"></i><span>${t.ic_body}</span></div>
                <div class="icon-category-title">${t.ic_div}</div>
                <div onclick="insertIcon('fa-hands-helping')" class="icon-btn"><i class="fas fa-hands-helping text-teal-600"></i><span>${t.ic_sup}</span></div><div onclick="insertIcon('fa-sign-language')" class="icon-btn"><i class="fas fa-sign-language text-purple-600"></i><span>${t.ic_sign}</span></div><div onclick="insertIcon('fa-ear-listen')" class="icon-btn"><i class="fas fa-ear-listen text-orange-500"></i><span>${t.ic_hear}</span></div><div onclick="insertIcon('fa-puzzle-piece')" class="icon-btn"><i class="fas fa-puzzle-piece text-blue-500"></i><span>${t.ic_game}</span></div><div onclick="insertIcon('fa-brain')" class="icon-btn"><i class="fas fa-brain text-pink-500"></i><span>${t.ic_think}</span></div><div onclick="insertIcon('fa-universal-access')" class="icon-btn"><i class="fas fa-universal-access"></i><span>${t.ic_access}</span></div><div onclick="insertIcon('fa-wheelchair')" class="icon-btn"><i class="fas fa-wheelchair"></i><span>${t.ic_mob}</span></div><div onclick="insertIcon('fa-face-smile')" class="icon-btn"><i class="fas fa-face-smile text-yellow-500"></i><span>${t.ic_emo}</span></div><div onclick="insertIcon('fa-comment-dots')" class="icon-btn"><i class="fas fa-comment-dots"></i><span>${t.ic_speak}</span></div>
                <div class="icon-category-title">${t.ic_rout}</div>
                <div onclick="insertIcon('fa-sun')" class="icon-btn"><i class="fas fa-sun text-yellow-500"></i><span>${t.ic_morn}</span></div><div onclick="insertIcon('fa-users')" class="icon-btn"><i class="fas fa-users"></i><span>${t.ic_circ}</span></div><div onclick="insertIcon('fa-utensils')" class="icon-btn"><i class="fas fa-utensils"></i><span>${t.ic_eat}</span></div><div onclick="insertIcon('fa-tree')" class="icon-btn"><i class="fas fa-tree text-green-600"></i><span>${t.ic_play}</span></div><div onclick="insertIcon('fa-restroom')" class="icon-btn"><i class="fas fa-restroom"></i><span>${t.ic_wc}</span></div><div onclick="insertIcon('fa-bus')" class="icon-btn"><i class="fas fa-bus text-yellow-600"></i><span>${t.ic_bus}</span></div><div onclick="insertIcon('fa-home')" class="icon-btn"><i class="fas fa-home text-blue-500"></i><span>${t.ic_home}</span></div>
            `;
            document.getElementById('icon-picker-content').innerHTML = html;
            const weekContainer = document.getElementById('week-icons-content');
            if(weekContainer) weekContainer.innerHTML = html;
        }

        function toggleInfoModal() { const m = document.getElementById('info-modal'); m.classList.toggle('hidden'); if(!m.classList.contains('hidden')) m.querySelector('div').scrollTop=0; }
        function toggleIconPicker(source) {
            if(source !== 'timetable') document.getElementById('timetable-icons').classList.add('hidden');
            if(source !== 'week') document.getElementById('week-icons').classList.add('hidden');
            if (source === 'timetable') document.getElementById('timetable-icons').classList.toggle('hidden');
            else if (source === 'week') document.getElementById('week-icons').classList.toggle('hidden');
        }
        function insertIcon(iconClass) {
            if (lastFocusedTimetableCell) {
                lastFocusedTimetableCell.focus();
                document.execCommand('insertHTML', false, `<i class="fas ${iconClass} mr-2 select-none" contenteditable="false"></i>&nbsp;`);
                lastFocusedTimetableCell.dispatchEvent(new Event('input', { bubbles: true }));
                document.getElementById('timetable-icons').classList.add('hidden');
                document.getElementById('week-icons').classList.add('hidden');
            } else alert(appState.lang === 'ca' ? "Primer clica a una casella!" : (appState.lang==='es'?"¡Primero clica una casilla!":"First click a cell!"));
        }

        function addTimetableRow() { const b = document.getElementById('timetable-body'); const r = document.createElement('tr'); r.className = "border-b border-slate-300/50"; r.innerHTML = `<td class="font-bold text-slate-600 text-xs p-2 bg-white/40" contenteditable="true">--:--</td><td class="bg-white/20 p-2 hover:bg-white/60 transition" contenteditable="true"></td>`; b.appendChild(r); appState.widgets.timetable.content = b.innerHTML; saveState(); }
        function removeTimetableRow() { const b = document.getElementById('timetable-body'); if (b.children.length > 0) { b.removeChild(b.lastElementChild); appState.widgets.timetable.content = b.innerHTML; saveState(); } }
        function generateWeeklyTimetable() { let h = ''; for(let i=0; i<5; i++) { h += `<tr class="border-b border-black/10"><td class="bg-white/30 font-bold" contenteditable="true">9:00</td><td class="bg-white/10 hover:bg-white/40" contenteditable="true"></td><td class="bg-white/10 hover:bg-white/40" contenteditable="true"></td><td class="bg-white/10 hover:bg-white/40" contenteditable="true"></td><td class="bg-white/10 hover:bg-white/40" contenteditable="true"></td><td class="bg-white/10 hover:bg-white/40" contenteditable="true"></td></tr>`; } return h; }
        function addWeekRow() { const b = document.getElementById('week-body'); const r = document.createElement('tr'); r.className = "border-b border-black/10"; r.innerHTML = `<td class="bg-white/30 font-bold" contenteditable="true">--:--</td><td class="bg-white/10 hover:bg-white/40" contenteditable="true"></td><td class="bg-white/10 hover:bg-white/40" contenteditable="true"></td><td class="bg-white/10 hover:bg-white/40" contenteditable="true"></td><td class="bg-white/10 hover:bg-white/40" contenteditable="true"></td><td class="bg-white/10 hover:bg-white/40" contenteditable="true"></td>`; b.appendChild(r); appState.widgets.week.content = b.innerHTML; saveState(); }
        function removeWeekRow() { const b = document.getElementById('week-body'); if (b.children.length > 0) { b.removeChild(b.lastElementChild); appState.widgets.week.content = b.innerHTML; saveState(); } }

        function initWidgets() {
            document.getElementById('setting-name').value = appState.teacherName;
            document.getElementById('setting-name').addEventListener('input', (e) => { appState.teacherName = e.target.value; saveState(); });
            Object.keys(appState.widgets).forEach(id => {
                const w = appState.widgets[id]; const el = document.getElementById(`widget-${id}`);
                if (el) { el.style.left=w.x+'px'; el.style.top=w.y+'px'; el.style.width=w.w+'px'; el.style.height=w.h+'px';
                w.visible ? el.classList.remove('hidden-widget') : el.classList.add('hidden-widget');
                applyWidgetColor(id); makeInteractable(el, id); }
            });
            document.getElementById('notes-area').value = appState.widgets.notes.text;
            document.getElementById('student-list').value = appState.widgets.picker.names;
            document.getElementById('timetable-title').textContent = appState.widgets.timetable.title || "Horari Aula";
            document.getElementById('timetable-body').innerHTML = appState.widgets.timetable.content || generateDailyTimetable();
            const weekTitle = document.getElementById('week-title'); if(weekTitle) weekTitle.textContent = appState.widgets.week.title || "Horari Setmanal";
            const weekBody = document.getElementById('week-body'); if(weekBody) weekBody.innerHTML = appState.widgets.week.content || generateWeeklyTimetable();
            ['timetable-body', 'week-body'].forEach(id => { const el = document.getElementById(id); if(el) { el.addEventListener('focusin', (e) => { if (e.target.tagName === 'TD') lastFocusedTimetableCell = e.target; }); el.addEventListener('input', () => { if(id === 'timetable-body') appState.widgets.timetable.content = el.innerHTML; if(id === 'week-body') appState.widgets.week.content = el.innerHTML; saveState(); }); } });
            if(weekTitle) weekTitle.addEventListener('input', () => { appState.widgets.week.title = weekTitle.textContent; saveState(); });
            
            // Scoreboard Init
            const sb = appState.widgets.scoreboard;
            updateScoreDOM('A', sb.scoreA, sb.nameA, sb.colorA);
            updateScoreDOM('B', sb.scoreB, sb.nameB, sb.colorB);
            document.getElementById('name-a').addEventListener('input', (e) => { appState.widgets.scoreboard.nameA = e.target.value; saveState(); });
            document.getElementById('name-b').addEventListener('input', (e) => { appState.widgets.scoreboard.nameB = e.target.value; saveState(); });

            updateTrafficLightDOM(appState.widgets.traffic.active); updateTimerDisplay(appState.widgets.timer.timeLeft); renderTodoList();
            if(appState.widgets.qr.lastUrl) { document.getElementById('qr-input').value = appState.widgets.qr.lastUrl; generateQR(); }
            renderLinks(); renderDice(appState.widgets.dice.count, true);
        }

        // SCOREBOARD LOGIC (SIMPLIFIED)
        function changeScore(team, delta) {
            const current = appState.widgets.scoreboard[`score${team}`];
            const newVal = Math.max(0, current + delta);
            appState.widgets.scoreboard[`score${team}`] = newVal;
            document.getElementById(`score-${team.toLowerCase()}`).innerText = newVal;
            const scoreEl = document.getElementById(`score-${team.toLowerCase()}`);
            scoreEl.classList.remove('animate-pop'); void scoreEl.offsetWidth; scoreEl.classList.add('animate-pop');
            saveState();
        }
        function toggleTeamConfig(team) {
            const panel = document.getElementById(`config-${team.toLowerCase()}`);
            panel.classList.toggle('hidden');
        }
        function setTeamColor(team, colorClass) {
            appState.widgets.scoreboard[`color${team}`] = colorClass;
            updateTeamAppearance(team); saveState();
        }
        function updateTeamAppearance(team) {
            const t = team.toLowerCase();
            const color = appState.widgets.scoreboard[`color${team}`];
            const container = document.getElementById(`team-${t}-container`);
            container.className = container.className.replace(/bg-\w+-\d+/g, '');
            container.classList.add(color);
            document.getElementById(`config-${t}`).classList.add('hidden');
        }
        function updateScoreDOM(team, score, name, color) {
            const t = team.toLowerCase();
            document.getElementById(`score-${t}`).innerText = score;
            document.getElementById(`name-${t}`).value = name;
            updateTeamAppearance(team);
        }

        function generateQR() { const u = document.getElementById('qr-input').value; const c = document.getElementById('qrcode'); c.innerHTML = ""; if(!u) { c.innerHTML = `<span class="text-slate-300 text-xs font-bold text-center">${translations[appState.lang].qr_help}</span>`; return; } new QRCode(c, { text: u, width: 180, height: 180 }); appState.widgets.qr.lastUrl = u; saveState(); }
        function setDiceCount(n) { appState.widgets.dice.count = n; saveState(); renderDice(n, true); }
        function renderDice(n, s=false) { const c = document.getElementById('dice-container'); c.innerHTML = ""; for(let i=0; i<n; i++) { const v = s ? 1 : Math.floor(Math.random()*6)+1; const d = document.createElement('i'); d.className = `fas fa-dice-${['one','two','three','four','five','six'][v-1]} transition`; c.appendChild(d); } }
        function rollDice() { const c = document.getElementById('dice-container'); c.classList.add('animate-shake'); setTimeout(() => { c.classList.remove('animate-shake'); renderDice(appState.widgets.dice.count, false); }, 500); }
        function setSymbol(k) { appState.widgets.symbols.current = k; saveState(); updateSymbolDisplay(); }
        function updateSymbolDisplay() { const c = appState.widgets.symbols.current; const t = translations[appState.lang]; const km = { silence: 'sym_silence', whisper: 'sym_whisper', group: 'sym_group', ask: 'sym_ask' }; const im = { silence: 'fa-comment-slash', whisper: 'fa-user-friends', group: 'fa-users', ask: 'fa-hand-paper' }; document.getElementById('symbol-display').innerHTML = `<i class="fas ${im[c]} text-8xl opacity-80"></i><span class="text-2xl font-black uppercase tracking-widest mt-4">${t[km[c]]}</span>`; }
        function renderLinks() { const c = document.getElementById('links-container'); c.innerHTML = ""; appState.widgets.links.items.forEach((item, index) => { const btn = document.createElement('a'); btn.href = item.url; btn.target = "_blank"; btn.className = "flex flex-col items-center justify-center p-3 bg-white/50 rounded-xl hover:bg-white transition shadow-sm group aspect-square relative"; btn.innerHTML = `<i class="fab ${item.icon} text-3xl text-slate-600 group-hover:text-indigo-600 mb-2"></i><span class="text-[10px] font-bold uppercase truncate w-full text-center text-slate-800">${item.name}</span><button onclick="removeLink(event, ${index})" class="absolute top-1 right-1 text-red-300 hover:text-red-500 text-xs opacity-0 group-hover:opacity-100"><i class="fas fa-times"></i></button>`; c.appendChild(btn); }); }
        function addNewLink() { const n = prompt(appState.lang === 'ca' ? "Nom:" : "Name:"); if(!n) return; const u = prompt("URL:"); if(!u) return; appState.widgets.links.items.push({ name: n, url: u, icon: 'fa-link' }); saveState(); renderLinks(); }
        function removeLink(e, index) { e.preventDefault(); e.stopPropagation(); if(confirm("Esborrar?")) { appState.widgets.links.items.splice(index, 1); saveState(); renderLinks(); } }

        function makeInteractable(el, wid) {
            const h = el.querySelector('.widget-header'); let isD=false, sX, sY, iL, iT;
            if (h) { h.addEventListener('mousedown', (e) => { if(e.target.closest('button')||e.target.closest('input')||e.target.closest('textarea')) return; isD=true; sX=e.clientX; sY=e.clientY; iL=el.offsetLeft; iT=el.offsetTop; bringToFront(el); document.addEventListener('mousemove', onMM); document.addEventListener('mouseup', onMU); }); }
            function onMM(e) { if (!isD) return; const dx=e.clientX-sX; const dy=e.clientY-sY; let nL=iL+dx; let nT=iT+dy; if(nL<0) nL=0; if(nT<0) nT=0; el.style.left=`${nL}px`; el.style.top=`${nT}px`; }
            function onMU() { isD=false; document.removeEventListener('mousemove', onMM); document.removeEventListener('mouseup', onMU); appState.widgets[wid].x = el.offsetLeft; appState.widgets[wid].y = el.offsetTop; saveState(); }
            new ResizeObserver(e => { for (let en of e) { if (!el.classList.contains('hidden-widget')) { appState.widgets[wid].w = el.offsetWidth; appState.widgets[wid].h = el.offsetHeight; saveState(); } } }).observe(el);
            el.addEventListener('mousedown', () => bringToFront(el));
        }
        function bringToFront(el) { document.querySelectorAll('.widget').forEach(w => w.style.zIndex = 10); el.style.zIndex = 20; const m = el.querySelector('[id^="colors-"]'); if(m) m.style.zIndex = 30; }
        function toggleWidget(id) { const el = document.getElementById(`widget-${id}`); if (el.classList.contains('hidden-widget')) { const cx=(window.innerWidth/2)-(appState.widgets[id].w/2); const cy=(window.innerHeight/2)-(appState.widgets[id].h/2); appState.widgets[id].x=cx; appState.widgets[id].y=cy; el.style.left=cx+'px'; el.style.top=cy+'px'; el.classList.remove('hidden-widget'); appState.widgets[id].visible=true; bringToFront(el); } else { el.classList.add('hidden-widget'); appState.widgets[id].visible=false; } saveState(); }
        function closeWidget(id) { document.getElementById(`widget-${id}`).classList.add('hidden-widget'); appState.widgets[id].visible = false; document.getElementById(`colors-${id}`).classList.add('hidden'); saveState(); }
        function applyWidgetColor(id) { const el = document.getElementById(`widget-${id}`); const bg = widgetColors[appState.widgets[id].color || 'white']; Object.values(widgetColors).forEach(c => el.classList.remove(...c.split(' '))); el.classList.add(...bg.split(' ')); }
        function toggleColorMenu(id) { const m = document.getElementById(`colors-${id}`); if (m.children.length === 0) Object.keys(widgetColors).forEach(c => { const d = document.createElement('div'); d.className = `color-dot ${widgetColors[c].replace('/90','').replace(' text-white','').replace(' text-slate-800','').replace(' text-slate-900','')} shadow-sm`; d.onclick = (e) => { e.stopPropagation(); appState.widgets[id].color = c; applyWidgetColor(id); saveState(); m.classList.add('hidden'); }; m.appendChild(d); }); m.classList.toggle('hidden'); }
        function checkDailyBackground() { const n = new Date(); const t = new Date(); t.setHours(8, 0, 0, 0); const l = appState.lastBgUpdate ? new Date(appState.lastBgUpdate) : new Date(0); if (n >= t && l < t) cycleBackground(Math.floor((n - new Date(n.getFullYear(), 0, 0)) / 86400000) % bgCollection.length); else if (!document.body.style.backgroundImage && appState.currentBgType !== 'solid') cycleBackground(bgCollection.indexOf(appState.currentBgUrl)); }
        function cycleBackground(idx = -1) { const b = document.getElementById('btn-bg-change'); const i = document.getElementById('icon-bg-change'); const s = document.getElementById('spinner-bg-change'); if(b) { i.classList.add('opacity-0'); s.classList.remove('hidden'); b.disabled = true; } let n = idx !== -1 ? idx : (bgCollection.indexOf(appState.currentBgUrl) + 1) % bgCollection.length; if(n<0) n=0; const img = new Image(); img.crossOrigin = "Anonymous"; img.src = bgCollection[n]; img.onload = () => { document.body.style.backgroundImage = `url('${bgCollection[n]}')`; appState.currentBgUrl = bgCollection[n]; appState.lastBgUpdate = new Date().toISOString(); appState.currentBgType='image'; saveState(); if(b) { i.classList.remove('opacity-0'); s.classList.add('hidden'); b.disabled = false; } }; img.onerror = () => { if(b) { i.classList.remove('opacity-0'); s.classList.add('hidden'); b.disabled = false; } }; }
        function toggleConfig() { document.getElementById('settings-modal').classList.toggle('hidden'); }
        function resetWidgetPositions() { if(confirm("Recuperar?")) { Object.keys(appState.widgets).forEach(k => { if (defaultState.widgets[k]) { appState.widgets[k].x = defaultState.widgets[k].x; appState.widgets[k].y = defaultState.widgets[k].y; const el = document.getElementById(`widget-${k}`); if(el) { el.style.left = defaultState.widgets[k].x + 'px'; el.style.top = defaultState.widgets[key].y + 'px'; } } }); saveState(); toggleConfig(); } }
        function factoryReset() { if(confirm("RESET?")) { localStorage.removeItem('escriptoriTacState_v1-2_FINAL'); location.reload(); } }
        function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
        function updateClock() { const n = new Date(); const l = appState.lang === 'en' ? 'en-US' : (appState.lang === 'es' ? 'es-ES' : 'ca-ES'); document.getElementById('clock-time').textContent = n.toLocaleTimeString(l, { hour: '2-digit', minute: '2-digit' }); document.getElementById('clock-date').textContent = n.toLocaleDateString(l, { weekday: 'long', day: 'numeric', month: 'long' }); if(n.getSeconds() === 0) checkDailyBackground(); }
        function updateAnalogClock() { const n = new Date(); const s = n.getSeconds(), m = n.getMinutes(), h = n.getHours(); document.getElementById('hand-second').style.transform = `rotate(${((s/60)*360)}deg)`; document.getElementById('hand-minute').style.transform = `rotate(${((m/60)*360)+((s/60)*6)}deg)`; document.getElementById('hand-hour').style.transform = `rotate(${((h/12)*360)+((m/60)*30)}deg)`; }
        function setTrafficLight(c) { appState.widgets.traffic.active = appState.widgets.traffic.active === c ? null : c; updateTrafficLightDOM(appState.widgets.traffic.active); saveState(); }
        function updateTrafficLightDOM(active) { ['green','yellow','red'].forEach(c => { const el = document.getElementById(`light-${c}`); el.className = `w-12 h-12 rounded-full cursor-pointer transition shadow-md ${c==='green'?'bg-green-500':c==='yellow'?'bg-yellow-400':'bg-red-500'} ${active===c ? 'opacity-100 scale-110 ring-4 ring-white/50' : 'opacity-30'}`; }); }
        function toggleTimer() { const ts = appState.widgets.timer; if (ts.isRunning) { clearInterval(timerInterval); ts.isRunning = false; } else { if (ts.timeLeft <= 0) return; ts.isRunning = true; timerInterval = setInterval(() => { ts.timeLeft--; updateTimerDisplay(ts.timeLeft); if (ts.timeLeft <= 0) { clearInterval(timerInterval); ts.isRunning = false; updateTimerControls(); playAlarmSound(); } }, 1000); } updateTimerControls(); saveState(); }
        function resetTimer() { clearInterval(timerInterval); appState.widgets.timer.isRunning = false; appState.widgets.timer.timeLeft = appState.widgets.timer.duration * 60; updateTimerDisplay(appState.widgets.timer.timeLeft); updateTimerControls(); saveState(); }
        function adjustTimer(d) { let n = appState.widgets.timer.duration + d; if (n < 1) n = 1; if (n > 99) n = 99; appState.widgets.timer.duration = n; resetTimer(); }
        function updateTimerControls() { const btn = document.getElementById('timer-btn-toggle'); btn.innerHTML = appState.widgets.timer.isRunning ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>'; btn.className = `w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition text-white ${appState.widgets.timer.isRunning ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-indigo-600 hover:bg-indigo-700'}`; }
        function updateTimerDisplay(s) { document.getElementById('timer-display').textContent = `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
        function playAlarmSound() { const ctx = new (window.AudioContext || window.webkitAudioContext)(); const osc = ctx.createOscillator(); const g = ctx.createGain(); osc.connect(g); g.connect(ctx.destination); osc.frequency.setValueAtTime(880, ctx.currentTime); g.gain.setValueAtTime(0.5, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1); osc.start(); osc.stop(ctx.currentTime + 1); }
        function togglePickerSettings() { document.getElementById('picker-checklist').classList.add('hidden'); document.getElementById('picker-settings').classList.toggle('hidden'); }
        function toggleAttendanceView() { document.getElementById('picker-settings').classList.add('hidden'); const cl = document.getElementById('picker-checklist'); if(cl.classList.contains('hidden')) { renderChecklist(); cl.classList.remove('hidden'); } else cl.classList.add('hidden'); }
        function renderChecklist() { const c = document.getElementById('checklist-container'); c.innerHTML = ''; const names = appState.widgets.picker.names.split('\n').filter(n => n.trim()); const ex = appState.widgets.picker.excluded || []; names.forEach((n, i) => { const isEx = ex.includes(i); const btn = document.createElement('button'); btn.className = `p-2 rounded-lg text-xs font-bold transition ${isEx ? 'bg-slate-200 text-slate-400' : 'bg-emerald-100 text-emerald-800 border border-emerald-300'}`; btn.innerHTML = isEx ? `<i class="fas fa-times mr-1"></i>${n}` : `<i class="fas fa-check mr-1"></i>${n}`; btn.onclick = () => { if (isEx) appState.widgets.picker.excluded = ex.filter(idx => idx !== i); else appState.widgets.picker.excluded.push(i); saveState(); renderChecklist(); }; c.appendChild(btn); }); }
        function selectAllAttendance(a) { if(a) appState.widgets.picker.excluded = []; saveState(); renderChecklist(); }
        document.getElementById('student-list').addEventListener('input', (e) => { appState.widgets.picker.names = e.target.value; appState.widgets.picker.excluded = []; saveState(); });
        function pickRandomStudent() { const all = appState.widgets.picker.names.split('\n').filter(n => n.trim()); const ex = appState.widgets.picker.excluded || []; const avail = all.filter((_, i) => !ex.includes(i)); const disp = document.getElementById('picker-result'); if(!avail.length) { disp.innerText = "Ningú!"; return; } let i = 0; const int = setInterval(() => { disp.innerText = avail[Math.floor(Math.random()*avail.length)]; i++; if(i > 10) { clearInterval(int); disp.innerText = "🎉 " + avail[Math.floor(Math.random()*avail.length)]; } }, 80); }
        function generateGroups() { const names = appState.widgets.picker.names.split('\n').filter(n => n.trim() !== ''); const num = parseInt(document.getElementById('group-count').value); if (names.length === 0) return; for (let i = names.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [names[i], names[j]] = [names[j], names[i]]; } const grps = Array.from({ length: num }, () => []); names.forEach((n, i) => grps[i % num].push(n)); const c = document.getElementById('groups-result'); c.innerHTML = ''; grps.forEach((g, i) => { const d = document.createElement('div'); d.className = "bg-white/50 rounded-lg p-2 shadow-sm border border-white/60 text-slate-800"; d.innerHTML = `<div class="text-xs font-black uppercase text-teal-700 border-b border-teal-200 mb-1 pb-1">Grup ${i+1}</div><ul class="text-sm font-bold">${g.map(n=>`<li>${n}</li>`).join('')}</ul>`; c.appendChild(d); }); }
        async function toggleMicrophone() { const btn = document.getElementById('btn-mic-toggle'); if (microphoneStream) { microphoneStream.getTracks().forEach(t => t.stop()); microphoneStream = null; clearInterval(noiseInterval); document.getElementById('noise-level-bar').style.height = '0%'; btn.innerHTML = `<i class="fas fa-microphone mr-2"></i>Activar`; btn.classList.replace('bg-red-500','bg-indigo-600'); } else { try { microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true }); audioContext = new (window.AudioContext||window.webkitAudioContext)(); const src = audioContext.createMediaStreamSource(microphoneStream); const an = audioContext.createAnalyser(); an.fftSize = 256; src.connect(an); const buf = an.frequencyBinCount; const data = new Uint8Array(buf); btn.innerHTML = `<i class="fas fa-stop mr-2"></i>Aturar`; btn.classList.replace('bg-indigo-600','bg-red-500'); noiseInterval = setInterval(() => { an.getByteFrequencyData(data); let sum = 0; for(let i=0; i<buf; i++) sum += data[i]; const pct = Math.min((sum/buf/150)*100, 100); const bar = document.getElementById('noise-level-bar'); bar.style.height = `${pct}%`; bar.className = `absolute bottom-0 w-full transition-all duration-100 ease-out ${pct>60?'bg-red-500':pct>30?'bg-yellow-400':'bg-green-400'}`; }, 100); } catch (e) { alert("Error micròfon."); } } }
        function addTodo() { const i = document.getElementById('todo-input'); if(i.value.trim()){ appState.widgets.todo.tasks.push({text:i.value, done:false}); i.value=''; renderTodoList(); saveState(); } }
        function toggleTodo(i) { appState.widgets.todo.tasks[i].done = !appState.widgets.todo.tasks[i].done; renderTodoList(); saveState(); }
        function removeTodo(i) { appState.widgets.todo.tasks.splice(i,1); renderTodoList(); saveState(); }
        function renderTodoList() { const l = document.getElementById('todo-list'); l.innerHTML = ''; appState.widgets.todo.tasks.forEach((t, i) => { const d = document.createElement('div'); d.className = "flex items-center gap-2 bg-white/40 p-2 rounded-lg group hover:bg-white/60 transition"; d.innerHTML = `<input type="checkbox" ${t.done?'checked':''} class="w-5 h-5 accent-emerald-500 rounded cursor-pointer" onclick="toggleTodo(${i})"><span class="flex-1 font-bold text-slate-700 text-sm ${t.done?'line-through opacity-50':''}">${t.text}</span><button onclick="removeTodo(${i})" class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 px-2"><i class="fas fa-trash"></i></button>`; l.appendChild(d); }); }
        function generateDailyTimetable() { const slots = ["9:00 - 10:00", "10:00 - 11:00", "11:00 - 11:30 (Pati)", "11:30 - 12:30", "12:30 - 15:00 (Menjador)", "15:00 - 16:30"]; return slots.map(s => { const bg = (s.includes('Pati')||s.includes('Menjador')) ? 'bg-slate-400/40' : 'bg-white/20'; return `<tr class="border-b border-slate-300/50"><td class="font-bold text-slate-600 text-xs p-2 bg-white/40" contenteditable="true">${s}</td><td class="${bg} p-2 hover:bg-white/60 transition" contenteditable="true"></td></tr>`; }).join(''); }
        document.getElementById('timetable-body').addEventListener('input', function() { appState.widgets.timetable.content = this.innerHTML; saveState(); });
        window.onload = loadState;
    </script>
</body>
</html>