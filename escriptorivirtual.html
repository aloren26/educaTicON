<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escriptori Digital Docent</title>
    <!-- Tailwind CSS (Estils) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome (Icones) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Font Satoshi via Fontshare CDN -->
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@500,700,900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Satoshi', sans-serif;
            font-weight: 700;
            background-color: #333;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            transition: background-image 0.5s ease-in-out;
            overflow: hidden;
        }

        input, textarea, button, select {
            font-family: 'Satoshi', sans-serif;
            font-weight: 700;
        }

        /* Base Glassmorphism */
        .glass-base {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .glass-dark {
            background: rgba(30, 41, 59, 0.85);
            backdrop-filter: blur(12px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* WIDGETS */
        .widget {
            position: absolute;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 140px; 
            min-height: 150px;
            resize: both;
            overflow: auto; 
            transition: background-color 0.3s ease; 
        }

        .widget::-webkit-resizer {
            background-color: transparent;
            background-image: linear-gradient(135deg, transparent 50%, rgba(0,0,0,0.2) 50%);
            background-size: 12px 12px;
            background-repeat: no-repeat;
            background-position: bottom right;
        }

        .widget-header {
            cursor: grab;
            user-select: none;
        }
        .widget-header:active {
            cursor: grabbing;
        }

        /* Taula editable */
        .editable-table td, .editable-table th {
            border: 1px solid rgba(0,0,0,0.1);
            padding: 8px;
        }
        .editable-table td:focus {
            background-color: rgba(255, 255, 255, 0.9);
            outline: 2px solid #6366f1;
            border-radius: 4px;
        }

        [contenteditable="true"]:focus {
            outline: none;
            border-bottom: 2px solid #6366f1;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-corner { background: transparent; }

        .hidden-widget { display: none !important; }

        /* Color Picker Dots */
        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.5);
            transition: transform 0.1s;
        }
        .color-dot:hover { transform: scale(1.2); }

        /* ANALOG CLOCK STYLES */
        .clock-face {
            background: rgba(255, 255, 255, 0.95);
            border: 6px solid #334155;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.1), 0 10px 25px rgba(0,0,0,0.2);
        }
        .clock-number {
            position: absolute;
            width: 100%;
            height: 100%;
            text-align: center;
            font-size: 14px;
            font-weight: 900;
            color: #475569;
            padding-top: 4px; 
        }
        .clock-number span {
            display: inline-block;
        }
        .clock-hand {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform-origin: bottom center;
            border-radius: 999px;
            z-index: 10;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col text-slate-800 relative">

    <!-- BOTONS SUPERIORS DRETA -->
    <div class="fixed top-4 right-4 z-50 flex gap-2">
        <!-- Botó Canvi Fons -->
        <button id="btn-bg-change" onclick="cycleBackground()" class="glass-base bg-white/75 p-3 rounded-full hover:bg-white transition relative" title="Canviar Fons (Clic per següent)">
            <i class="fas fa-image" id="icon-bg-change"></i>
            <i class="fas fa-spinner fa-spin absolute inset-0 m-auto hidden text-indigo-600" id="spinner-bg-change" style="line-height: 48px;"></i>
        </button>
        <!-- Botó Pantalla Completa -->
        <button onclick="toggleFullScreen()" class="glass-base bg-white/75 p-3 rounded-full hover:bg-white transition" title="Pantalla Completa">
            <i class="fas fa-expand"></i>
        </button>
        <!-- Botó Configuració -->
        <button onclick="toggleConfig()" class="glass-base bg-white/75 p-3 rounded-full hover:bg-white transition" title="Configuració">
            <i class="fas fa-cog"></i>
        </button>
    </div>

    <!-- ZONA PRINCIPAL -->
    <main id="app-container" class="w-full h-full relative pt-10">
        
        <!-- 1. RELLOTGE DIGITAL -->
        <div id="widget-clock" class="widget glass-base hidden-widget group rounded-3xl" style="top: 150px; left: 50px; width: 300px; height: 200px;">
            <div class="widget-header absolute inset-x-0 top-0 h-10 flex justify-end items-center px-2 opacity-0 group-hover:opacity-100 transition z-20 gap-2">
                <button onclick="toggleColorMenu('clock')" class="text-slate-400 hover:text-indigo-600 bg-white/50 p-1 rounded-full w-8 h-8"><i class="fas fa-palette"></i></button>
                <button onclick="closeWidget('clock')" class="text-slate-400 hover:text-red-500 bg-white/50 p-1 rounded-full w-8 h-8"><i class="fas fa-times"></i></button>
            </div>
            <div id="colors-clock" class="hidden absolute top-10 right-2 bg-white/90 p-2 rounded-xl shadow-xl z-30 grid grid-cols-4 gap-2 border border-slate-200"></div>
            <div class="flex flex-col items-center justify-center h-full w-full pointer-events-none"> 
                <div id="clock-time" class="text-6xl font-black text-slate-800 tracking-tighter select-none">00:00</div>
                <div id="clock-date" class="text-lg text-slate-600 mt-2 uppercase tracking-widest font-bold select-none text-center">Data</div>
            </div>
        </div>

        <!-- 1B. RELLOTGE ANALÒGIC -->
        <div id="widget-analog" class="widget glass-base hidden-widget group rounded-3xl" style="top: 150px; left: 360px; width: 280px; height: 320px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase text-slate-500"><i class="far fa-clock mr-2"></i>Analògic</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('analog')" class="text-slate-400 hover:text-indigo-600"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('analog')" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-analog" class="hidden absolute top-8 right-2 bg-white/90 p-2 rounded-xl shadow-xl z-30 grid grid-cols-4 gap-2 border border-slate-200"></div>
            <div class="flex-grow flex items-center justify-center p-4">
                <div class="clock-face relative w-48 h-48 rounded-full">
                    <!-- NÚMEROS 1-12 -->
                    <div class="clock-number" style="transform: rotate(30deg);"><span style="transform: rotate(-30deg);">1</span></div>
                    <div class="clock-number" style="transform: rotate(60deg);"><span style="transform: rotate(-60deg);">2</span></div>
                    <div class="clock-number" style="transform: rotate(90deg);"><span style="transform: rotate(-90deg);">3</span></div>
                    <div class="clock-number" style="transform: rotate(120deg);"><span style="transform: rotate(-120deg);">4</span></div>
                    <div class="clock-number" style="transform: rotate(150deg);"><span style="transform: rotate(-150deg);">5</span></div>
                    <div class="clock-number" style="transform: rotate(180deg);"><span style="transform: rotate(-180deg);">6</span></div>
                    <div class="clock-number" style="transform: rotate(210deg);"><span style="transform: rotate(-210deg);">7</span></div>
                    <div class="clock-number" style="transform: rotate(240deg);"><span style="transform: rotate(-240deg);">8</span></div>
                    <div class="clock-number" style="transform: rotate(270deg);"><span style="transform: rotate(-270deg);">9</span></div>
                    <div class="clock-number" style="transform: rotate(300deg);"><span style="transform: rotate(-300deg);">10</span></div>
                    <div class="clock-number" style="transform: rotate(330deg);"><span style="transform: rotate(-330deg);">11</span></div>
                    <div class="clock-number" style="transform: rotate(0deg);"><span style="transform: rotate(0deg);">12</span></div>

                    <!-- Agulles -->
                    <div id="hand-hour" class="clock-hand w-2 h-12 bg-slate-800 rounded-full" style="margin-left: -4px;"></div>
                    <div id="hand-minute" class="clock-hand w-1.5 h-16 bg-slate-600 rounded-full" style="margin-left: -3px;"></div>
                    <div id="hand-second" class="clock-hand w-0.5 h-20 bg-red-500 rounded-full" style="margin-left: -1px;"></div>
                    <!-- Centre -->
                    <div class="absolute inset-0 m-auto w-4 h-4 bg-slate-800 rounded-full z-20 border-2 border-white"></div>
                </div>
            </div>
        </div>

        <!-- 2. SEMÀFOR (VERTICAL) -->
        <div id="widget-traffic" class="widget glass-base hidden-widget group rounded-3xl" style="top: 150px; left: 400px; width: 140px; height: 320px;">
            <div class="widget-header w-full p-2 flex justify-between items-center bg-white/20">
                <i class="fas fa-traffic-light text-slate-500 ml-2"></i>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('traffic')" class="text-slate-400 hover:text-indigo-600"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('traffic')" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-traffic" class="hidden absolute top-8 right-2 bg-white/90 p-2 rounded-xl shadow-xl z-30 grid grid-cols-4 gap-2 border border-slate-200"></div>
            <div class="flex-grow flex items-center justify-center p-4">
                <div class="bg-slate-800 p-4 rounded-full flex flex-col gap-4 shadow-inner">
                    <div id="light-red" onclick="setTrafficLight('red')" class="w-12 h-12 rounded-full bg-red-500 opacity-30 cursor-pointer hover:opacity-100 transition shadow-[0_0_20px_rgba(239,68,68,0.5)]"></div>
                    <div id="light-yellow" onclick="setTrafficLight('yellow')" class="w-12 h-12 rounded-full bg-yellow-400 opacity-30 cursor-pointer hover:opacity-100 transition shadow-[0_0_20px_rgba(250,204,21,0.5)]"></div>
                    <div id="light-green" onclick="setTrafficLight('green')" class="w-12 h-12 rounded-full bg-green-500 opacity-30 cursor-pointer hover:opacity-100 transition shadow-[0_0_20px_rgba(34,197,94,0.5)]"></div>
                </div>
            </div>
        </div>

        <!-- 3. NOTES -->
        <div id="widget-notes" class="widget glass-base hidden-widget group rounded-3xl" style="top: 400px; left: 50px; width: 300px; height: 300px;">
            <div class="widget-header px-4 py-2 flex justify-between items-center cursor-move bg-white/20 rounded-t-3xl">
                <span class="text-xs font-black text-slate-600 uppercase"><i class="fas fa-sticky-note mr-2"></i>Notes</span>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('notes')" class="text-slate-500 hover:text-indigo-600"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('notes')" class="text-slate-500 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-notes" class="hidden absolute top-8 right-2 bg-white/90 p-2 rounded-xl shadow-xl z-30 grid grid-cols-4 gap-2 border border-slate-200"></div>
            <textarea id="notes-area" class="w-full h-full bg-transparent p-4 rounded-b-3xl resize-none focus:outline-none text-slate-800 font-bold text-lg" placeholder="Escriu..."></textarea>
        </div>

        <!-- 4. TEMPORITZADOR -->
        <div id="widget-timer" class="widget glass-base hidden-widget group rounded-3xl" style="top: 400px; left: 400px; width: 300px; height: 250px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase text-slate-500 tracking-wider"><i class="fas fa-hourglass-half mr-2"></i>Temporitzador</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('timer')" class="text-slate-400 hover:text-indigo-600"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('timer')" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-timer" class="hidden absolute top-8 right-2 bg-white/90 p-2 rounded-xl shadow-xl z-30 grid grid-cols-4 gap-2 border border-slate-200"></div>
            <div class="flex-grow flex flex-col items-center justify-center p-4">
                <div id="timer-display" class="text-5xl font-mono font-bold text-slate-700 mb-4 tracking-wider">05:00</div>
                <div class="flex gap-3 mb-4">
                    <button onclick="toggleTimer()" id="timer-btn-toggle" class="bg-indigo-600 text-white w-12 h-12 rounded-full flex items-center justify-center hover:bg-indigo-700 shadow-lg transition">
                        <i class="fas fa-play" id="timer-icon-toggle"></i>
                    </button>
                    <button onclick="resetTimer()" class="bg-slate-200 text-slate-600 w-12 h-12 rounded-full flex items-center justify-center hover:bg-slate-300 shadow transition">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                <div class="flex items-center gap-2 text-sm text-slate-500 font-bold">
                    <span>Minuts:</span>
                    <input type="number" id="timer-input" value="5" min="1" max="60" class="w-12 p-1 border rounded text-center bg-white/50 focus:outline-none focus:ring-2 focus:ring-indigo-300 font-bold">
                    <button onclick="setTimerDuration()" class="text-indigo-600 font-black hover:underline uppercase text-xs">Estableix</button>
                </div>
            </div>
        </div>

        <!-- 5. SELECTOR ALUMNES -->
        <div id="widget-picker" class="widget glass-base hidden-widget group rounded-3xl" style="top: 150px; left: 700px; width: 300px; height: 250px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase text-slate-500"><i class="fas fa-dice mr-2"></i>Selector</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('picker')" class="text-slate-400 hover:text-indigo-600"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('picker')" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-picker" class="hidden absolute top-8 right-2 bg-white/90 p-2 rounded-xl shadow-xl z-30 grid grid-cols-4 gap-2 border border-slate-200"></div>
            <div class="flex flex-col p-4 h-full">
                <div id="picker-result" class="flex-grow flex items-center justify-center text-2xl font-bold text-indigo-600 text-center mb-2">Qui serà?</div>
                <div class="flex gap-2 mt-auto">
                    <button onclick="pickRandomStudent()" class="flex-1 bg-indigo-600 text-white py-2 rounded-xl hover:bg-indigo-700 shadow-lg font-bold">Triar</button>
                    <button onclick="togglePickerSettings()" class="bg-slate-200 text-slate-600 px-3 rounded-xl"><i class="fas fa-list"></i></button>
                </div>
                <div id="picker-settings" class="hidden absolute inset-0 bg-white/90 z-20 p-4 flex flex-col">
                    <label class="text-xs text-slate-500 mb-1 font-bold">Llista (un nom per línia):</label>
                    <textarea id="student-list" class="flex-grow bg-slate-50 border rounded p-2 text-sm focus:outline-none font-bold"></textarea>
                    <button onclick="togglePickerSettings()" class="mt-2 bg-slate-200 text-xs py-2 rounded font-bold">Tancar</button>
                </div>
            </div>
        </div>

        <!-- 6. GENERADOR DE GRUPS -->
        <div id="widget-groups" class="widget glass-base hidden-widget group rounded-3xl" style="top: 150px; left: 100px; width: 400px; height: 400px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl">
                <h3 class="text-xs font-black uppercase text-slate-500"><i class="fas fa-users mr-2"></i>Generador de Grups</h3>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('groups')" class="text-slate-400 hover:text-indigo-600"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('groups')" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-groups" class="hidden absolute top-8 right-2 bg-white/90 p-2 rounded-xl shadow-xl z-30 grid grid-cols-4 gap-2 border border-slate-200"></div>
            <div class="flex flex-col p-4 h-full overflow-hidden">
                <div class="flex gap-2 items-center mb-4 bg-white/40 p-2 rounded-lg">
                    <label class="text-xs font-bold text-slate-600">Grups:</label>
                    <input type="number" id="group-count" value="4" min="2" max="10" class="w-12 p-1 text-center rounded border border-slate-300">
                    <button onclick="generateGroups()" class="flex-1 bg-teal-500 text-white py-1 px-3 rounded hover:bg-teal-600 transition font-bold text-sm">Generar Equips</button>
                </div>
                <div id="groups-result" class="flex-grow overflow-y-auto grid grid-cols-2 gap-2 content-start">
                    <div class="col-span-2 text-center text-slate-400 text-sm mt-10">Defineix el nombre de grups i clica "Generar".<br>Usa la llista del Selector d'Alumnes.</div>
                </div>
            </div>
        </div>

        <!-- 7. HORARI DIARI -->
        <div id="widget-timetable" class="widget glass-base hidden-widget group flex flex-col rounded-3xl" style="top: 150px; left: 50%; width: 400px; height: 500px;">
            <div class="widget-header p-3 flex justify-between items-center bg-white/30 rounded-t-3xl cursor-move">
                <div class="flex items-center gap-2">
                    <i class="far fa-calendar-alt text-slate-500"></i>
                    <h3 id="timetable-title" contenteditable="true" class="text-xs font-black uppercase text-slate-500 border-b border-transparent hover:border-slate-300">Horari del Dia</h3>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleColorMenu('timetable')" class="text-slate-400 hover:text-indigo-600"><i class="fas fa-palette"></i></button>
                    <button onclick="closeWidget('timetable')" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="colors-timetable" class="hidden absolute top-8 right-2 bg-white/90 p-2 rounded-xl shadow-xl z-30 grid grid-cols-4 gap-2 border border-slate-200"></div>
            <div class="flex-grow overflow-auto p-4">
                <table class="w-full text-left border-collapse editable-table">
                    <thead>
                        <tr class="text-sm text-slate-500 border-b border-slate-300/50">
                            <th class="p-2 w-32 font-bold">Hora</th>
                            <th class="p-2 font-bold">Activitat</th>
                        </tr>
                    </thead>
                    <tbody id="timetable-body" class="text-slate-700 font-bold text-lg">
                        <!-- Generat via JS -->
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- CRÈDITS FIXOS -->
    <div class="fixed bottom-2 right-4 z-0 text-[10px] text-white/50 font-light pointer-events-none select-none">
        Creat per Alfonso LM
    </div>

    <!-- DOCK INFERIOR (TOOLTIPS AFEGITS) -->
    <div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-40">
        <div class="glass-dark rounded-full px-6 py-3 flex gap-4 shadow-2xl items-center scale-90 md:scale-100 transition-all hover:scale-105">
            
            <button onclick="toggleWidget('timetable')" class="dock-btn text-slate-300 hover:text-white transition group relative flex flex-col items-center">
                <div class="w-10 h-10 bg-indigo-500 rounded-xl flex items-center justify-center shadow-lg"><i class="far fa-calendar-alt text-lg"></i></div>
                <span class="absolute -top-10 left-1/2 -translate-x-1/2 bg-black/80 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap">Horari</span>
            </button>

            <button onclick="toggleWidget('clock')" class="dock-btn text-slate-300 hover:text-white transition group relative flex flex-col items-center">
                <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center shadow-lg"><i class="far fa-clock text-lg"></i></div>
                <span class="absolute -top-10 left-1/2 -translate-x-1/2 bg-black/80 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap">Rellotge Digital</span>
            </button>

            <button onclick="toggleWidget('analog')" class="dock-btn text-slate-300 hover:text-white transition group relative flex flex-col items-center">
                <div class="w-10 h-10 bg-cyan-500 rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-clock text-lg"></i></div>
                <span class="absolute -top-10 left-1/2 -translate-x-1/2 bg-black/80 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap">Rellotge Analògic</span>
            </button>

            <button onclick="toggleWidget('timer')" class="dock-btn text-slate-300 hover:text-white transition group relative flex flex-col items-center">
                <div class="w-10 h-10 bg-orange-500 rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-hourglass-start text-lg"></i></div>
                <span class="absolute -top-10 left-1/2 -translate-x-1/2 bg-black/80 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap">Temporitzador</span>
            </button>

            <div class="w-px h-8 bg-white/20 mx-1"></div>

            <button onclick="toggleWidget('picker')" class="dock-btn text-slate-300 hover:text-white transition group relative flex flex-col items-center">
                <div class="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-dice text-lg"></i></div>
                <span class="absolute -top-10 left-1/2 -translate-x-1/2 bg-black/80 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap">Selector</span>
            </button>

            <button onclick="toggleWidget('groups')" class="dock-btn text-slate-300 hover:text-white transition group relative flex flex-col items-center">
                <div class="w-10 h-10 bg-teal-500 rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-users text-lg"></i></div>
                <span class="absolute -top-10 left-1/2 -translate-x-1/2 bg-black/80 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap">Grups</span>
            </button>

            <button onclick="toggleWidget('traffic')" class="dock-btn text-slate-300 hover:text-white transition group relative flex flex-col items-center">
                <div class="w-10 h-10 bg-rose-500 rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-traffic-light text-lg"></i></div>
                <span class="absolute -top-10 left-1/2 -translate-x-1/2 bg-black/80 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap">Semàfor</span>
            </button>

            <button onclick="toggleWidget('notes')" class="dock-btn text-slate-300 hover:text-white transition group relative flex flex-col items-center">
                <div class="w-10 h-10 bg-yellow-500 rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-sticky-note text-lg"></i></div>
                <span class="absolute -top-10 left-1/2 -translate-x-1/2 bg-black/80 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap">Notes</span>
            </button>

        </div>
    </div>

    <!-- CONFIGURACIÓ -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
            <h2 class="text-2xl font-black mb-4">Configuració</h2>
            <div class="mb-4">
                <label class="block text-sm font-bold text-slate-700 mb-1">Nom del Docent</label>
                <input type="text" id="setting-name" class="w-full border border-slate-300 rounded p-2" placeholder="Escriu el teu nom...">
            </div>
            <div class="flex justify-between items-center pt-4 border-t border-slate-100">
                <button onclick="factoryReset()" class="text-red-500 text-sm font-bold">Reset Total</button>
                <div class="flex gap-2">
                    <button onclick="toggleConfig()" class="px-4 py-2 text-slate-500 font-bold">Tancar</button>
                    <button onclick="toggleConfig()" class="px-4 py-2 bg-blue-600 text-white rounded font-bold">Fet!</button>
                </div>
            </div>
            <p class="text-xs text-slate-400 mt-4 text-center font-bold">El fons canvia automàticament cada dia a les 8:00.</p>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURACIÓ DE COLORS I ESTAT
        // ==========================================
        
        const widgetColors = {
            white:  'bg-white/75',
            gray:   'bg-gray-200/90',
            red:    'bg-red-200/90',
            orange: 'bg-orange-200/90',
            yellow: 'bg-yellow-200/90',
            green:  'bg-green-200/90',
            teal:   'bg-teal-200/90',
            blue:   'bg-blue-200/90',
            indigo: 'bg-indigo-200/90',
            purple: 'bg-purple-200/90',
            pink:   'bg-pink-200/90'
        };

        const defaultState = {
            teacherName: "",
            lastBgUpdate: null,
            currentBgUrl: "https://images.unsplash.com/photo-1472214103451-9374bd1c798e?q=80&w=2070&auto=format&fit=crop",
            widgets: {
                clock: { visible: true, x: 50, y: 150, w: 300, h: 200, color: 'white' },
                analog: { visible: false, x: 360, y: 150, w: 280, h: 320, color: 'white' }, 
                timetable: { visible: false, content: "", title: "Horari del Dia", x: 400, y: 150, w: 450, h: 500, color: 'white' },
                picker: { visible: false, names: "Alumne 1\nAlumne 2\nAlumne 3\nAlumne 4", x: 850, y: 150, w: 300, h: 250, color: 'white' },
                notes: { visible: false, text: "", x: 50, y: 400, w: 300, h: 300, color: 'yellow' },
                traffic: { visible: false, active: null, x: 400, y: 600, w: 140, h: 320, color: 'white' }, 
                timer: { visible: false, duration: 5, timeLeft: 300, isRunning: false, x: 500, y: 400, w: 300, h: 250, color: 'white' },
                groups: { visible: false, count: 4, x: 100, y: 150, w: 400, h: 400, color: 'white' }
            }
        };

        let appState = {};
        let timerInterval = null;

        // MEGABANC DE 73 IMATGES (NETEJAT)
        const bgCollection = [
            "https://images.unsplash.com/photo-1472214103451-9374bd1c798e?q=80&w=2070", "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2070", 
            "https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=2070", 
            "https://images.unsplash.com/photo-1447752875215-b2761acb3c5d?q=80&w=2070", 
            "https://images.unsplash.com/photo-1500382017468-9049fed747ef?q=80&w=2070", "https://images.unsplash.com/photo-1469474968028-56623f02e42e?q=80&w=2070", 
            "https://images.unsplash.com/photo-1505144808419-1957a94ca61e?q=80&w=2070", "https://images.unsplash.com/photo-1532274402911-5a369e4c4bb5?q=80&w=2070", 
            "https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?q=80&w=2070", "https://images.unsplash.com/photo-1426604966848-d7adac402bff?q=80&w=2070", 
            "https://images.unsplash.com/photo-1493246507139-91e8fad9978e?q=80&w=2070", "https://images.unsplash.com/photo-1511497584788-876760111969?q=80&w=2070", 
            "https://images.unsplash.com/photo-1454496522488-7a8e488e8606?q=80&w=2070", "https://images.unsplash.com/photo-1433086966358-54859d0ed716?q=80&w=2070", 
            "https://images.unsplash.com/photo-1502082553048-f009c37129b9?q=80&w=2070", "https://images.unsplash.com/photo-1465146344425-f00d5f5c8f07?q=80&w=2070", 
            "https://images.unsplash.com/photo-1470252649378-9c29740c9fa8?q=80&w=2070", "https://images.unsplash.com/photo-1439853949127-fa647821eba0?q=80&w=2070", 
            "https://images.unsplash.com/photo-1482938289607-e9573fc25ebb?q=80&w=2070", "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=2070", 
            "https://images.unsplash.com/photo-1476610182048-b716b8518aae?q=80&w=2070", "https://images.unsplash.com/photo-1499002238440-d264edd596ec?q=80&w=2070", 
            "https://images.unsplash.com/photo-1433838552652-f9a46b332c40?q=80&w=2070", "https://images.unsplash.com/photo-1458668383970-8ddd3927deed?q=80&w=2070", 
            "https://images.unsplash.com/photo-1518173946687-a4c8892bbd9f?q=80&w=2070", "https://images.unsplash.com/photo-1486312338219-ce68d2c6f44d?q=80&w=2070", 
            "https://images.unsplash.com/photo-1497366216548-37526070297c?q=80&w=2070", "https://images.unsplash.com/photo-1506784983877-45594efa4cbe?q=80&w=2070", 
            "https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2070", "https://images.unsplash.com/photo-1534224039826-c7a0eda0e6b3?q=80&w=2070", 
            "https://images.unsplash.com/photo-1508615039623-a25605d2b022?q=80&w=2070", "https://images.unsplash.com/photo-1483729558449-99ef09a8c325?q=80&w=2070", 
            "https://images.unsplash.com/photo-1475924156734-496f6cac6ec1?q=80&w=2070", "https://images.unsplash.com/photo-1500964757637-c85e8a162699?q=80&w=2070", 
            "https://images.unsplash.com/photo-1496715976403-7e36dc43f17b?q=80&w=2070", "https://images.unsplash.com/photo-1493514789931-5f7514744eb6?q=80&w=2070", 
            "https://images.unsplash.com/photo-1504805572947-34fad45aed93?q=80&w=2070", "https://images.unsplash.com/photo-1524169358666-79f22534bc6e?q=80&w=2070", 
            "https://images.unsplash.com/photo-1526721940322-10fb6e3ae94a?q=80&w=2070", "https://images.unsplash.com/photo-1501630834273-4b5604d2ee31?q=80&w=2070", 
            "https://images.unsplash.com/photo-1528722828814-77b9b83aafb2?q=80&w=2070", "https://images.unsplash.com/photo-1531315630201-bb15abeb1653?q=80&w=2070", 
            "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=2070", "https://images.unsplash.com/photo-1503264116251-35a269479413?q=80&w=2070", 
            "https://images.unsplash.com/photo-1516550893923-42d28e5677af?q=80&w=2070", "https://images.unsplash.com/photo-1518655048521-f130df041f66?q=80&w=2070", 
            "https://images.unsplash.com/photo-1513542789411-b6a5d4f31634?q=80&w=2070", "https://images.unsplash.com/photo-1481627834876-b7833e8f5570?q=80&w=2070", 
            "https://images.unsplash.com/photo-1491895200222-0fc4a4c35e18?q=80&w=2070", "https://images.unsplash.com/photo-1434030216411-0b793f4b4173?q=80&w=2070", 
            "https://images.unsplash.com/photo-1497215842964-222b430dc0a8?q=80&w=2070", "https://images.unsplash.com/photo-1465433056549-e92ed3115663?q=80&w=2070", 
            "https://images.unsplash.com/photo-1475070901697-1e54ac5e9850?q=80&w=2070", "https://images.unsplash.com/photo-1485470764509-0e040261394a?q=80&w=2070", 
            "https://images.unsplash.com/photo-1502481851512-e9e2529bfbf9?q=80&w=2070", "https://images.unsplash.com/photo-1431794062232-2a99a5431c6c?q=80&w=2070", 
            "https://images.unsplash.com/photo-1505664194779-8beaceb93744?q=80&w=2070", "https://images.unsplash.com/photo-1507608616759-54f48f0af0ee?q=80&w=2070", 
            "https://images.unsplash.com/photo-1511300636408-a63a89df3482?q=80&w=2070", "https://images.unsplash.com/photo-1494548162494-384bba4ab999?q=80&w=2070", 
            "https://images.unsplash.com/photo-1533577116850-9cc66cad8a9b?q=80&w=2070", "https://images.unsplash.com/photo-1495195129352-aeb325a55b65?q=80&w=2070", 
            "https://images.unsplash.com/photo-1460925895917-afdab827c52f?q=80&w=2070", "https://images.unsplash.com/photo-1504253163759-c23fccaebb55?q=80&w=2070", 
            "https://images.unsplash.com/photo-1515595967223-f9fa59af5a3b?q=80&w=2070", "https://images.unsplash.com/photo-1499750310159-5b5f0d693169?q=80&w=2070", 
            "https://images.unsplash.com/photo-1520038410233-7141dd7e6f97?q=80&w=2070", "https://images.unsplash.com/photo-1519751138087-5bf79df62d5b?q=80&w=2070", 
            "https://images.unsplash.com/photo-1504198266287-1659872e6590?q=80&w=2070", "https://images.unsplash.com/photo-1490730141103-6cac27aaab94?q=80&w=2070", 
            "https://images.unsplash.com/photo-1496309732348-3627f3f040ee?q=80&w=2070", "https://images.unsplash.com/photo-1462331940025-496dfbfc7564?q=80&w=2070", 
            "https://images.unsplash.com/photo-1440688807730-73e4e2169fb8?q=80&w=2070" 
        ];

        function loadState() {
            // Utilitzem v12 per assegurar que tothom comença net amb la nova lògica
            // Però si algú ja té v12, recupera les dades.
            const saved = localStorage.getItem('escriptoriTacStatev12'); 
            if (saved) {
                const parsed = JSON.parse(saved);
                appState = { ...defaultState, ...parsed, widgets: { ...defaultState.widgets, ...parsed.widgets } };
                // Assegurar integritat de dades antigues vs noves
                Object.keys(defaultState.widgets).forEach(k => {
                    if(!appState.widgets[k]) appState.widgets[k] = defaultState.widgets[k];
                    if(!appState.widgets[k].color) appState.widgets[k].color = defaultState.widgets[k].color;
                });
            } else {
                // Si no hi ha v12, mirem si hi ha v11 per migrar dades (opcional però amable)
                const oldSaved = localStorage.getItem('escriptoriTacStatev11');
                if(oldSaved) {
                    const parsedOld = JSON.parse(oldSaved);
                    appState = { ...defaultState, ...parsedOld, widgets: { ...defaultState.widgets, ...parsedOld.widgets } };
                } else {
                    appState = JSON.parse(JSON.stringify(defaultState));
                    appState.widgets.timetable.content = generateDailyTimetable();
                }
            }

            // Iniciar rellotge analògic
            setInterval(updateAnalogClock, 1000);
            updateAnalogClock();

            checkDailyBackground();
            initWidgets();
        }

        function saveState() {
            localStorage.setItem('escriptoriTacStatev12', JSON.stringify(appState));
        }

        function checkDailyBackground() {
            const now = new Date();
            const today8am = new Date();
            today8am.setHours(8, 0, 0, 0);
            const lastUpdate = appState.lastBgUpdate ? new Date(appState.lastBgUpdate) : new Date(0);

            if (now >= today8am && lastUpdate < today8am) {
                // Rotació diària automàtica
                const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
                const index = dayOfYear % bgCollection.length;
                loadAndSetBackground(bgCollection[index], true);
            } else if (!document.body.style.backgroundImage) {
                // Si no hi ha fons carregat, posar l'actual
                loadAndSetBackground(appState.currentBgUrl, false);
            } else {
                // Restaurar
                document.body.style.backgroundImage = `url('${appState.currentBgUrl}')`;
            }
        }

        // --- CANVI MANUAL AMB PRELOADER I FALLBACK ---
        function cycleBackground() {
            const btn = document.getElementById('btn-bg-change');
            const icon = document.getElementById('icon-bg-change');
            const spinner = document.getElementById('spinner-bg-change');

            // UI Loading state
            icon.classList.add('opacity-0');
            spinner.classList.remove('hidden');
            btn.disabled = true;

            let currentIdx = bgCollection.indexOf(appState.currentBgUrl);
            if(currentIdx === -1) currentIdx = 0;
            const nextIdx = (currentIdx + 1) % bgCollection.length;
            const nextUrl = bgCollection[nextIdx];
            
            loadAndSetBackground(nextUrl, true, (success) => {
                if(success) {
                    icon.classList.remove('opacity-0');
                    spinner.classList.add('hidden');
                    btn.disabled = false;
                } else {
                    console.log("Imatge fallida, provant la següent...");
                    appState.currentBgUrl = nextUrl; 
                    cycleBackground(); 
                }
            });
        }

        function loadAndSetBackground(url, updateState, callback) {
            const img = new Image();
            img.crossOrigin = "Anonymous"; 
            img.src = url;
            
            img.onload = () => {
                document.body.style.backgroundImage = `url('${url}')`;
                if(updateState) {
                    appState.currentBgUrl = url;
                    appState.lastBgUpdate = new Date().toISOString();
                    saveState();
                }
                if(callback) callback(true);
            };
            
            img.onerror = () => {
                if(callback) callback(false); 
            };
        }

        // ==========================================
        // GESTIÓ DE COLORS
        // ==========================================
        
        function applyWidgetColor(id) {
            const el = document.getElementById(`widget-${id}`);
            const colorName = appState.widgets[id].color || 'white';
            const bgClass = widgetColors[colorName];
            Object.values(widgetColors).forEach(c => el.classList.remove(...c.split(' ')));
            el.classList.add(...bgClass.split(' '));
        }

        function toggleColorMenu(id) {
            const menu = document.getElementById(`colors-${id}`);
            if (menu.children.length === 0) {
                Object.keys(widgetColors).forEach(color => {
                    const dot = document.createElement('div');
                    dot.className = `color-dot ${widgetColors[color].replace('/75', '').replace('/90', '')} shadow-sm`;
                    dot.onclick = (e) => {
                        e.stopPropagation();
                        appState.widgets[id].color = color;
                        applyWidgetColor(id);
                        saveState();
                        menu.classList.add('hidden');
                    };
                    menu.appendChild(dot);
                });
            }
            menu.classList.toggle('hidden');
        }

        // ==========================================
        // INICIALITZACIÓ WIDGETS
        // ==========================================
        function initWidgets() {
            document.getElementById('setting-name').value = appState.teacherName;

            // Auto-guardar nom docent mentre escriu
            document.getElementById('setting-name').addEventListener('input', (e) => {
                appState.teacherName = e.target.value;
                saveState();
            });

            Object.keys(appState.widgets).forEach(id => {
                const wState = appState.widgets[id];
                const el = document.getElementById(`widget-${id}`);
                
                if (el) {
                    el.style.left = wState.x + 'px';
                    el.style.top = wState.y + 'px';
                    el.style.width = wState.w + 'px';
                    el.style.height = wState.h + 'px';
                    
                    if(wState.visible) el.classList.remove('hidden-widget');
                    else el.classList.add('hidden-widget');

                    applyWidgetColor(id);
                    makeInteractable(el, id);
                }
            });

            document.getElementById('notes-area').value = appState.widgets.notes.text;
            document.getElementById('student-list').value = appState.widgets.picker.names;
            
            const titleEl = document.getElementById('timetable-title');
            titleEl.textContent = appState.widgets.timetable.title || "Horari del Dia";
            titleEl.addEventListener('input', () => {
                appState.widgets.timetable.title = titleEl.textContent;
                saveState();
            });

            const tbody = document.getElementById('timetable-body');
            tbody.innerHTML = appState.widgets.timetable.content || generateDailyTimetable();

            updateTrafficLightDOM(appState.widgets.traffic.active);
            
            document.getElementById('timer-input').value = appState.widgets.timer.duration;
            updateTimerDisplay(appState.widgets.timer.timeLeft);
            appState.widgets.timer.isRunning = false; 
            updateTimerControls();
        }

        // ==========================================
        // INTERACTIVITAT (DRAG & RESIZE)
        // ==========================================
        function makeInteractable(element, widgetId) {
            const header = element.querySelector('.widget-header');
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            if (header) {
                header.addEventListener('mousedown', (e) => {
                    if(e.target.closest('button') || e.target.closest('input') || e.target.closest('.color-dot') || e.target.isContentEditable) return;
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    initialLeft = element.offsetLeft;
                    initialTop = element.offsetTop;
                    bringToFront(element);
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            }

            function onMouseMove(e) {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                element.style.left = `${initialLeft + dx}px`;
                element.style.top = `${initialTop + dy}px`;
            }

            function onMouseUp() {
                isDragging = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                appState.widgets[widgetId].x = element.offsetLeft;
                appState.widgets[widgetId].y = element.offsetTop;
                saveState();
            }

            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    if (!element.classList.contains('hidden-widget')) {
                        appState.widgets[widgetId].w = element.offsetWidth;
                        appState.widgets[widgetId].h = element.offsetHeight;
                        saveState();
                    }
                }
            });
            resizeObserver.observe(element);
            element.addEventListener('mousedown', () => bringToFront(element));
        }

        function bringToFront(el) {
            document.querySelectorAll('.widget').forEach(w => w.style.zIndex = 10);
            el.style.zIndex = 20;
            const menu = el.querySelector('[id^="colors-"]');
            if(menu) menu.style.zIndex = 30;
        }

        // ==========================================
        // CONTROLADORS WIDGETS
        // ==========================================
        
        function toggleWidget(id) {
            const el = document.getElementById(`widget-${id}`);
            const isHidden = el.classList.contains('hidden-widget');
            
            if (isHidden) {
                const viewportW = window.innerWidth;
                const viewportH = window.innerHeight;
                const widgetW = appState.widgets[id].w;
                const widgetH = appState.widgets[id].h;
                const centerX = (viewportW / 2) - (widgetW / 2);
                const centerY = (viewportH / 2) - (widgetH / 2);
                
                appState.widgets[id].x = centerX;
                appState.widgets[id].y = centerY;
                el.style.left = centerX + 'px';
                el.style.top = centerY + 'px';

                el.classList.remove('hidden-widget');
                appState.widgets[id].visible = true;
                bringToFront(el);
            } else {
                el.classList.add('hidden-widget');
                appState.widgets[id].visible = false;
            }
            saveState();
        }

        function closeWidget(id) {
            document.getElementById(`widget-${id}`).classList.add('hidden-widget');
            appState.widgets[id].visible = false;
            document.getElementById(`colors-${id}`).classList.add('hidden');
            saveState();
        }

        // --- RELLOTGES ---
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ca-ES', { hour: '2-digit', minute: '2-digit' });
            const dateStr = now.toLocaleDateString('ca-ES', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('clock-time').textContent = timeStr;
            document.getElementById('clock-date').textContent = dateStr;
            if(now.getSeconds() === 0) checkDailyBackground();
        }
        setInterval(updateClock, 1000);
        updateClock();

        function updateAnalogClock() {
            const now = new Date();
            const sec = now.getSeconds();
            const min = now.getMinutes();
            const hour = now.getHours();
            
            const secDeg = ((sec / 60) * 360);
            const minDeg = ((min / 60) * 360) + ((sec/60)*6);
            const hourDeg = ((hour / 12) * 360) + ((min/60)*30);

            document.getElementById('hand-second').style.transform = `rotate(${secDeg}deg)`;
            document.getElementById('hand-minute').style.transform = `rotate(${minDeg}deg)`;
            document.getElementById('hand-hour').style.transform = `rotate(${hourDeg}deg)`;
        }

        // --- NOTES ---
        document.getElementById('notes-area').addEventListener('input', (e) => {
            appState.widgets.notes.text = e.target.value;
            saveState();
        });

        // --- SEMÀFOR ---
        function setTrafficLight(color) {
            if (appState.widgets.traffic.active === color) appState.widgets.traffic.active = null;
            else appState.widgets.traffic.active = color;
            updateTrafficLightDOM(appState.widgets.traffic.active);
            saveState();
        }
        function updateTrafficLightDOM(active) {
            ['green', 'yellow', 'red'].forEach(c => {
                const el = document.getElementById(`light-${c}`);
                el.className = `w-12 h-12 rounded-full cursor-pointer transition shadow-[0_0_20px_rgba(0,0,0,0.1)] ${c==='green'?'bg-green-500':c==='yellow'?'bg-yellow-400':'bg-red-500'} ${active===c ? 'opacity-100 scale-110' : 'opacity-30'}`;
                if(active === c) {
                    const rgb = c === 'green' ? '34,197,94' : c === 'yellow' ? '250,204,21' : '239,68,68';
                    el.style.boxShadow = `0 0 30px rgba(${rgb}, 0.8)`;
                }
            });
        }

        // --- TEMPORITZADOR ---
        function updateTimerDisplay(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').textContent = `${m}:${s}`;
        }

        function toggleTimer() {
            const timerState = appState.widgets.timer;
            if (timerState.isRunning) {
                clearInterval(timerInterval);
                timerState.isRunning = false;
            } else {
                if (timerState.timeLeft <= 0) return;
                timerState.isRunning = true;
                timerInterval = setInterval(() => {
                    timerState.timeLeft--;
                    updateTimerDisplay(timerState.timeLeft);
                    if (timerState.timeLeft <= 0) {
                        clearInterval(timerInterval);
                        timerState.isRunning = false;
                        updateTimerControls();
                        const display = document.getElementById('timer-display');
                        display.classList.add('text-red-500', 'scale-110');
                        setTimeout(() => display.classList.remove('text-red-500', 'scale-110'), 2000);
                        saveState();
                    }
                }, 1000);
            }
            updateTimerControls();
            saveState();
        }

        function resetTimer() {
            clearInterval(timerInterval);
            const timerState = appState.widgets.timer;
            timerState.isRunning = false;
            timerState.timeLeft = timerState.duration * 60;
            updateTimerDisplay(timerState.timeLeft);
            updateTimerControls();
            saveState();
        }

        function setTimerDuration() {
            const input = document.getElementById('timer-input');
            const mins = parseInt(input.value);
            if (mins > 0) {
                appState.widgets.timer.duration = mins;
                resetTimer();
            }
        }

        function updateTimerControls() {
            const btn = document.getElementById('timer-btn-toggle');
            const icon = document.getElementById('timer-icon-toggle');
            if (appState.widgets.timer.isRunning) {
                btn.classList.replace('bg-indigo-600', 'bg-yellow-500');
                btn.classList.replace('hover:bg-indigo-700', 'hover:bg-yellow-600');
                icon.className = 'fas fa-pause';
            } else {
                btn.classList.replace('bg-yellow-500', 'bg-indigo-600');
                btn.classList.replace('hover:bg-yellow-600', 'hover:bg-indigo-700');
                icon.className = 'fas fa-play';
            }
        }

        // --- HORARI DIARI ---
        function generateDailyTimetable() {
            const slots = [
                "9:00 - 10:00", "10:00 - 11:00", "11:00 - 11:30 (Pati)", 
                "11:30 - 12:30", "12:30 - 15:00 (Menjador)", "15:00 - 16:30"
            ];
            let html = "";
            slots.forEach(slot => {
                const isBreak = slot.includes('Pati') || slot.includes('Menjador');
                const bg = isBreak ? 'bg-slate-400/40' : 'bg-white/20';
                html += `<tr class="border-b border-slate-300/50">
                    <td class="font-bold text-slate-600 text-xs p-2 bg-white/40" contenteditable="true">${slot}</td>
                    <td class="${bg} p-2 hover:bg-white/60 transition" contenteditable="true"></td>
                </tr>`;
            });
            return html;
        }
        document.getElementById('timetable-body').addEventListener('input', function() {
            appState.widgets.timetable.content = this.innerHTML;
            saveState();
        });

        // --- SELECTOR ---
        function togglePickerSettings() {
            document.getElementById('picker-settings').classList.toggle('hidden');
        }
        document.getElementById('student-list').addEventListener('input', (e) => {
            appState.widgets.picker.names = e.target.value;
            saveState();
        });
        function pickRandomStudent() {
            const names = appState.widgets.picker.names.split('\n').filter(n => n.trim());
            if(!names.length) return;
            const display = document.getElementById('picker-result');
            let i = 0;
            const interval = setInterval(() => {
                display.innerText = names[Math.floor(Math.random()*names.length)];
                i++;
                if(i > 10) {
                    clearInterval(interval);
                    display.innerText = "🎉 " + names[Math.floor(Math.random()*names.length)];
                }
            }, 80);
        }

        // --- GENERADOR DE GRUPS ---
        function generateGroups() {
            const namesText = appState.widgets.picker.names;
            const names = namesText.split('\n').filter(n => n.trim() !== '');
            const numGroups = parseInt(document.getElementById('group-count').value);
            
            if (names.length === 0) {
                alert("Primer afegeix noms al Selector d'Alumnes!");
                return;
            }

            for (let i = names.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [names[i], names[j]] = [names[j], names[i]];
            }

            const groups = Array.from({ length: numGroups }, () => []);
            names.forEach((name, index) => {
                groups[index % numGroups].push(name);
            });

            const container = document.getElementById('groups-result');
            container.innerHTML = '';
            
            groups.forEach((group, i) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = "bg-white/50 rounded-lg p-2 shadow-sm border border-white/60";
                
                const title = document.createElement('div');
                title.className = "text-xs font-black uppercase text-teal-700 border-b border-teal-200 mb-1 pb-1";
                title.textContent = `Grup ${i + 1}`;
                
                const list = document.createElement('ul');
                list.className = "text-sm text-slate-700 font-bold";
                group.forEach(n => {
                    const li = document.createElement('li');
                    li.textContent = n;
                    list.appendChild(li);
                });
                groupDiv.appendChild(title);
                groupDiv.appendChild(list);
                container.appendChild(groupDiv);
            });
        }

        // --- GLOBAL ---
        function toggleConfig() {
            document.getElementById('settings-modal').classList.toggle('hidden');
        }
        function saveGlobalSettings() {
            // Ja es guarda automàticament a l'input, però forcem guardat final
            appState.teacherName = document.getElementById('setting-name').value;
            saveState();
            toggleConfig();
        }
        function factoryReset() {
            if(confirm("Segur? Es perdrà tot.")) {
                localStorage.removeItem('escriptoriTacStatev12');
                location.reload();
            }
        }
        
        // --- FULLSCREEN ROBUST ---
        function toggleFullScreen() {
            const elem = document.documentElement;
            if (!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen().catch(err => console.log("Error Fullscreen:", err));
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
            }
        }

        window.onload = loadState;
    </script>
</body>
</html>